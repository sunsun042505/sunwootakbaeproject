<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>키오스크</title><link rel="stylesheet" href="./style.css"></head>
<body><div class="wrap">
<div class="topbar">
  <div><div class="title">키오스크</div><div class="sub">build 2025-12-31 14:20:46 KST · 점포코드로 로그인 후 발급</div></div>
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
    <span class="pill" id="clock">--:--:--</span>
    <button class="btn" onclick="location.href='./index.html'">메인</button>
  </div>
</div>

<div class="card" id="gate">
  <b>점포 로그인</b>
  <div class="row" style="margin-top:10px;">
    <div><input id="g_name" placeholder="점포명"></div>
    <div><input id="g_code" placeholder="점포코드"></div>
  </div>
  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <button class="btn primary" id="login">로그인</button>
    <span class="sub" id="gmsg"></span>
  </div>
</div>

<div class="card" id="app" style="display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
    <div><b id="store">-</b><div class="sub">예약접수 / 현장접수</div></div>
    <button class="btn" id="logout">로그아웃</button>
  </div>
  <div class="hr"></div>

  <div class="row">
    <button class="btn" id="showRes">예약접수</button>
    <button class="btn" id="showWalk">현장접수</button>
  </div>

  <div class="card" id="resBox" style="display:none;">
    <b>예약번호로 발급</b>
    <div class="row" style="margin-top:10px;">
      <div><input id="resNo" class="mono" placeholder="12자리 예약번호"></div>
      <div><button class="btn primary" id="issueRes" style="width:100%;">발급</button></div>
    </div>
    <div class="sub" id="resMsg"></div>
  </div>

  <div class="card" id="walkBox" style="display:none;">
    <b>현장접수</b>
    <div class="row" style="margin-top:10px;">
      <div>
        <label class="sub">서비스</label>
        <select id="w_type"><option value="DOMESTIC">국내</option><option value="INTERNATIONAL">국제</option><option value="ECONOMY_CVS">반값</option><option value="RETURN">반품</option></select>
      </div>
      <div><label class="sub">무게(kg)</label><input id="w_w" type="number" step="0.1" min="0.1"></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><input id="w_sname" placeholder="보내는분 이름"></div>
      <div><input id="w_sphone" placeholder="보내는분 전화"></div>
    </div>
    <div style="margin-top:10px;"><input id="w_saddr" placeholder="보내는분 주소"></div>

    <div class="row" style="margin-top:10px;">
      <div><input id="w_rname" placeholder="받는분 이름"></div>
      <div><input id="w_rphone" placeholder="받는분 전화"></div>
    </div>
    <div style="margin-top:10px;"><input id="w_raddr" placeholder="받는분/도착점포 주소"></div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <button class="btn primary" id="issueWalk">발급</button>
      <span class="sub" id="walkMsg"></span>
    </div>
  </div>

  <div class="card" id="done" style="display:none;">
    <b>발급 완료</b>
    <div class="sub">운송장번호: <span class="mono" id="wb">-</span></div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn primary" id="print">라벨</button>
      <button class="btn" id="track">배송조회</button>
    </div>
  </div>
</div>

<script type="module">
import * as c from "./client.js";
const $=id=>document.getElementById(id);
c.startClock($("clock"));

let store=null;
let lastWb=null;
function show(which){
  $("resBox").style.display = which==="res" ? "" : "none";
  $("walkBox").style.display = which==="walk" ? "" : "none";
  $("done").style.display = "none";
}

$("showRes").onclick=()=>show("res");
$("showWalk").onclick=()=>show("walk");

$("logout").onclick=()=>{
  store=null; lastWb=null;
  $("app").style.display="none";
  $("gate").style.display="";
  $("gmsg").textContent="";
};

$("login").onclick=async()=>{
  $("gmsg").textContent="";
  try{
    const r=await c.apiPost("/api/stores/login",{name:$("g_name").value.trim(), code:$("g_code").value.trim()});
    store=r.store;
    $("store").textContent=store.name;
    $("gate").style.display="none";
    $("app").style.display="";
    show("res");
  }catch(e){
    $("gmsg").innerHTML="<span class='err'>없는 점포</span>";
  }
};

function done(wb){
  lastWb=wb;
  $("wb").textContent=wb;
  $("done").style.display="";
}

$("issueRes").onclick=async()=>{
  $("resMsg").textContent="";
  try{
    const rn=c.digitsOnly($("resNo").value);
    if(rn.length!==12) throw new Error("예약번호 12자리");
    const rec=await c.apiGet("/api/reservations/byReserve/"+encodeURIComponent(rn));
    if(rec.waybillNo){ done(rec.waybillNo); $("resMsg").innerHTML="<span class='ok'>이미 발급됨</span>"; return; }
    const wb=c.make18(c.prefixByType(rec.type));
    rec.waybillNo=wb;
    rec.status="WAYBILL_ISSUED";
    rec.storeName=store.name;
    rec.events = rec.events || [];
    rec.events.push({time:new Date().toISOString(), place:store.name, message:"점포접수 하였습니다"});
    await c.apiPost("/api/reservations/upsert", rec);
    $("resMsg").innerHTML="<span class='ok'>발급됨</span>";
    done(wb);
  }catch(e){
    $("resMsg").innerHTML="<span class='err'>실패:</span> "+e.message;
  }
};

$("issueWalk").onclick=async()=>{
  $("walkMsg").textContent="";
  try{
    const type=$("w_type").value;
    const sender={name:$("w_sname").value.trim(),phone:$("w_sphone").value.trim(),address:$("w_saddr").value.trim()};
    const receiver={name:$("w_rname").value.trim(),phone:$("w_rphone").value.trim(),address:$("w_raddr").value.trim()};
    const weightKg=Number($("w_w").value);
    if(!sender.name||!sender.phone||!sender.address) throw new Error("보내는분 필수");
    if(!receiver.name||!receiver.phone||!receiver.address) throw new Error("받는분/점포 주소 필수");
    if(!weightKg||weightKg<=0) throw new Error("무게 입력");
    const wb=c.make18(c.prefixByType(type));
    const rec={
      reserveNo: "WALKIN_"+wb,
      waybillNo: wb,
      type,
      status:"WAYBILL_ISSUED",
      sender, receiver,
      package:{weightKg},
      storeName: store.name,
      courier:null,
      events:[{time:new Date().toISOString(), place:store.name, message:"점포접수 하였습니다"}]
    };
    await c.apiPost("/api/reservations/upsert", rec);
    $("walkMsg").innerHTML="<span class='ok'>발급됨</span>";
    done(wb);
  }catch(e){
    $("walkMsg").innerHTML="<span class='err'>실패:</span> "+e.message;
  }
};

$("print").onclick=()=>{ if(!lastWb) return; location.href="./label.html?invoice_no="+encodeURIComponent(lastWb); };
$("track").onclick=()=>{ if(!lastWb) return; location.href="./tracking.html?invoice_no="+encodeURIComponent(lastWb); };
</script>
</body></html>

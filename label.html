<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>운송장 라벨</title>
  <style>
    :root{
      --bg:#0b0f14; --text:#e8eef6; --muted:#9aa7b5;
      --border:rgba(255,255,255,.10); --accent:#2eff90;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:920px; margin:0 auto; padding:18px; }
    .top{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .btn{
      background:transparent; border:1px solid var(--border); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800;
    }
    .btn.primary{ border-color:rgba(46,255,144,.35); }
    .btn:active{ transform:translateY(1px); }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .hint{ color:var(--muted); font-size:12px; line-height:1.45; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }

    /* Label area (100x150mm) */
    .labelStage{ margin-top:14px; display:flex; justify-content:center; }
    .label{
      width: 100mm;
      height: 150mm;
      background:#fff;
      color:#000;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .labelInner{ padding:10mm; box-sizing:border-box; height:100%; display:flex; flex-direction:column; gap:6mm; }
    .row{ display:flex; justify-content:space-between; gap:6mm; align-items:flex-start; }
    .big{ font-size:18pt; font-weight:900; }
    .small{ font-size:10pt; }
    .tag{ padding:2mm 3mm; border:1px solid #000; border-radius:4mm; font-weight:900; font-size:10pt; }
    .line{ height:0; border-top:1px solid #000; opacity:.55; }
    .addr{ font-size:10.5pt; line-height:1.35; white-space:pre-wrap; }
    .barcodeBox{ display:flex; flex-direction:column; align-items:center; gap:2mm; margin-top:auto; }
    svg{ width: 100%; height:auto; }

    @media print{
      body{ background:#fff; }
      .wrap{ max-width:none; padding:0; }
      .noPrint{ display:none !important; }
      .labelStage{ margin:0; }
      .label{ box-shadow:none; border-radius:0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top noPrint">
      <div class="card" style="flex:1; min-width:280px;">
        <div style="font-weight:900;">운송장 라벨 출력</div>
        <div class="hint">• 이 페이지는 <span class="mono">label.html?waybill=운송장번호</span> 로 열 수 있어.<br/>• “공유(앱)” 버튼으로 프린터 앱을 선택해서 출력하는 방식이 제일 안정적이야.</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="btnReload">새로고침</button>
        <button class="btn primary" id="btnShare">공유(앱)</button>
        <button class="btn" id="btnDownload">PNG 저장</button>
        <button class="btn" id="btnPrint">인쇄</button>
      </div>
    </div>

    <div class="labelStage">
      <div id="label" class="label">
        <div class="labelInner">
          <div class="row">
            <div>
              <div class="small" style="opacity:.7;">SUNWOO TAKBAE</div>
              <div class="big" id="wbText">-</div>
            </div>
            <div class="tag" id="typeTag">-</div>
          </div>

          <div class="line"></div>

          <div class="row">
            <div style="flex:1;">
              <div class="small" style="opacity:.7;">접수지점</div>
              <div class="small" style="font-weight:900;" id="storeName">-</div>
            </div>
            <div style="flex:1;">
              <div class="small" style="opacity:.7;">도착점포</div>
              <div class="small" style="font-weight:900;" id="destStoreName">-</div>
            </div>
          </div>

          <div class="line"></div>

          <div>
            <div class="small" style="opacity:.7;">주소 / 비고</div>
            <div class="addr" id="addr">-</div>
          </div>

          <div class="row">
            <div style="flex:1;">
              <div class="small" style="opacity:.7;">무게(kg)</div>
              <div class="small" style="font-weight:900;" id="weight">-</div>
            </div>
            <div style="flex:1;">
              <div class="small" style="opacity:.7;">종류</div>
              <div class="small" style="font-weight:900;" id="kind">-</div>
            </div>
          </div>

          <div class="barcodeBox">
            <svg id="barcode"></svg>
            <div class="mono" id="wbMono" style="font-size:11pt; font-weight:900;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="noPrint" style="height:14px;"></div>
    <div class="card noPrint" id="statusCard">
      <div style="font-weight:900;">현재 상태</div>
      <div class="hint" id="statusText" style="margin-top:6px;">불러오는 중...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);

    function qp(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    async function apiGetReservations(){
      const r = await fetch("/api/reservations", { cache:"no-store" });
      if(!r.ok) throw new Error("API error");
      return await r.json();
    }

    function typeLabel(t){
      const m = { DOMESTIC:"국내택배", INTERNATIONAL:"국제택배", ECONOMY_CVS:"반값택배", RETURN:"반품택배" };
      return m[t] || t || "-";
    }

    function statusLabel(s){
      const m = {
        RESERVED:"예약", WAYBILL_ISSUED:"운송장발급", FINAL:"점포접수", PICKED_UP:"기사수거",
        ARRIVED_COLLECTION_CENTER:"집화센터도착", ARRIVED_HUB:"허브센터도착", OUTBOUND_PREP:"출고준비",
        STORE_DEPARTED:"점포출발", ARRIVED_STORE:"점포도착", DELIVERED_TO_CUSTOMER:"고객전달완료",
        ARRIVED_SUB_TERMINAL:"서브터미널도착", DEPARTED_SUB_TERMINAL:"서브터미널출발",
        ARRIVED_HUB_TERMINAL:"허브터미널도착", DEPARTED_HUB_TERMINAL:"허브터미널출발",
        ARRIVED_DEST_TERMINAL:"배송지터미널도착", DELIVERY_STARTED:"배송출발", DELIVERED:"배송완료",
        AIR_READY:"비행기이륙준비", AIR_DEPARTED:"항공출발", ARRIVED_COUNTRY:"국가도착", DELIVERED_ADDRESS:"주소지배송완료"
      };
      return m[s] || s || "-";
    }

    function pickAddr(rec){
      return (rec.addr || rec.address || rec.toAddr || rec.customerAddr || "-");
    }

    async function load(){
      const waybill = qp("waybill").trim();
      if(!waybill){
        $("statusText").textContent = "운송장 번호가 없어. 예: label.html?waybill=81...";
        return;
      }

      const all = await apiGetReservations();
      const rec = (all || []).find(x => String(x.waybillNo||"") === waybill);

      $("wbText").textContent = waybill;
      $("wbMono").textContent = waybill;
      try{ JsBarcode("#barcode", waybill, { format:"CODE128", displayValue:false, margin:0, height:60 }); }catch(e){}

      if(!rec){
        $("statusText").textContent = "등록된 운송장이 아님";
        return;
      }

      $("typeTag").textContent = typeLabel(rec.type);
      $("storeName").textContent = rec.storeName || "-";
      $("destStoreName").textContent = rec.destStoreName || "-";
      $("addr").textContent = pickAddr(rec);
      $("weight").textContent = (rec.weightKg ?? rec.weight ?? "-");
      $("kind").textContent = rec.kind || "-";
      $("statusText").textContent = `상태: ${statusLabel(rec.status)} (${rec.status || "-"})`;
    }

    $("btnReload").onclick = () => load();
    $("btnPrint").onclick = () => window.print();

    async function exportPngBlob(){
      const node = $("label");
      if(!window.html2canvas) throw new Error("html2canvas 없음");
      const canvas = await html2canvas(node, { backgroundColor:"#ffffff", scale:2 });
      return await new Promise((resolve)=>canvas.toBlob(resolve, "image/png"));
    }

    $("btnDownload").onclick = async () => {
      try{
        const blob = await exportPngBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `label_${$("wbMono").textContent || "waybill"}.png`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }catch(e){
        alert("PNG 저장 실패. 대신 인쇄를 써줘!");
      }
    };

    $("btnShare").onclick = async () => {
      try{
        if(!navigator.share){
          alert("이 기기/브라우저는 공유 기능이 없어. PNG 저장 후 앱에서 열어줘!");
          return;
        }
        const blob = await exportPngBlob();
        const file = new File([blob], `label_${$("wbMono").textContent || "waybill"}.png`, { type:"image/png" });
        await navigator.share({
          title: "운송장 라벨",
          text: `운송장: ${$("wbMono").textContent || ""}`,
          files: [file]
        });
      }catch(e){
        // cancel/no support
      }
    };

    load();
  </script>
</body>
</html>

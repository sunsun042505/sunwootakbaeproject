<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>택배 시스템</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b3d7; --accent:#7aa2ff;
      --good:#35d07f; --warn:#ffcc66; --bad:#ff6b6b;
      --card: rgba(0,0,0,.18); --line: rgba(255,255,255,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(122,162,255,.18), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(53,208,127,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .panel{
      width:min(1100px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      padding:18px 20px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(122,162,255,.12), rgba(0,0,0,0));
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.65), rgba(53,208,127,.55));
      box-shadow: 0 10px 20px rgba(0,0,0,.28);
    }
    h1{margin:0; font-size:16px;}
    .sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .badge{
      font-size:12px; padding:7px 10px; border:1px solid rgba(255,255,255,.12);
      border-radius:999px; color:var(--muted); background: rgba(0,0,0,.18);
      user-select:none; white-space:nowrap;
    }
    .content{padding:16px;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
    @media (max-width: 560px){ .grid{grid-template-columns: 1fr;} }

    .bigbtn{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(122,162,255,.09), rgba(0,0,0,.18));
      border-radius: 18px;
      padding:18px;
      text-align:left;
      cursor:pointer;
      min-height:110px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .bigbtn:hover{ transform: translateY(-2px); border-color: rgba(122,162,255,.35); }
    .t{font-size:18px; font-weight:900; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{
      font-size:12px; padding:5px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); color:var(--muted); background: rgba(0,0,0,.14);
    }
    .d{font-size:13px; color:var(--muted); line-height:1.45;}

    .card{
      margin-top:14px;
      background: var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding:16px;
    }

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(16,24,48,.35);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 720px){ .row{grid-template-columns: 1fr;} }

    .actions{display:flex; gap:10px; justify-content:space-between; margin-top:14px; flex-wrap:wrap;}
    .btn{
      border:none;
      border-radius: 14px;
      padding:12px 14px;
      cursor:pointer;
      color:var(--text);
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.10);
      min-width:140px;
      font-weight:900;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.48), rgba(122,162,255,.18));
      border-color: rgba(122,162,255,.40);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(53,208,127,.38), rgba(53,208,127,.14));
      border-color: rgba(53,208,127,.35);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,107,107,.38), rgba(255,107,107,.15));
      border-color: rgba(255,107,107,.35);
    }
    .btn.ghost{ color: var(--muted); }

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; letter-spacing:.3px;}
    .hint{font-size:12px; color:var(--muted); line-height:1.4; margin-top:10px;}
    .ok{color: var(--good); font-weight:900;}
    .err{color: var(--bad); font-weight:900;}

    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.14); color:var(--muted); cursor:pointer; user-select:none;}
    .tab.on{border-color: rgba(122,162,255,.45); color: var(--text);}

    .list{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      overflow:hidden;
      max-height: 420px;
      overflow:auto;
      margin-top:10px;
    }
    .item{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
    }
    .item:hover{ background: rgba(255,255,255,.03); }
    .item:last-child{ border-bottom:none; }
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(16,24,48,.35);
      color: var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
  
  /* Modal */
  .modalOverlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center;
    padding:16px; z-index:9999;
  }
  .modalBox{ width:min(520px, 100%); max-height:80vh; overflow:auto; }
  .modalHeader{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .modalTitle{ font-weight:900; font-size:15px; }

</style>
</head>
<body>
  <div class="panel">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>택배 시스템</h1>
          <div class="sub">고객(예약/조회) · 키오스크(운송장발급) · 점포(접수) · 기사(집화)</div>
        </div>
      </div>
      <div class="badge" id="clock">—</div>
    </header>

    <div class="content">
      <!-- HOME -->
      <div id="home">
        <div class="grid">
          <button class="bigbtn" id="goCustomer">
            <div class="t">고객 화면 <span class="pill">예약/조회</span></div>
            <div class="d">예약 버튼 + 배송조회 버튼</div>
          </button>

          <button class="bigbtn" id="goKiosk">
            <div class="t">키오스크 화면 <span class="pill">kiosk.html</span></div>
            <div class="d">예약접수/현장접수 → 운송장 18자리 발급</div>
          </button>

          <button class="bigbtn" id="goStore">
            <div class="t">점포 화면 <span class="pill">로그인</span></div>
            <div class="d">점포 등록/로그인 → 운송장번호로 접수</div>
          </button>

          <button class="bigbtn" id="goCourier">
            <div class="t">기사 화면 <span class="pill">로그인</span></div>
            <div class="d">기사 등록/로그인 → 집화 처리</div>
          </button>
        </div>

        <div class="card">
          <div class="hint">
            • 흐름: 고객 예약 → (kiosk.html) 운송장 발급 → 점포 접수 → 기사 집화 → 고객 조회에서 집화 완료 + 기사 정보 표시
          </div>
          <div class="actions">
            <button class="btn danger" id="wipeAll">전체 데이터 삭제</button>
          </div>
        </div>
      </div>

      <!-- CUSTOMER -->
      <div id="customer" style="display:none;">
        <div class="card" style="margin-top:0;">
          <div style="font-weight:900; font-size:16px;">고객 화면</div>
          <div class="sub">예약 / 배송조회</div>
          <div class="tabs">
            <div class="tab on" id="tabReserve">예약</div>
            <div class="tab" id="tabTrack">배송조회</div>
          </div>
          <div class="actions">
            <button class="btn ghost" data-home>기본 화면</button>
          </div>
        </div>

        <!-- Reserve form -->
        <div class="card" id="custReserveCard">
          <div style="font-weight:900; font-size:15px;">예약하기</div>
          <div class="sub">예약번호 발급(운송장은 키오스크에서 생성)</div>
          <div style="height:12px;"></div>

          <div class="row">
            <div>
              <label>접수 유형</label>
              <select id="c_type">
                <option value="DOMESTIC">국내</option>
                <option value="INTERNATIONAL">국제</option>
                <option value="ECONOMY_CVS">반값택배(편의점)</option>
                <option value="RETURN">반품</option>
              </select>
            </div>
            <div>
              <label>수거/접수 방식</label>
              <select id="c_pickup">
                <option value="STORE">매장 접수</option>
                <option value="PICKUP">기사 수거(예약)</option>
              </select>
            </div>

            <div>
              <label>보내는 사람 이름</label>
              <input id="c_sName" placeholder="예: 홍길동" />
            </div>
            <div>
              <label>보내는 사람 연락처</label>
              <input id="c_sPhone" placeholder="예: 010-1234-5678" />
            </div>

            <div>
              <label>받는 사람 이름(선택)</label>
              <input id="c_rName" placeholder="예: 김철수" />
            </div>
            <div>
              <label>받는 사람 연락처(선택)</label>
              <input id="c_rPhone" placeholder="예: 010-0000-0000" />
            </div>

            <div style="grid-column:1/-1">
              <label id="c_addrLabel">주소(필수)</label>
              <input id="c_addr" placeholder="예: 배송지 주소" />
            </div>

            <div id="c_storePickWrap" style="display:none; grid-column:1/-1; margin-top:10px;">
              <label>반값택배 도착 점포(필수)</label>
              <div class="row" style="grid-template-columns: 2fr 1fr; align-items:end;">
                <div>
                  <input id="c_destStoreName" placeholder="점포조회로 선택" readonly />
                  <input id="c_destStoreCode" type="hidden" />
                </div>
                <div>
                  <button class="btn" id="c_storeLookup" type="button">점포조회</button>
                </div>
              </div>
              <div class="hint">• 등록된 점포만 표시돼. (점포코드는 숨김)</div>
            </div>

            <div id="c_overseasWrap" style="display:none; grid-column:1/-1; margin-top:10px;">
              <label>해외주소(국제택배 필수)</label>
              <textarea id="c_overseas" placeholder="예: 123 Main St, City, State/Province, Postal Code, Country" style="min-height:70px;"></textarea>
            </div>
            <div class="hint" id="c_economyHint" style="display:none; grid-column:1/-1;">
              • 반값택배는 편의점으로 보내는 서비스야. <b>최대 소요기간 6일</b> 안내 문구가 필요하면 영수증/안내에 같이 표시돼.<br>
              • 받는 편의점 주소(지점명+주소)를 꼭 적어줘!
            </div>
</div>

            <div style="grid-column:1/-1">
              <label>요청사항(선택)</label>
              <textarea id="c_memo" placeholder="예: 문 앞에 놓아주세요"></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="c_reserveBtn">예약하기</button>
          </div>

          <div class="hint">• 예약번호 생성 후 kiosk.html에서 “예약접수”로 운송장(18자리)이 만들어짐.</div>
        </div>

        <div class="card" id="custReserveResult" style="display:none;"></div>

        <!-- Tracking -->
        <div class="card" id="custTrackCard" style="display:none;">
          <div style="font-weight:900; font-size:15px;">배송조회</div>
          <div class="sub">운송장 번호로 조회 (등록된 운송장인지 확인)</div>

          <div style="height:12px;"></div>
          <div class="row" style="grid-template-columns: 2fr 1fr;">
            <div>
              <label>운송장 번호(18자리)</label>
              <input id="t_waybill" class="mono" placeholder="예: 81xxxxxxxxxxxxxxxx" />
            </div>
            <div>
              <button class="btn primary" id="t_search">조회</button>
            </div>
          </div>

          <div class="card" id="t_result" style="display:none;"></div>

          <div class="hint">
            • 집화 완료 상태면 기사 이름/전화번호가 표시돼.<br>
            • 점포 접수까지 됐으면 점포명도 표시돼.<br>
            • 주소/무게/종류/국가(국제)도 같이 표시돼.
          </div>
        </div>
      </div>

      <!-- STORE -->
      <div id="store" style="display:none;">
        <div class="card" style="margin-top:0;">
          <div style="font-weight:900; font-size:16px;">점포 화면</div>
          <div class="sub">점포 등록/로그인 → 운송장 번호로 “접수(최종접수)”</div>
          <div class="actions">
            <button class="btn ghost" data-home>기본 화면</button>
          </div>
        </div>

        <!-- Store auth -->
        <div class="card" id="storeAuth">
          <div style="font-weight:900; font-size:15px;">점포 로그인</div>
          <div class="sub">점포명 + 점포코드</div>
          <div style="height:12px;"></div>

          <div class="row">
            <div>
              <label>점포명</label>
              <input id="s_name" placeholder="예: GS25 강남점" />
            </div>
            <div>
              <label>점포코드</label>
              <input id="s_code" class="mono" placeholder="예: STORE-001" />
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="s_register">점포등록</button>
            <button class="btn primary" id="s_login">로그인</button>
          </div>

          <div class="card" id="s_authResult" style="display:none;"></div>
        </div>

        <!-- Store dashboard -->
        <div class="card" id="storeDash" style="display:none;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <div style="font-weight:900; font-size:15px;">점포 작업</div>
              <div class="sub" id="s_who">—</div>
            </div>
            <span class="tag">운송장 접수</span>
          </div>

          <div style="height:12px;"></div>
          <div class="row" style="grid-template-columns: 1fr 1fr 1fr; margin-top:6px;">
            <button class="btn" id="s_mode_accept">택배접수</button>
            <button class="btn" id="s_mode_inbound">입고</button>
            <button class="btn" id="s_mode_handover">고객전달</button>
          </div>

          <div id="s_acceptWrap">


          <div class="row" style="grid-template-columns: 2fr 1fr;">
            <div>
              <label>운송장 번호 입력(18자리)</label>
              <input id="s_waybill" class="mono" placeholder="예: 81xxxxxxxxxxxxxxxx" />
            </div>
            <div>
              <button class="btn primary" id="s_accept">접수(최종접수)</button>
            </div>
          </div>

          <div class="card" id="s_acceptResult" style="display:none;"></div>

          <div class="hint">
            • “접수”하면 해당 운송장에 점포명이 저장되고, 기사 화면에 이 건이 표시돼.<br>
            • 목록/확인창에 주소/무게/종류도 같이 보여줌.
          </div>

          
          </div> <!-- /s_acceptWrap -->

          <div id="s_inboundWrap" style="display:none;">
            <div style="height:10px;"></div>
            <div style="font-weight:900; font-size:14px;">반값택배 입고 처리</div>
            <div class="sub">편의점에 도착한 반값택배 운송장 번호를 입력</div>
            <div style="height:10px;"></div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
              <div>
                <label>운송장 번호(18자리)</label>
                <input id="s_in_waybill" class="mono" placeholder="예: 30xxxxxxxxxxxxxxxx" />
              </div>
              <div>
                <button class="btn primary" id="s_inbound">입고처리</button>
              </div>
            </div>
            <div class="card" id="s_inboundResult" style="display:none;"></div>
            <div class="hint">• 입고처리되면 고객 조회 화면에 “점포에 택배가 도착했습니다” + 고유번호가 표시돼.</div>
          </div>

          <div id="s_handoverWrap" style="display:none;">
            <div style="height:10px;"></div>
            <div style="font-weight:900; font-size:14px;">반값택배 고객 전달</div>
            <div class="sub">고객이 가져온 고유번호로 전달 완료 처리</div>
            <div style="height:10px;"></div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
              <div>
                <label>운송장 번호(18자리)</label>
                <input id="s_h_waybill" class="mono" placeholder="예: 30xxxxxxxxxxxxxxxx" />
              </div>
              <div>
                <label>고유번호</label>
                <input id="s_pickupCode" class="mono" placeholder="예: A1B2C3" />
              </div>
            </div>
            <div class="actions" style="margin-top:8px;">
              <button class="btn primary" id="s_handover">고객전달 완료</button>
            </div>
            <div class="card" id="s_handoverResult" style="display:none;"></div>
          </div>

<div class="actions">
            <button class="btn" id="s_logout">로그아웃</button>
            <button class="btn" id="s_refresh">목록 새로고침</button>
          </div>
        </div>

        <div class="card" id="storeListCard" style="display:none;">
          <div style="font-weight:900; font-size:14px;">접수대기(운송장 발급됨) 목록</div>
          <div class="sub">상태: WAYBILL_ISSUED (점포 접수 전)</div>
          <div class="list" id="s_list"></div>
        </div>
      </div>

      <!-- COURIER -->
      <div id="courier" style="display:none;">
        <div class="card" style="margin-top:0;">
          <div style="font-weight:900; font-size:16px;">기사 화면</div>
          <div class="sub">기사 등록/로그인 → 집화</div>
          <div class="actions">
            <button class="btn ghost" data-home>기본 화면</button>
          </div>
        </div>

        <!-- Courier auth -->
        <div class="card" id="courierAuth">
          <div style="font-weight:900; font-size:15px;">기사 로그인</div>
          <div class="sub">기사 등록 기능 + 코드로 로그인</div>
          <div style="height:12px;"></div>
          <div class="row" style="grid-template-columns:1fr 1fr; margin-top:6px;">
            <button class="btn" id="c_mode_domestic">국내택배 기사</button>
            <button class="btn" id="c_mode_economy">반값택배 기사</button>
          </div>
          <div class="hint" style="margin-top:8px;">
            • 로그인은 코드만으로 가능. 단, 기사 구분이 다르면 자동으로 맞는 화면으로 전환돼.
          </div>


          <div class="row">
            <div>
              <label>기사명(등록 시 필요)</label>
              <input id="c_name" placeholder="예: 김기사" />
            </div>
            <div>
              <label>전화번호(등록 시 필요)</label>
              <input id="c_phone" placeholder="예: 010-9999-8888" />
            </div>

            <div>
              <label>기사 구분(등록 시 선택)</label>
              <select id="c_role">
                <option value="DOMESTIC">국내/국제/반품</option>
                <option value="ECONOMY_CVS">반값택배</option>
              </select>
            </div>

            <div style="grid-column:1/-1">
              <label>기사코드(로그인/등록)</label>
              <input id="c_code" class="mono" placeholder="예: COURIER-1234" />
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="c_register">기사등록</button>
            <button class="btn primary" id="c_login">로그인(코드만)</button>
          </div>

          <div class="card" id="c_authResult" style="display:none;"></div>
        </div>

        <!-- Courier dashboard -->
        <div class="card" id="courierDash" style="display:none;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <div style="font-weight:900; font-size:15px;">집화 대상</div>
              <div class="sub" id="c_who">—</div>
            </div>
            <span class="tag">FINAL만 표시</span>
          </div>

          <div class="actions">
            <button class="btn" id="c_logout">로그아웃</button>
            <button class="btn" id="c_refresh">목록 새로고침</button>
          </div>
        </div>

        <div class="card" id="courierListCard" style="display:none;">
          <div style="font-weight:900; font-size:14px;">운송장 목록</div>
          <div class="sub">항목을 선택하면 작업 버튼이 활성화돼.</div>

          <div class="hint" style="margin-top:8px;">선택된 운송장: <span class="mono" id="c_selectedWb">-</span></div>

          <div id="c_economyOps" style="display:none; margin-top:10px;">
            <div style="font-weight:900; font-size:13px;">센터 처리(반값택배)</div>

            <div class="row" style="grid-template-columns: 2fr 1fr; margin-top:8px;">
              <div>
                <label>센터 추가</label>
                <input id="c_centerName" placeholder="예: 성수집화센터" />
              </div>
              <div style="align-self:end;">
                <button class="btn" id="c_addCenter" type="button">추가</button>
              </div>
            </div>

            <div class="row" style="grid-template-columns:1fr; margin-top:8px;">
              <div>
                <label>센터 선택</label>
                <select id="c_centerSelect"></select>
              </div>
            </div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_collection" type="button">집화센터 도착</button>
              <button class="btn" id="c_btn_hub" type="button">허브센터 도착</button>
            </div>
            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_outbound" type="button">출고준비</button>
              <button class="btn" id="c_btn_storeDepart" type="button">점포출발</button>
            </div>

            <div class="hint">• 순서: 기사수거 → 집화센터도착 → 허브센터도착 → 출고준비 → 점포출발</div>
          </div>

          <div class="list" id="c_list" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ==== Persistent storage (Netlify Functions + Blobs) ====
  // Works when hosted on Netlify (or any host that serves /.netlify/functions).
  // Locally (file://), it falls back to localStorage automatically.
  const STORAGE_KEYS = {
    RES: "DELIVERY_RESERVATIONS_V1",
    STORES: "DELIVERY_STORES_V1",
    COURIERS: "DELIVERY_COURIERS_V1",
    CENTERS: "DELIVERY_CENTERS_V1",
    SESSION: "DELIVERY_SESSION_V1" // session remains local on purpose
  };

  const API_BASE = "/api";
  const useLocalFallback = false;

  const mem = {}; // in-memory cache

  async function apiGet(key, fallback){
    if(useLocalFallback){
      try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch{ return fallback; }
    }
    // cached?
    if(key in mem) return mem[key];
    try{
      const res = await fetch(`${API_BASE}/kv/get?key=${encodeURIComponent(key)}`, { cache: "no-store" });
      if(!res.ok) throw new Error("GET failed");
      const json = await res.json();
      mem[key] = json.value ?? fallback;
      return mem[key];
    }catch(e){
      return fallback;
    }
  }

  async function apiSet(key, value){
    mem[key] = value;
    if(useLocalFallback){
      localStorage.setItem(key, JSON.stringify(value));
      return;
    }
    try{
      const res = await fetch(`${API_BASE}/kv/set`, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ key, value })
      });
      if(!res.ok) throw new Error("POST failed");
    }
    catch(e){
      throw e;
    }
  }

  async function apiDel(key){
    delete mem[key];
    if(useLocalFallback){
      localStorage.removeItem(key);
      return;
    }
    try{
      await fetch(`${API_BASE}/kv/set`, {
        method: "DELETE",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ key })
      });
    }
    catch(e){
      throw e;
    }
  }

  // ==== Domain constants ====
  const TYPE_LABEL = {
    DOMESTIC: "국내",
    INTERNATIONAL: "국제",
    ECONOMY_CVS: "반값택배",
    RETURN: "반품"
  };

  const KIND_LABEL = {
    DOCUMENT: "서류",
    SMALL_BOX: "소형 박스",
    MEDIUM_BOX: "중형 박스",
    LARGE_BOX: "대형 박스",
    FRAGILE: "파손주의",
    ETC: "기타"
  };

  function nowStr(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }


  function ensureEvents(rec){
    if(!rec.events || !Array.isArray(rec.events)) rec.events = [];
    return rec.events;
  }

  function pushEvent(rec, place, message, atOpt){
    const events = ensureEvents(rec);
    events.push({ at: atOpt || nowStr(), place: place || "-", message: message || "-" });
  }

  function renderEvents(rec){
    const events = (rec.events && Array.isArray(rec.events)) ? rec.events.slice() : [];
    // If older records have no events, derive from known fields.
    if(events.length === 0){
      if(rec.storeAcceptedAt && rec.storeName) events.push({ at: rec.storeAcceptedAt, place: rec.storeName, message: "점포접수 하였습니다" });
      if(rec.pickedAt && rec.storeName) events.push({ at: rec.pickedAt, place: rec.storeName, message: "기사수거 하였습니다" });
      if(rec.collectionArrivedAt && rec.collectionCenterName) events.push({ at: rec.collectionArrivedAt, place: rec.collectionCenterName, message: "집화센터에 도착하였습니다" });
      if(rec.hubArrivedAt) events.push({ at: rec.hubArrivedAt, place: (rec.hubName || "강남허브센터"), message: "허브센터 도착했습니다" });
      if(rec.outboundPrepAt && rec.outboundCenterName) events.push({ at: rec.outboundPrepAt, place: rec.outboundCenterName, message: "출고센터 배송준비중입니다" });
      if(rec.storeDepartedAt) events.push({ at: rec.storeDepartedAt, place: rec.destStoreName || rec.storeName || "-", message: "점포출발 했습니다" });
      if(rec.arrivedAt) events.push({ at: rec.arrivedAt, place: rec.destStoreName || rec.storeName || "-", message: "점포도착하였습니다" });
      if(rec.deliveredAt) events.push({ at: rec.deliveredAt, place: rec.destStoreName || rec.storeName || "-", message: "고객에게 전달하였습니다" });
    }
    // sort by time string if possible
    events.sort((a,b) => String(a.at||"").localeCompare(String(b.at||"")));
    return events;
  }

  function makeReserveNo(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const rand = Math.random().toString(36).slice(2,7).toUpperCase();
    return `RSV-${y}${m}${day}-${rand}`;
  }

  // ==== Session (local only) ====
  function loadSession(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEYS.SESSION) || "{}"); } catch { return {}; }
  }
  function saveSession(obj){
    localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify(obj));
  }

  // ==== Reservations (persistent) ====
  async function getReservations(){ return await apiGet(STORAGE_KEYS.RES, []); }
  async function setReservations(arr){ await apiSet(STORAGE_KEYS.RES, arr); }

  async function upsertRes(rec){
    const arr = await getReservations();
    const idx = arr.findIndex(x => x.reserveNo === rec.reserveNo);
    if(idx >= 0) arr[idx] = rec; else arr.unshift(rec);
    await setReservations(arr);
  }

  async function findByWaybill(waybill){
    const arr = await getReservations();
    return arr.find(x => x.waybillNo === waybill) || null;
  }

  function statusLabel(rec){
    const s = rec.status || "";
    if(s === "RESERVED") return "예약";
    if(s === "WAYBILL_ISSUED") return "운송장발급";
    if(s === "FINAL") return "점포접수";
    if(s === "PICKED_UP") return "기사수거";
    if(s === "ARRIVED_COLLECTION_CENTER") return "집화센터도착";
    if(s === "ARRIVED_HUB") return "허브센터도착";
    if(s === "OUTBOUND_PREP") return "출고준비";
    if(s === "STORE_DEPARTED") return "점포출발";
    if(s === "ARRIVED_STORE") return "점포도착";
    if(s === "DELIVERED_TO_CUSTOMER") return "고객전달완료";
    return s || "-";
  }

  function pkgSummary(rec){
    const addr = rec.addr ? rec.addr : "-";
    const w = (rec.package && typeof rec.package.weightKg === "number") ? rec.package.weightKg : (rec.package?.weightKg || "-");
    const kindKey = rec.package?.kind || "";
    const kind = kindKey ? (KIND_LABEL[kindKey] || kindKey) : "-";
    const country = rec.package?.country ? rec.package.country : "";
    return { addr, w, kind, country };
  }

  function detailText(rec){
    const p = pkgSummary(rec);
    let t = "";
    t += `주소: ${p.addr}\n`;
    t += `무게(kg): ${p.w}\n`;
    t += `종류: ${p.kind}\n`;
    if(rec.type === "INTERNATIONAL"){
      t += `국가: ${p.country || "-"}\n`;
    }
    return t.trim();
  }

  function tick(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    $("clock").textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  setInterval(tick, 1000); tick();

  // Navigation
  function show(view){
    ["home","customer","store","courier"].forEach(id => $(id).style.display = "none");
    $(view).style.display = "";
    if(view === "store") renderStoreLists();
    if(view === "courier") renderCourierLists();
  }
  document.querySelectorAll("[data-home]").forEach(b => b.onclick = () => show("home"));

  $("goCustomer").onclick = () => { show("customer"); };
  $("goKiosk").onclick = () => { window.location.href = "./kiosk.html"; };
  $("goStore").onclick = () => { show("store"); hydrateStoreSession(); };
  $("goCourier").onclick = () => { show("courier"); hydrateCourierSession(); };

  // ---------- CUSTOMER: tabs ----------
  function setCustTab(which){
    const reserveOn = which === "reserve";
    $("tabReserve").classList.toggle("on", reserveOn);
    $("tabTrack").classList.toggle("on", !reserveOn);
    $("custReserveCard").style.display = reserveOn ? "" : "none";
    $("custReserveResult").style.display = "none";
    $("custTrackCard").style.display = reserveOn ? "none" : "";
  }
  $("tabReserve").onclick = () => setCustTab("reserve");
  $("tabTrack").onclick = () => setCustTab("track");

  
  // CUSTOMER: type-specific UI
  function updateCustomerTypeUI(){
    const type = $("c_type").value;
    $("c_overseasWrap").style.display = (type === "INTERNATIONAL") ? "" : "none";
    $("c_economyHint").style.display = (type === "ECONOMY_CVS") ? "" : "none";
    $("c_storePickWrap").style.display = (type === "ECONOMY_CVS") ? "" : "none";

    // label / placeholder
    $("c_addrLabel").textContent = (type === "ECONOMY_CVS") ? "추가 메모/상세주소(선택)" : "주소(필수)";
    $("c_addr").placeholder = (type === "ECONOMY_CVS") ? "예: (선택) 상세주소/비고" : "예: 배송지 주소";

    if(type !== "ECONOMY_CVS"){
      $("c_destStoreName").value = "";
      $("c_destStoreCode").value = "";
    }
  }
  $("c_type").onchange = updateCustomerTypeUI;
  updateCustomerTypeUI();

  // CUSTOMER: store picker (반값택배 도착 점포 선택)
  async function openStorePicker(){
    const modal = $("storePickerModal");
    const list = $("storePickerList");
    list.innerHTML = `<div class="item"><div style="color:var(--muted)">불러오는 중...</div></div>`;
    modal.style.display = "flex";

    const stores = await getStores();
    if(!stores || stores.length === 0){
      list.innerHTML = `<div class="item"><div class="err">등록된 점포가 없어. (점포 화면에서 점포등록 먼저!)</div></div>`;
      return;
    }

    // unique by code
    const uniq = [];
    const seen = new Set();
    stores.forEach(s => {
      if(!s || !s.code || seen.has(s.code)) return;
      seen.add(s.code);
      uniq.push(s);
    });
    uniq.sort((a,b) => String(a.name||"").localeCompare(String(b.name||"")));

    list.innerHTML = "";
    uniq.forEach(s => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div style="font-weight:800;">${escapeHtml(s.name || "-")}</div>
          <button class="btn" type="button">선택</button>
        </div>
      `;
      el.querySelector("button").onclick = () => {
        $("c_destStoreName").value = s.name || "";
        $("c_destStoreCode").value = s.code || "";
        closeStorePicker();
      };
      list.appendChild(el);
    });
  }

  function closeStorePicker(){
    $("storePickerModal").style.display = "none";
  }

  $("c_storeLookup").onclick = () => openStorePicker();
  $("storePickerClose").onclick = () => closeStorePicker();
  $("storePickerModal").addEventListener("click", (e) => {
    if(e.target && e.target.id === "storePickerModal") closeStorePicker();
  });

  function makePickupCode(){
    // 6 chars: A-Z0-9 (avoid confusing ones)
    const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
    let out = "";
    for(let i=0;i<6;i++){
      out += chars[Math.floor(Math.random()*chars.length)];
    }
    return out;
  }
// CUSTOMER: reserve
  $("c_reserveBtn").onclick = async () => {
    const type = $("c_type").value;
    const pickup = $("c_pickup").value;

    const sName = $("c_sName").value.trim();
    const sPhone = $("c_sPhone").value.trim();

    if(!sName || !sPhone){
      alert("보내는 사람 이름/연락처는 필수야!");
      return;
    }
    const rName = $("c_rName").value.trim();
    const rPhone = $("c_rPhone").value.trim();
    if(!rName || !rPhone){
      alert("받는 사람 이름/연락처도 필수야!");
      return;
    }
    let addr = $("c_addr").value.trim();
    let destStoreName = "";
    let destStoreCode = "";
    if(type === "ECONOMY_CVS"){
      destStoreName = $("c_destStoreName").value.trim();
      destStoreCode = $("c_destStoreCode").value.trim();
      if(!destStoreCode || !destStoreName){
        alert("반값택배는 점포조회로 도착 점포를 선택해야 해!");
        return;
      }
      // 기본 주소는 선택한 점포명. c_addr은 선택(상세메모)
      addr = destStoreName + (addr ? ` / ${addr}` : "");
    }else{
      if(!addr){
        alert("주소는 필수야!");
        return;
      }
    }

    if(type==="INTERNATIONAL"){
      const ov = $("c_overseas").value.trim();
      if(!ov){ alert("국제택배는 해외주소가 필수야!"); return; }
    }

    const rec = {
      reserveNo: makeReserveNo(),
      type,
      pickup,
      createdAt: nowStr(),
      status: "RESERVED",
      waybillNo: "",
      waybillIssuedAt: "",
      storeName: "",
      storeAcceptedAt: "",
      courier: { code:"", name:"", phone:"" },
      pickedAt: "",
      sender: { name:sName, phone:sPhone },
      receiver: { name: rName, phone: rPhone },
      addr: addr,
      destStoreName: (type==="ECONOMY_CVS") ? destStoreName : "",
      destStoreCode: (type==="ECONOMY_CVS") ? destStoreCode : "",
      // 배송 단계 기록
      collectionCenterName: "",
      collectionArrivedAt: "",
      hubName: "",
      hubArrivedAt: "",
      outboundCenterName: "",
      outboundPrepAt: "",
      storeDepartedAt: "",
      events: [],
      overseasAddr: ($("c_type").value === "INTERNATIONAL") ? ($("c_overseas").value.trim()) : "",
      arrivedAt: "",
      pickupCode: "",
      deliveredAt: "",
      memo: $("c_memo").value.trim(),
    };

    await upsertRes(rec);

    $("custReserveResult").style.display = "";
    $("custReserveResult").innerHTML = `
      <div class="ok">예약 완료</div>
      <div class="sub">키오스크에서 예약접수/현장접수로 운송장 발급</div>
      <div style="height:10px;"></div>
      <div class="mono" style="white-space:pre-wrap; line-height:1.45;">
예약번호: ${escapeHtml(rec.reserveNo)}
유형: ${escapeHtml(TYPE_LABEL[rec.type])}
상태: RESERVED
      </div>
      <div class="hint">• kiosk.html에서 “예약접수”로 운송장(18자리)을 발급해.</div>
    `;
  };

  // CUSTOMER: tracking (✅ 한글 + 히스토리)
  $("t_search").onclick = async () => {
    const wb = $("t_waybill").value.trim();
    if(!wb){
      alert("운송장 번호를 입력해줘!");
      return;
    }
    const rec = await findByWaybill(wb);
    $("t_result").style.display = "";
    if(!rec){
      $("t_result").innerHTML = `<div class="err">등록된 운송장이 아님</div>`;
      return;
    }

    const p = pkgSummary(rec);
    const events = renderEvents(rec);

    const historyHtml = events.map(e => `
      <div class="item">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div style="font-weight:800;">${escapeHtml(e.place || "-")} ${escapeHtml(e.message || "-")}</div>
          <div class="mono" style="color:var(--muted); font-size:12px;">${escapeHtml(e.at || "-")}</div>
        </div>
      </div>
    `).join("");

    const extra =
      (rec.status === "ARRIVED_STORE" && rec.pickupCode)
        ? `<div class="hint" style="margin-top:10px;">• 점포에 택배가 도착했습니다. 고유번호: <span class="mono">${escapeHtml(rec.pickupCode)}</span> 를 점포에 제시해 주세요.</div>`
        : "";

    const courierLine = rec.courier?.name ? `${rec.courier.name} (${rec.courier.phone || "-"})` : "-";

    $("t_result").innerHTML = `
      <div class="ok">조회 성공</div>
      <div class="mono" style="margin-top:8px; white-space:pre-wrap; line-height:1.45;">
운송장: ${escapeHtml(rec.waybillNo)}
유형: ${escapeHtml(TYPE_LABEL[rec.type] || rec.type)}
상태: ${escapeHtml(statusLabel(rec))}
접수지점: ${escapeHtml(rec.storeName || "-")}
도착점포: ${escapeHtml(rec.destStoreName || "-")}
기사: ${escapeHtml(courierLine)}
주소/비고: ${escapeHtml(p.addr)}
무게(kg): ${escapeHtml(p.w)}
종류: ${escapeHtml(p.kind)}${rec.type==="INTERNATIONAL" ? `
국가: ${escapeHtml(p.country || "-")}` : ""}
      </div>

      <div style="height:10px;"></div>
      <div style="font-weight:900; font-size:13px;">지금까지의 배송정보</div>
      <div class="list" style="margin-top:8px;">${historyHtml || `<div class="item"><div style="color:var(--muted)">히스토리가 없어.</div></div>`}</div>
      ${extra}
    `;
  };

  // ---------- STORE: register/login/session ----------
  async function getStores(){ return await apiGet(STORAGE_KEYS.STORES, []); }
  async function saveStores(arr){ await apiSet(STORAGE_KEYS.STORES, arr); }

  async function storeExists(name, code){
    const list = await getStores();
    return list.find(s => s.name === name && s.code === code) || null;
  }

  async function hydrateStoreSession(){
    const sess = loadSession();
    if(sess.store?.name && sess.store?.code && await storeExists(sess.store.name, sess.store.code)){
      $("storeAuth").style.display = "none";
      $("storeDash").style.display = "";
      $("storeListCard").style.display = "";
      $("s_who").textContent = `로그인: ${sess.store.name} (${sess.store.code})`;
      renderStoreLists();
    }else{
      $("storeAuth").style.display = "";
      $("storeDash").style.display = "none";
      $("storeListCard").style.display = "none";
      $("s_authResult").style.display = "none";
    }
  }

  $("s_register").onclick = async () => {
    const name = $("s_name").value.trim();
    const code = $("s_code").value.trim();
    if(!name || !code){
      alert("점포명/점포코드를 입력해줘!");
      return;
    }
    const stores = await getStores();
    const dup = stores.find(s => s.code === code);
    if(dup){
      $("s_authResult").style.display = "";
      $("s_authResult").innerHTML = `<div class="err">이미 존재하는 점포코드야.</div>`;
      return;
    }
    stores.push({ name, code, createdAt: nowStr() });
    await saveStores(stores);
    $("s_authResult").style.display = "";
    $("s_authResult").innerHTML = `<div class="ok">점포 등록 완료</div><div class="hint">이제 로그인 버튼을 눌러.</div>`;
  };

  $("s_login").onclick = async () => {
    const name = $("s_name").value.trim();
    const code = $("s_code").value.trim();
    if(!name || !code){
      alert("점포명/점포코드를 입력해줘!");
      return;
    }
    const store = await storeExists(name, code);
    $("s_authResult").style.display = "";
    if(!store){
      $("s_authResult").innerHTML = `<div class="err">없는 점포입니다.</div>`;
      return;
    }
    const sess = loadSession();
    sess.store = { name, code };
    saveSession(sess);
    $("s_authResult").innerHTML = `<div class="ok">로그인 성공</div>`;
    hydrateStoreSession();
  };

  $("s_logout").onclick = () => {
    const sess = loadSession();
    delete sess.store;
    saveSession(sess);
    hydrateStoreSession();
  };

  // Store list (WAYBILL_ISSUED only)
  async function renderStoreLists(){
    const sess = loadSession();
    if(!sess.store) return;

    const arr = (await getReservations())
      .filter(x => x.waybillNo && x.status === "WAYBILL_ISSUED")
      .slice(0, 50);

    const box = $("s_list");
    box.innerHTML = "";
    if(arr.length === 0){
      box.innerHTML = `<div class="item"><div style="color:var(--muted)">접수대기 내역이 없어.</div></div>`;
      return;
    }
    arr.forEach(r => {
      const p = pkgSummary(r);
      const detailLine = `주소: ${p.addr} · 무게: ${p.w}kg · 종류: ${p.kind}` + (r.type==="INTERNATIONAL" ? ` · 국가: ${p.country || "-"}` : "");
      box.innerHTML += `
        <div class="item" data-wb="${escapeAttr(r.waybillNo)}">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <span class="tag mono">${escapeHtml(r.waybillNo)}</span>
            <span class="tag">${escapeHtml(TYPE_LABEL[r.type])} · ${escapeHtml(statusLabel(r))}</span>
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            예약번호: <span class="mono">${escapeHtml(r.reserveNo)}</span> · 발급: ${escapeHtml(r.waybillIssuedAt || "-")}
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            ${escapeHtml(detailLine)}
          </div>
          <div class="hint">클릭하면 이 운송장을 점포 접수(최종접수)함</div>
        </div>
      `;
    });
    box.querySelectorAll(".item").forEach(el => {
      el.onclick = () => {
        const wb = el.dataset.wb;
        $("s_waybill").value = wb;
        storeAcceptWaybill(true);
      };
    });
  }

  async function storeAcceptWaybill(askConfirm=false){
    const sess = loadSession();
    if(!sess.store) return;

    const wb = $("s_waybill").value.trim();
    if(!wb){
      alert("운송장 번호를 입력해줘!");
      return;
    }
    const rec = await findByWaybill(wb);
    $("s_acceptResult").style.display = "";
    if(!rec){
      $("s_acceptResult").innerHTML = `<div class="err">등록된 운송장이 아님</div>`;
      return;
    }
    if(rec.status !== "WAYBILL_ISSUED"){
      $("s_acceptResult").innerHTML = `<div class="err">점포 접수 가능한 상태가 아님 (현재: ${escapeHtml(rec.status)})</div>`;
      return;
    }

    if(askConfirm){
      const msg =
`점포 접수(최종접수) 할까?

운송장: ${rec.waybillNo}
유형: ${TYPE_LABEL[rec.type]}
${detailText(rec)}
`;
      if(!confirm(msg)) return;
    }

    rec.status = "FINAL";
    rec.storeName = sess.store.name;
    rec.storeAcceptedAt = nowStr();
    pushEvent(rec, sess.store.name, "점포접수 하였습니다", rec.storeAcceptedAt);
    await upsertRes(rec);

    const p = pkgSummary(rec);

    $("s_acceptResult").innerHTML = `
      <div class="ok">점포 접수 완료</div>
      <div class="mono" style="margin-top:8px; white-space:pre-wrap; line-height:1.45;">
운송장: ${escapeHtml(rec.waybillNo)}
점포: ${escapeHtml(rec.storeName)}
주소: ${escapeHtml(p.addr)}
무게(kg): ${escapeHtml(p.w)}
종류: ${escapeHtml(p.kind)}
${rec.type==="INTERNATIONAL" ? `국가: ${escapeHtml(p.country || "-")}\n` : ""}상태: FINAL
      </div>
      <div class="hint">• 이제 기사 화면에 이 건이 표시돼.</div>
    `;
    renderStoreLists();
  }

  // store mode
  let storeMode = "ACCEPT"; // ACCEPT / INBOUND / HANDOVER
  function updateStoreModeUI(){
    $("s_mode_accept").classList.toggle("primary", storeMode==="ACCEPT");
    $("s_mode_inbound").classList.toggle("primary", storeMode==="INBOUND");
    $("s_mode_handover").classList.toggle("primary", storeMode==="HANDOVER");
    $("s_acceptWrap").style.display = (storeMode==="ACCEPT") ? "" : "none";
    $("s_inboundWrap").style.display = (storeMode==="INBOUND") ? "" : "none";
    $("s_handoverWrap").style.display = (storeMode==="HANDOVER") ? "" : "none";
  }
  $("s_mode_accept").onclick = () => { storeMode="ACCEPT"; updateStoreModeUI(); };
  $("s_mode_inbound").onclick = () => { storeMode="INBOUND"; updateStoreModeUI(); };
  $("s_mode_handover").onclick = () => { storeMode="HANDOVER"; updateStoreModeUI(); };
  updateStoreModeUI();

  async function storeInbound(){
    const sess = loadSession();
    if(!sess.store) return;
    const wb = $("s_in_waybill").value.trim();
    $("s_inboundResult").style.display = "";
    if(!wb){ alert("운송장 번호를 입력해줘!"); return; }
    const rec = await findByWaybill(wb);
    if(!rec){ $("s_inboundResult").innerHTML = `<div class="err">등록된 운송장이 아님</div>`; return; }
    if(rec.type !== "ECONOMY_CVS"){ $("s_inboundResult").innerHTML = `<div class="err">반값택배만 입고 처리 가능해!</div>`; return; }
    if(rec.destStoreCode && rec.destStoreCode !== sess.store.code){ $("s_inboundResult").innerHTML = `<div class="err">이 운송장은 이 점포로 도착하는 건이 아니야.</div>`; return; }
    // allow FINAL or PICKED_UP 등, 입고는 반값택배 흐름상 중간/후반 단계
    rec.status = "ARRIVED_STORE";
    rec.arrivedStoreName = sess.store.name;
    rec.arrivedStoreCode = sess.store.code;
    rec.arrivedAt = nowStr();
    rec.pickupCode = rec.pickupCode || makePickupCode();
    pushEvent(rec, sess.store.name, "점포도착하였습니다", rec.arrivedAt);
    await upsertRes(rec);
    $("s_inboundResult").innerHTML = `<div class="ok">입고 완료</div><div class="mono" style="margin-top:8px;">운송장: ${escapeHtml(rec.waybillNo)}\n고유번호: ${escapeHtml(rec.pickupCode)}</div>`;
  }

  async function storeHandover(){
    const sess = loadSession();
    if(!sess.store) return;
    const wb = $("s_h_waybill").value.trim();
    const code = $("s_pickupCode").value.trim().toUpperCase();
    $("s_handoverResult").style.display = "";
    if(!wb || !code){ alert("운송장/고유번호 둘 다 입력해줘!"); return; }
    const rec = await findByWaybill(wb);
    if(!rec){ $("s_handoverResult").innerHTML = `<div class="err">등록된 운송장이 아님</div>`; return; }
    if(rec.type !== "ECONOMY_CVS"){ $("s_handoverResult").innerHTML = `<div class="err">반값택배만 고객전달 가능해!</div>`; return; }
    if(rec.status !== "ARRIVED_STORE"){ $("s_handoverResult").innerHTML = `<div class="err">입고(ARRIVED_STORE) 상태가 아니야.</div>`; return; }
    if(((rec.arrivedStoreCode || rec.destStoreCode || "") !== sess.store.code)){ $("s_handoverResult").innerHTML = `<div class="err">이 점포로 입고된 건이 아냐.</div>`; return; }
    if((rec.pickupCode || "").toUpperCase() !== code){ $("s_handoverResult").innerHTML = `<div class="err">고유번호가 달라!</div>`; return; }

    rec.status = "DELIVERED_TO_CUSTOMER";
    rec.deliveredAt = nowStr();
    pushEvent(rec, sess.store.name, "고객에게 전달하였습니다", rec.deliveredAt);
    await upsertRes(rec);

    $("s_handoverResult").innerHTML = `<div class="ok">고객전달 완료</div><div class="mono" style="margin-top:8px;">운송장: ${escapeHtml(rec.waybillNo)}\n완료: ${escapeHtml(rec.deliveredAt)}</div>`;
  }

  $("s_inbound").onclick = storeInbound;
  $("s_handover").onclick = storeHandover;

  $("s_accept").onclick = () => storeAcceptWaybill(false);
  $("s_refresh").onclick = renderStoreLists;


  // courier mode (DOMESTIC / ECONOMY_CVS)
  let courierMode = "DOMESTIC";
  function updateCourierModeUI(){
    $("c_mode_domestic").classList.toggle("primary", courierMode==="DOMESTIC");
    $("c_mode_economy").classList.toggle("primary", courierMode==="ECONOMY_CVS");
    $("c_mode_domestic").classList.toggle("btn", true);
    $("c_mode_economy").classList.toggle("btn", true);
    if($("c_economyOps")) $("c_economyOps").style.display = (courierMode==="ECONOMY_CVS") ? "" : "none";
  }
  $("c_mode_domestic").onclick = () => { courierMode="DOMESTIC"; updateCourierModeUI(); };
  $("c_mode_economy").onclick = () => { courierMode="ECONOMY_CVS"; updateCourierModeUI(); };

  updateCourierModeUI();

  // courier selected waybill
  let selectedWaybill = "";
  function setSelectedWaybill(wb){
    selectedWaybill = wb || "";
    if($("c_selectedWb")) $("c_selectedWb").textContent = selectedWaybill || "-";
  }
  setSelectedWaybill("");

  // Centers (KV)
  async function getCenters(){ return await apiGet(STORAGE_KEYS.CENTERS, []); }
  async function setCenters(arr){ await apiSet(STORAGE_KEYS.CENTERS, arr); }

  async function refreshCenterSelect(){
    const centers = (await getCenters()) || [];
    const sel = $("c_centerSelect");
    if(!sel) return;
    const safe = centers.filter(x => typeof x === "string" && x.trim());
    sel.innerHTML = safe.length
      ? safe.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("")
      : `<option value="">(센터 없음)</option>`;
  }

  $("c_addCenter")?.addEventListener("click", async () => {
    const name = ($("c_centerName")?.value || "").trim();
    if(!name){ alert("센터명을 입력해줘!"); return; }
    const centers = (await getCenters()) || [];
    if(!centers.includes(name)) centers.push(name);
    await setCenters(centers);
    $("c_centerName").value = "";
    await refreshCenterSelect();
    alert("센터 추가 완료!");
  });

  async function withSelectedRec(fn){
    if(!selectedWaybill){
      alert("운송장을 먼저 선택해줘!");
      return;
    }
    const rec = await findByWaybill(selectedWaybill);
    if(!rec){ alert("내역이 없어!"); return; }
    await fn(rec);
    await upsertRes(rec);
    await renderCourierLists();
  }

  // Economy: center status buttons
  $("c_btn_collection")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(rec.status !== "PICKED_UP"){ alert("기사수거(PICKED_UP) 이후에 가능"); throw new Error("stop"); }
      const center = ($("c_centerSelect")?.value || "").trim();
      if(!center){ alert("센터를 먼저 추가/선택해줘!"); throw new Error("stop"); }
      rec.status = "ARRIVED_COLLECTION_CENTER";
      rec.collectionCenterName = center;
      rec.collectionArrivedAt = nowStr();
      pushEvent(rec, center, "집화센터에 도착하였습니다", rec.collectionArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_hub")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(!(rec.status === "ARRIVED_COLLECTION_CENTER" || rec.status === "PICKED_UP")){
        alert("집화센터도착 이후에 가능"); throw new Error("stop");
      }
      rec.status = "ARRIVED_HUB";
      rec.hubName = "강남허브센터";
      rec.hubArrivedAt = nowStr();
      pushEvent(rec, rec.hubName, "허브센터 도착했습니다", rec.hubArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_outbound")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(rec.status !== "ARRIVED_HUB"){ alert("허브센터 도착 이후에 가능"); throw new Error("stop"); }
      const center = ($("c_centerSelect")?.value || "").trim();
      if(!center){ alert("출고센터를 선택해줘!"); throw new Error("stop"); }
      rec.status = "OUTBOUND_PREP";
      rec.outboundCenterName = center;
      rec.outboundPrepAt = nowStr();
      pushEvent(rec, center, "출고센터 배송준비중입니다", rec.outboundPrepAt);
    }).catch(()=>{});
  });

  $("c_btn_storeDepart")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(rec.status !== "OUTBOUND_PREP"){ alert("출고준비 이후에 가능"); throw new Error("stop"); }
      const dest = rec.destStoreName || "-";
      rec.status = "STORE_DEPARTED";
      rec.storeDepartedAt = nowStr();
      pushEvent(rec, dest, "점포출발 했습니다", rec.storeDepartedAt);
    }).catch(()=>{});
  });

  // init center select
  refreshCenterSelect();

  // ---------- COURIER: register/login/session ----------
  async function getCouriers(){ return await apiGet(STORAGE_KEYS.COURIERS, []); }
  async function saveCouriers(arr){ await apiSet(STORAGE_KEYS.COURIERS, arr); }

  async function courierByCode(code){
    const list = await getCouriers();
    return list.find(c => c.code === code) || null;
  }

  async function hydrateCourierSession(){
    const sess = loadSession();
    if(sess.courier?.code && await courierByCode(sess.courier.code)){
      $("courierAuth").style.display = "none";
      $("courierDash").style.display = "";
      $("courierListCard").style.display = "";
      const c = await courierByCode(sess.courier.code);
      const modeLabel = (courierMode==="ECONOMY_CVS") ? "반값택배 기사" : "국내택배 기사";
      $("c_who").textContent = `로그인: ${c.name} (${c.code}) · ${modeLabel}`;
      renderCourierLists();
    }else{
      $("courierAuth").style.display = "";
      $("courierDash").style.display = "none";
      $("courierListCard").style.display = "none";
      $("c_authResult").style.display = "none";
    }
  }

  $("c_register").onclick = async () => {
    const name = $("c_name").value.trim();
    const phone = $("c_phone").value.trim();
    const code = $("c_code").value.trim();
    const role = ($("c_role")?.value || "DOMESTIC");
    if(!name || !phone || !code){
      alert("기사명/전화/코드 다 입력해줘!");
      return;
    }
    const list = await getCouriers();
    if(list.find(x => x.code === code)){
      $("c_authResult").style.display = "";
      $("c_authResult").innerHTML = `<div class="err">이미 존재하는 기사코드야.</div>`;
      return;
    }
    list.push({ name, phone, code, role, createdAt: nowStr() });
    await saveCouriers(list);
    courierMode = role;
    updateCourierModeUI();
    $("c_authResult").style.display = "";
    $("c_authResult").innerHTML = `<div class="ok">기사 등록 완료</div><div class="hint">이제 코드로 로그인해.</div>`;
  };

  $("c_login").onclick = async () => {
    const code = $("c_code").value.trim();
    if(!code){
      alert("기사코드를 입력해줘!");
      return;
    }
    const c = await courierByCode(code);
    $("c_authResult").style.display = "";
    if(!c){
      $("c_authResult").innerHTML = `<div class="err">없는 기사입니다.</div>`;
      return;
    }

    const role = c.role || "DOMESTIC";
    if(role !== courierMode){
      if(role === "ECONOMY_CVS"){
        alert("반값택배 기사입니다. 반값택배 기사 화면으로 전환할게!");
      }else{
        alert("국내택배 기사입니다. 국내택배 기사 화면으로 전환할게!");
      }
      courierMode = role;
      updateCourierModeUI();
    }

    const sess = loadSession();
    sess.courier = { code };
    saveSession(sess);
    $("c_authResult").innerHTML = `<div class="ok">로그인 성공</div>`;
    hydrateCourierSession();
  };

  $("c_logout").onclick = () => {
    const sess = loadSession();
    delete sess.courier;
    saveSession(sess);
    hydrateCourierSession();
  };

  // ✅ FINAL 목록에 상세정보 표시 + 집화 확인창에 상세 표시
  async function renderCourierLists(){
    const sess = loadSession();
    if(!sess.courier) return;

    const courier = await courierByCode(sess.courier.code);
    if(!courier) return;

    const all = await getReservations();
    const statusAllow = (courierMode === "ECONOMY_CVS")
      ? ["FINAL","PICKED_UP","ARRIVED_COLLECTION_CENTER","ARRIVED_HUB","OUTBOUND_PREP","STORE_DEPARTED"]
      : ["FINAL"];

    const arr = all
      .filter(x => x.waybillNo && statusAllow.includes(x.status))
      .filter(x => (courierMode === "ECONOMY_CVS") ? (x.type === "ECONOMY_CVS") : (x.type !== "ECONOMY_CVS"))
      .slice(0, 80);

    const box = $("c_list");
    box.innerHTML = "";
    if(arr.length === 0){
      box.innerHTML = `<div class="item"><div style="color:var(--muted)">표시할 내역이 없어.</div></div>`;
      return;
    }

    arr.forEach(r => {
      const p = pkgSummary(r);
      const detailLine = `주소: ${p.addr} · 무게: ${p.w}kg · 종류: ${p.kind}` + (r.type==="INTERNATIONAL" ? ` · 국가: ${p.country || "-"}` : "");
      const selected = (selectedWaybill && selectedWaybill === r.waybillNo);
      box.innerHTML += `
        <div class="item" data-wb="${escapeAttr(r.waybillNo)}" style="${selected ? "outline:2px solid rgba(46,255,144,.35);" : ""}">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <span class="tag mono">${escapeHtml(r.waybillNo)}</span>
            <span class="tag">${escapeHtml(TYPE_LABEL[r.type] || r.type)} · ${escapeHtml(statusLabel(r))}</span>
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            접수지점: ${escapeHtml(r.storeName || "-")} · 도착점포: ${escapeHtml(r.destStoreName || "-")}
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            ${escapeHtml(detailLine)}
          </div>
          <div class="hint">${(r.status==="FINAL") ? "클릭하면 기사수거 처리됨" : "클릭하면 선택됨"}</div>
        </div>
      `;
    });

    box.querySelectorAll(".item").forEach(el => {
      el.onclick = async () => {
        const wb = el.dataset.wb;
        setSelectedWaybill(wb);
        await refreshCenterSelect();

        const rec = await findByWaybill(wb);
        if(!rec){ alert("내역 없음"); return; }

        // Both modes: if FINAL, allow pickup.
        if(rec.status === "FINAL"){
          const msg =
`기사수거(집화) 처리할까?

운송장: ${rec.waybillNo}
유형: ${TYPE_LABEL[rec.type]}
접수지점: ${rec.storeName || "-"}
${detailText(rec)}
`;
          if(!confirm(msg)) return;

          rec.status = "PICKED_UP";
          rec.pickedAt = nowStr();
          rec.courier = { code: courier.code, name: courier.name, phone: courier.phone };
          pushEvent(rec, rec.storeName || "-", "기사수거 하였습니다", rec.pickedAt);
          await upsertRes(rec);

          alert(`기사수거 완료!\n운송장: ${wb}\n기사: ${courier.name} (${courier.phone || "-"})`);
          await renderCourierLists();
          return;
        }

        // just selection
        await renderCourierLists();
      };
    });
  }

  $("c_refresh").onclick = renderCourierLists;

  // ---------- Utilities ----------
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("'","&#39;");
  }

  // wipe (remote + local)
  $("wipeAll").onclick = async () => {
    if(!confirm("진짜 전체 데이터 삭제할까?")) return;
    await apiDel(STORAGE_KEYS.RES);
    await apiDel(STORAGE_KEYS.STORES);
    await apiDel(STORAGE_KEYS.COURIERS);
    localStorage.removeItem(STORAGE_KEYS.SESSION);
    alert("삭제 완료");
  };

  // init
  show("home");
  setCustTab("reserve");

  // ADMIN: wipe all data
  $("adminWipeBtn")?.addEventListener("click", async () => {
    const confirmText = ($("adminConfirm")?.value || "").trim();
    if(confirmText !== "전체삭제"){
      alert('확인 문구가 틀렸어. "전체삭제"를 정확히 입력해줘!');
      return;
    }
    const ok1 = confirm("진짜로 전체 데이터를 삭제할까? (되돌릴 수 없음)");
    if(!ok1) return;
    const ok2 = confirm("마지막 확인! 정말 삭제할 거면 확인을 눌러.");
    if(!ok2) return;

    $("adminWipeResult").innerHTML = `<div style="color:var(--muted)">삭제 중...</div>`;
    try{
      const r = await fetch("/api/admin/wipe", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ confirm: "전체삭제" })
      });
      const t = await r.text();
      if(!r.ok) throw new Error(t);
      $("adminWipeResult").innerHTML = `<div class="ok">삭제 완료</div><div class="mono" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(t)}</div>`;
      // optional: reload UI state
      setSelectedWaybill("");
    }catch(e){
      $("adminWipeResult").innerHTML = `<div class="err">삭제 실패: ${escapeHtml(String(e.message||e))}</div>`;
    }
  });

</script>

  <!-- Store Picker Modal -->
  <div id="storePickerModal" class="modalOverlay" style="display:none;">
    <div class="card modalBox">
      <div class="modalHeader">
        <div class="modalTitle">점포 선택</div>
        <button class="btn ghost" id="storePickerClose" type="button">닫기</button>
      </div>
      <div class="sub" style="margin-top:6px;">등록된 점포만 표시돼. (점포코드는 숨김)</div>
      <div style="height:10px;"></div>
      <div class="list" id="storePickerList"></div>
    </div>
  </div>


      <!-- ADMIN -->
      <div class="card" id="adminCard" style="margin-top:14px;">
        <div style="font-weight:900; font-size:14px;">관리자</div>
        <div class="sub">⚠️ 전체 데이터(예약/운송장/점포/기사/센터)를 서버에서 전부 삭제해. 되돌릴 수 없음.</div>

        <div style="height:10px;"></div>
        <label>확인 문구 입력</label>
        <input id="adminConfirm" placeholder='여기에 "전체삭제" 를 정확히 입력' />

        <div style="height:10px;"></div>
        <button class="btn danger" id="adminWipeBtn" type="button">전체 데이터 삭제</button>

        <div id="adminWipeResult" style="margin-top:10px;"></div>
      </div>

</body>
</html>

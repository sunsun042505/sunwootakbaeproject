<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>택배 시스템</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b3d7; --accent:#7aa2ff;
      --good:#35d07f; --warn:#ffcc66; --bad:#ff6b6b;
      --card: rgba(0,0,0,.18); --line: rgba(255,255,255,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(122,162,255,.18), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(53,208,127,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .panel{
      width:min(1100px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      padding:18px 20px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(122,162,255,.12), rgba(0,0,0,0));
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.65), rgba(53,208,127,.55));
      box-shadow: 0 10px 20px rgba(0,0,0,.28);
    }
    h1{margin:0; font-size:16px;}
    .sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .badge{
      font-size:12px; padding:7px 10px; border:1px solid rgba(255,255,255,.12);
      border-radius:999px; color:var(--muted); background: rgba(0,0,0,.18);
      user-select:none; white-space:nowrap;
    }
    .content{padding:16px;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
    @media (max-width: 560px){ .grid{grid-template-columns: 1fr;} }

    .bigbtn{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(122,162,255,.09), rgba(0,0,0,.18));
      border-radius: 18px;
      padding:18px;
      text-align:left;
      cursor:pointer;
      min-height:110px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .bigbtn:hover{ transform: translateY(-2px); border-color: rgba(122,162,255,.35); }
    .t{font-size:18px; font-weight:900; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{
      font-size:12px; padding:5px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); color:var(--muted); background: rgba(0,0,0,.14);
    }
    .d{font-size:13px; color:var(--muted); line-height:1.45;}

    .card{
      margin-top:14px;
      background: var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding:16px;
    }

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(16,24,48,.35);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 720px){ .row{grid-template-columns: 1fr;} }

    .actions{display:flex; gap:10px; justify-content:space-between; margin-top:14px; flex-wrap:wrap;}
    .btn{
      border:none;
      border-radius: 14px;
      padding:12px 14px;
      cursor:pointer;
      color:var(--text);
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.10);
      min-width:140px;
      font-weight:900;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.48), rgba(122,162,255,.18));
      border-color: rgba(122,162,255,.40);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(53,208,127,.38), rgba(53,208,127,.14));
      border-color: rgba(53,208,127,.35);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,107,107,.38), rgba(255,107,107,.15));
      border-color: rgba(255,107,107,.35);
    }

  .btn.bad{ background: linear-gradient(180deg, rgba(255,107,107,.35), rgba(255,107,107,.12)); border-color: rgba(255,107,107,.38); }
    .btn.ghost{ color: var(--muted); }

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; letter-spacing:.3px;}
    .hint{font-size:12px; color:var(--muted); line-height:1.4; margin-top:10px;}
    .ok{color: var(--good); font-weight:900;}
    .err{color: var(--bad); font-weight:900;}

    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.14); color:var(--muted); cursor:pointer; user-select:none;}
    .tab.on{border-color: rgba(122,162,255,.45); color: var(--text);}

    .list{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      overflow:hidden;
      max-height: 420px;
      overflow:auto;
      margin-top:10px;
    }
    .item{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
    }
    .item:hover{ background: rgba(255,255,255,.03); }
    .item:last-child{ border-bottom:none; }
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(16,24,48,.35);
      color: var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
  
  /* Modal */
  .modalOverlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center;
    padding:16px; z-index:9999;
  }
  .modalBox{ width:min(520px, 100%); max-height:80vh; overflow:auto; }
  .modalHeader{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .modalTitle{ font-weight:900; font-size:15px; }


    /* Toast 알림 */
    .toast{position:fixed; right:18px; bottom:18px; z-index:9999; min-width:240px; max-width:420px; padding:12px 14px; border:1px solid rgba(255,255,255,.14); border-radius:14px; background:rgba(0,0,0,.55); color:var(--text); box-shadow: 0 16px 40px rgba(0,0,0,.45); display:none;}
    .toast.show{display:block; animation: toastIn .18s ease-out;}
    @keyframes toastIn{from{transform:translateY(8px); opacity:0}to{transform:translateY(0); opacity:1}}
    .toast .t_title{font-weight:900; font-size:13px;}
    .toast .t_msg{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35;}
    .toast.good{border-color: rgba(53,208,127,.35);}
    .toast.warn{border-color: rgba(255,204,102,.45);}
    .toast.bad{border-color: rgba(255,107,107,.55);}
</style>
</head>
<body>
  <div class="panel">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>택배 시스템</h1>
          <div class="sub">고객(예약(조회는 배송조회 화면)) · 키오스크(운송장발급) · 점포(접수) · 기사(집화)</div>
        </div>
      </div>
      <div class="badge" id="clock">—</div>
    </header>

    <div class="content">
      <!-- HOME -->
      <div id="home">
        <div class="grid">
          <button class="bigbtn" id="goCustomer">
            <div class="t">고객 화면 <span class="pill">예약(조회는 배송조회 화면)</span></div>
            <div class="d">예약 버튼 + 배송조회 버튼</div>
          </button>

          

          <button class="bigbtn" id="goTracking">
            <div class="t">배송조회 <span class="pill">tracking.html</span></div>
            <div class="d">운송장 번호로 배송흐름 조회</div>
          </button>
<button class="bigbtn" id="goKiosk">
            <div class="t">키오스크 화면 <span class="pill">kiosk.html</span></div>
            <div class="d">예약접수/현장접수 → 운송장 18자리 발급</div>
          </button>

          <button class="bigbtn" id="goStore">
            <div class="t">점포 화면 <span class="pill">로그인</span></div>
            <div class="d">점포 등록/로그인 → 운송장번호로 접수</div>
          </button>

          <button class="bigbtn" id="goCourier">
            <div class="t">기사 화면 <span class="pill">로그인</span></div>
            <div class="d">기사 등록/로그인 → 집화 처리</div>
          </button>
        </div>

        <div class="card">
          <div class="hint">
            • 흐름: 고객 예약 → (kiosk.html) 운송장 발급 → 점포 접수 → 기사 집화 → 고객 조회에서 집화 완료 + 기사 정보 표시
          </div>
          <div class="actions">
            <button class="btn danger" id="wipeAll">전체 데이터 삭제</button>
          </div>
        </div>
      </div>

      <!-- CUSTOMER -->
      <div id="customer" style="display:none;">
        <div class="card" style="margin-top:0;">
          <div style="font-weight:900; font-size:16px;">고객 화면</div>
          <div class="sub">예약</div>
          <div class="tabs">
            <div class="tab on" id="tabReserve">예약</div>
            
          </div>
          <div class="actions">
            <button class="btn ghost" data-home>기본 화면</button>
            <button class="btn" id="custGoTracking" type="button">배송조회</button>
          </div>
        </div>

        <!-- Reserve form -->
        <div class="card" id="custReserveCard">
          <div style="font-weight:900; font-size:15px;">예약하기</div>
          <div class="sub">예약번호 발급(운송장은 키오스크에서 생성)</div>
          <div style="height:12px;"></div>

          <div class="row">
            <div>
              <label>접수 유형</label>
              <select id="c_type">
                <option value="DOMESTIC">국내</option>
                <option value="INTERNATIONAL">국제</option>
                <option value="ECONOMY_CVS">반값택배(편의점)</option>
                <option value="RETURN">반품</option>
              </select>
            </div>
            <div>
              <label>수거/접수 방식</label>
              <select id="c_pickup">
                <option value="STORE">매장 접수</option>
                <option value="PICKUP">기사 수거(예약)</option>
              </select>
            </div>

            <div>
              <label>보내는 사람 이름</label>
              <input id="c_sName" placeholder="예: 홍길동" />
            </div>
            <div>
              <label>보내는 사람 연락처</label>
              <input id="c_sPhone" placeholder="예: 010-1234-5678" />
            </div>

            <div>
              <label>받는 사람 이름(선택)</label>
              <input id="c_rName" placeholder="예: 김철수" />
            </div>
            <div>
              <label>받는 사람 연락처(선택)</label>
              <input id="c_rPhone" placeholder="예: 010-0000-0000" />
            </div>

            <div style="grid-column:1/-1">
              <label id="c_addrLabel">주소(필수)</label>
              <input id="c_addr" placeholder="예: 배송지 주소" />
            </div>

            <div id="c_storePickWrap" style="display:none; grid-column:1/-1; margin-top:10px;">
              <label>반값택배 도착 점포(필수)</label>
              <div class="row" style="grid-template-columns: 2fr 1fr; align-items:end;">
                <div>
                  <input id="c_destStoreName" placeholder="점포조회로 선택" readonly />
                  <input id="c_destStoreCode" type="hidden" />
                </div>
                <div>
                  <button class="btn" id="c_storeLookup" type="button">점포조회</button>
                </div>
              </div>
              <div class="hint">• 등록된 점포만 표시돼. (점포코드는 숨김)</div>
            </div>

            <div id="c_overseasWrap" style="display:none; grid-column:1/-1; margin-top:10px;">
              <label>해외주소(국제택배 필수)</label>
              <textarea id="c_overseas" placeholder="예: 123 Main St, City, State/Province, Postal Code, Country" style="min-height:70px;"></textarea>
            </div>

            <div id="c_returnOrigWrap" style="display:none; grid-column:1/-1; margin-top:10px;">
              <label>원 운송장 번호(반품 필수)</label>
              <div class="row" style="grid-template-columns: 2fr 1fr; align-items:end;">
                <div>
                  <input id="c_origWaybill" class="mono" placeholder="예: 81/23/30로 시작하는 18자리" />
                </div>
                <div style="align-self:end;">
                  <button class="btn" id="c_origLookup" type="button">조회</button>
                </div>
              </div>
              <div class="hint">• 이름+전화번호로 내 운송장을 찾아서 선택하면 자동 입력돼. (반송 운송장은 제외)</div>
            </div>
            <div class="hint" id="c_economyHint" style="display:none; grid-column:1/-1;">
              • 반값택배는 편의점으로 보내는 서비스야. <b>최대 소요기간 6일</b> 안내 문구가 필요하면 영수증/안내에 같이 표시돼.<br>
              • 받는 편의점 주소(지점명+주소)를 꼭 적어줘!
            </div>
</div>

            <div style="grid-column:1/-1">
              <label>요청사항(선택)</label>
              <textarea id="c_memo" placeholder="예: 문 앞에 놓아주세요"></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="c_reserveBtn">예약하기</button>
          </div>

          <div class="hint">• 예약번호 생성 후 kiosk.html에서 “예약접수”로 운송장(18자리)이 만들어짐.</div>
        </div>

        <div class="card" id="custReserveResult" style="display:none;"></div>

      <!-- STORE -->
      <div id="store" style="display:none;">
        <div class="card" style="margin-top:0;">
          <div style="font-weight:900; font-size:16px;">점포 화면</div>
          <div class="sub">점포 등록/로그인 → 운송장 번호로 “접수(최종접수)”</div>
          <div class="actions">
            <button class="btn ghost" data-home>기본 화면</button>
          </div>
        </div>

        <!-- Store auth -->
        <div class="card" id="storeAuth">
          <div style="font-weight:900; font-size:15px;">점포 로그인</div>
          <div class="sub">점포명 + 점포코드</div>
          <div style="height:12px;"></div>

          <div class="row">
            <div>
              <label>점포명</label>
              <input id="s_name" placeholder="예: GS25 강남점" />
            </div>
            <div>
              <label>점포코드</label>
              <input id="s_code" class="mono" placeholder="예: STORE-001" />
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="s_register">점포등록</button>
            <button class="btn primary" id="s_login">로그인</button>
          </div>

          <div class="card" id="s_authResult" style="display:none;"></div>
        </div>

        <!-- Store dashboard -->
        <div class="card" id="storeDash" style="display:none;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <div style="font-weight:900; font-size:15px;">점포 작업</div>
              <div class="sub" id="s_who">—</div>
            </div>
            <span class="tag">운송장 접수</span>
          </div>

          <div style="height:12px;"></div>
          <div class="row" style="grid-template-columns: 1fr 1fr 1fr; margin-top:6px;">
            <button class="btn" id="s_mode_accept">택배접수</button>
            <button class="btn" id="s_mode_inbound">입고</button>
            <button class="btn" id="s_mode_handover">고객전달</button>
          </div>

          <div class="card" style="margin-top:12px;">
            <div style="font-weight:900; font-size:14px;">배송조회(점포)</div>
            <div class="sub">운송장 번호로 실시간 조회</div>
            <div style="height:10px;"></div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
              <div>
                <label>운송장 번호</label>
                <input id="s_trackWaybill" class="mono" placeholder="18자리 운송장" />
              </div>
              <div style="align-self:end;">
                <button class="btn" id="s_trackSearch" type="button">배송조회</button>
              </div>
            </div>
            <div class="card" id="s_trackResult" style="display:none; margin-top:10px;"></div>
          </div>

          <div id="s_acceptWrap">


          <div class="row" style="grid-template-columns: 2fr 1fr;">
            <div>
              <label>운송장 번호 입력(18자리)</label>
              <input id="s_waybill" class="mono" placeholder="예: 81xxxxxxxxxxxxxxxx" />
            </div>
            <div>
              <button class="btn primary" id="s_accept">접수(최종접수)</button>
            </div>
          </div>

          <div class="card" id="s_acceptResult" style="display:none;"></div>

          <div class="hint">
            • “접수”하면 해당 운송장에 점포명이 저장되고, 기사 화면에 이 건이 표시돼.<br>
            • 목록/확인창에 주소/무게/종류도 같이 보여줌.
          </div>

          
          </div> <!-- /s_acceptWrap -->

          <div id="s_inboundWrap" style="display:none;">
            <div style="height:10px;"></div>
            <div style="font-weight:900; font-size:14px;">반값택배 입고 처리</div>
            <div class="sub">편의점에 도착한 반값택배 운송장 번호를 입력</div>
            <div style="height:10px;"></div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
              <div>
                <label>운송장 번호(18자리)</label>
                <input id="s_in_waybill" class="mono" placeholder="예: 30xxxxxxxxxxxxxxxx" />
              </div>
              <div>
                <button class="btn primary" id="s_inbound">입고처리</button>
              </div>
            </div>
            <div class="card" id="s_inboundResult" style="display:none;"></div>
            <div class="hint">• 입고처리되면 고객 조회 화면에 “점포에 택배가 도착했습니다” + 고유번호가 표시돼.</div>
          </div>

          <div id="s_handoverWrap" style="display:none;">
            <div style="height:10px;"></div>
            <div style="font-weight:900; font-size:14px;">반값택배 고객 전달</div>
            <div class="sub">고객이 가져온 고유번호로 전달 완료 처리</div>
            <div style="height:10px;"></div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
              <div>
                <label>운송장 번호(18자리)</label>
                <input id="s_h_waybill" class="mono" placeholder="예: 30xxxxxxxxxxxxxxxx" />
              </div>
              <div>
                <label>고유번호</label>
                <input id="s_pickupCode" class="mono" placeholder="예: A1B2C3" />
              </div>
            </div>
            <div class="actions" style="margin-top:8px;">
              <button class="btn primary" id="s_handover">고객전달 완료</button>
            </div>
            <div class="card" id="s_handoverResult" style="display:none;"></div>
          </div>

<div class="actions">
            <button class="btn" id="s_logout">로그아웃</button>
            <button class="btn" id="s_refresh">목록 새로고침</button>
          </div>
        </div>

        <div class="card" id="storeListCard" style="display:none;">
          <div style="font-weight:900; font-size:14px;">접수대기(운송장 발급됨) 목록</div>
          <div class="sub">상태: WAYBILL_ISSUED (점포 접수 전)</div>
          <div class="row" style="margin-top:10px;">
            <div style="flex:1;">
              <label>예약/운송장/이름 검색</label>
              <input id="s_search" placeholder="예: 81... 또는 RSV... 또는 이름" />
            </div>
            <div style="align-self:flex-end; display:flex; gap:8px;">
              <button class="btn" id="s_search_clear" type="button">지우기</button>
            </div>
          </div>
          <div class="list" id="s_list"></div>
        </div>
      </div>

      <!-- COURIER -->
      <div id="courier" style="display:none;">
        <div class="card" style="margin-top:0;">
          <div style="font-weight:900; font-size:16px;">기사 화면</div>
          <div class="sub">기사 등록/로그인 → 집화</div>
          <div class="actions">
            <button class="btn ghost" data-home>기본 화면</button>
          </div>
        </div>

        <!-- Courier auth -->
        <div class="card" id="courierAuth">
          <div style="font-weight:900; font-size:15px;">기사 로그인</div>
          <div class="sub">기사 등록 기능 + 코드로 로그인</div>
          <div style="height:12px;"></div>
          <div class="row" style="grid-template-columns:1fr 1fr; margin-top:6px;">
            <button class="btn" id="c_mode_domestic">국내택배 기사</button>
            <button class="btn" id="c_mode_intl">국제택배 기사</button>
            <button class="btn" id="c_mode_economy">반값택배 기사</button>
          </div>
          <div class="hint" style="margin-top:8px;">
            • 로그인은 코드만으로 가능. 단, 기사 구분이 다르면 “국내/국제/반값” 중 맞는 화면으로 전환돼.
          </div>


          <div class="row">
            <div>
              <label>기사명(등록 시 필요)</label>
              <input id="c_name" placeholder="예: 김기사" />
            </div>
            <div>
              <label>전화번호(등록 시 필요)</label>
              <input id="c_phone" placeholder="예: 010-9999-8888" />
            </div>

            <div>
              <label>기사 구분(등록 시 선택)</label>
              <select id="c_role">
                <option value="DOMESTIC">국내/반품</option>
                <option value="INTERNATIONAL">국제택배</option>
                <option value="ECONOMY_CVS">반값택배</option>
              </select>
            </div>

            <div style="grid-column:1/-1">
              <label>기사코드(로그인/등록)</label>
              <input id="c_code" class="mono" placeholder="예: COURIER-1234" />
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="c_register">기사등록</button>
            <button class="btn primary" id="c_login">로그인(코드만)</button>
          </div>

          <div class="card" id="c_authResult" style="display:none;"></div>
        </div>

        <!-- Courier dashboard -->
        <div class="card" id="courierDash" style="display:none;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <div style="font-weight:900; font-size:15px;">집화 대상</div>
              <div class="sub" id="c_who">—</div>
            </div>
            <span class="tag">FINAL만 표시</span>
          </div>

          <div class="actions">
            <button class="btn" id="c_logout">로그아웃</button>
            <button class="btn" id="c_refresh">목록 새로고침</button>
            <button class="btn" id="c_manage_terminal" style="display:none;">터미널 관리</button>
            <button class="btn" id="c_manage_center" style="display:none;">센터 관리</button>
            <button class="btn" id="c_manage_airline" style="display:none;">항공사 관리</button>
          </div>
        </div>

        <div class="card" id="courierListCard" style="display:none;">
          <div style="font-weight:900; font-size:14px;">운송장 목록</div>
          <div class="sub">항목을 선택하면 작업 버튼이 활성화돼.</div>

          <div class="hint" style="margin-top:8px;">선택된 운송장: <span class="mono" id="c_selectedWb">-</span></div>

          <div class="actions" style="margin-top:10px;">
  <button class="btn" id="c_track">배송조회</button>
</div>
<div id="c_domesticOps" style="display:none; margin-top:10px;">
            <div style="font-weight:900; font-size:13px;">터미널 처리(국내/국제/반품)</div>

            <div class="row" style="grid-template-columns: 2fr 1fr; margin-top:8px;">
              <div>
                <label>터미널 추가</label>
                <input id="c_terminalName" placeholder="예: 구로터미널" />
              </div>
              <div style="align-self:end;">
                <button class="btn" id="c_addTerminal" type="button">추가</button>
              </div>
            </div>

            <div class="row" style="grid-template-columns:1fr; margin-top:8px;">
              <div>
                <label>터미널 선택</label>
                <select id="c_terminalSelect"></select>
              </div>
            </div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_subArrive" type="button">서브터미널 도착</button>
              <button class="btn" id="c_btn_subDepart" type="button">서브터미널 출발</button>
            </div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_hubArriveT" type="button">허브터미널 도착</button>
              <button class="btn" id="c_btn_hubDepartT" type="button">허브터미널 출발</button>
            </div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_destArrive" type="button">배송지 터미널 도착</button>
              <button class="btn" id="c_btn_deliveryStart" type="button">배송출발</button>
            </div>

            <div class="row" style="grid-template-columns: 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_delivered" type="button">도착(배송완료)</button>
            </div>
            <div class="row" style="grid-template-columns: 1fr; margin-top:8px;">
              <button class="btn bad" id="c_btn_unshippableT" type="button">배송불가(반송)</button>
            </div>

            <div class="hint">• 순서(추천): 기사수거 → 서브터미널도착 → 서브터미널출발 → 허브도착 → 허브출발 → 배송지터미널도착 → 배송출발 → 배송완료</div>
          </div>

          <div id="c_intlOps" style="display:none; margin-top:10px;">
            <div style="font-weight:900; font-size:13px;">항공 처리(국제택배)</div>

            <div class="row" style="grid-template-columns: 2fr 1fr; margin-top:8px;">
              <div>
                <label>항공사 추가</label>
                <input id="c_airlineName" placeholder="예: 대한항공" />
              </div>
              <div style="align-self:end;">
                <button class="btn" id="c_addAirline" type="button">추가</button>
              </div>
            </div>

            <div class="row" style="grid-template-columns:1fr; margin-top:8px;">
              <div>
                <label>항공사 선택</label>
                <select id="c_airlineSelect"></select>
              </div>
            </div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_airPrep" type="button">비행기 이륙 준비</button>
              <button class="btn" id="c_btn_airDepart" type="button">출발</button>
            </div>
            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_countryArrive" type="button">국가 도착</button>
              <button class="btn" id="c_btn_addrDelivered" type="button">주소지 배송완료</button>
            </div>

            <div class="hint">• 순서(추천): 배송지 터미널 도착 → 비행기 이륙 준비 → 출발 → 국가 도착 → 주소지 배송완료</div>
          </div>

          <div id="c_economyOps" style="display:none; margin-top:10px;"> style="display:none; margin-top:10px;">
            <div style="font-weight:900; font-size:13px;">센터 처리(반값택배)</div>

            <div class="row" style="grid-template-columns: 2fr 1fr; margin-top:8px;">
              <div>
                <label>센터 추가</label>
                <input id="c_centerName" placeholder="예: 성수집화센터" />
              </div>
              <div style="align-self:end;">
                <button class="btn" id="c_addCenter" type="button">추가</button>
              </div>
            </div>

            <div class="row" style="grid-template-columns:1fr; margin-top:8px;">
              <div>
                <label>센터 선택</label>
                <select id="c_centerSelect"></select>
              </div>
            </div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_collection" type="button">집화센터 도착</button>
              <button class="btn" id="c_btn_hub" type="button">허브센터 도착</button>
            </div>
            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:8px;">
              <button class="btn" id="c_btn_outbound" type="button">출고준비</button>
              <button class="btn" id="c_btn_storeDepart" type="button">점포출발</button>
            </div>

            <div class="row" style="grid-template-columns: 1fr; margin-top:8px;">
              <button class="btn bad" id="c_btn_unshippableC" type="button">배송불가(반송)</button>
            </div>

            <div class="hint">• 순서: 기사수거 → 집화센터도착 → 허브센터도착 → 출고준비 → 점포출발</div>
          </div>

          <div class="row" style="grid-template-columns: 1fr auto auto; margin-top:12px;">
            <div>
              <label>예약/운송장 검색</label>
              <input id="c_search" placeholder="예: 81... 또는 RSV... 또는 이름" />
            </div>
            <div style="align-self:end;"><button class="btn" id="c_search_btn" type="button">검색</button></div>
            <div style="align-self:end;"><button class="btn" id="c_search_clear" type="button">지우기</button></div>
          </div>

          <div class="list" id="c_list" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><div class="t_title" id="toastTitle">알림</div><div class="t_msg" id="toastMsg">-</div></div>

<script>

const APP_VERSION = "1.2";

  // ----- UI: Toast 알림 -----
  let __toastTimer = null;
  function showToast(message, title="알림", kind="info"){
    const box = document.getElementById("toast");
    if(!box) return;
    const t = document.getElementById("toastTitle");
    const m = document.getElementById("toastMsg");
    if(t) t.textContent = title;
    if(m) m.textContent = message;
    box.classList.remove("good","warn","bad","info");
    box.classList.add(kind);
    box.classList.add("show");
    clearTimeout(__toastTimer);
    __toastTimer = setTimeout(() => { box.classList.remove("show"); }, 2600);
  }

  // ----- Search state -----
  let __storeSearchQ = "";
  let __courierSearchQ = "";
  function matchRec(rec, q){
    q = (q||"").trim();
    if(!q) return true;
    const t = q.toLowerCase();
    const sName = (rec.sender && rec.sender.name) ? rec.sender.name : "";
    const rName = (rec.receiver && rec.receiver.name) ? rec.receiver.name : "";
    const hay = [rec.waybillNo, rec.reserveNo, sName, rName, rec.storeName, rec.destStoreName].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(t);
  }


    // ===== SAFE DOM GETTER (missing element won't crash the whole app) =====
  const $ = (id) => {
    const el = document.getElementById(id);
    if(el) return el;
    return new Proxy({ __missing:true }, {
      get(t, p){
        if(p === "__missing") return true;
        if(p === "style") return {};
        if(p === "classList") return { add(){}, remove(){}, toggle(){}, contains(){ return false; } };
        if(p === "dataset") return {};
        if(p === "value") return "";
        if(p === "checked") return false;
        if(p === "innerHTML") return "";
        if(p === "textContent") return "";
        if(p === "appendChild") return ()=>{};
        if(p === "removeChild") return ()=>{};
        if(p === "insertAdjacentHTML") return ()=>{};
        if(p === "querySelector") return ()=>null;
        if(p === "querySelectorAll") return ()=>[];
        if(p === "addEventListener") return ()=>{};
        if(p === "removeEventListener") return ()=>{};
        if(p === "focus") return ()=>{};
        if(p === "click") return ()=>{};
        return t[p];
      },
      set(t, p, v){ t[p] = v; return true; }
    });
  };
// ==== Persistent storage (Netlify Functions + Blobs) ====
  // Works when hosted on Netlify (or any host that serves /.netlify/functions).
  // Locally (file://), it falls back to localStorage automatically.
  const STORAGE_KEYS = {
    RES: "DELIVERY_RESERVATIONS_V1",
    STORES: "DELIVERY_STORES_V1",
    COURIERS: "DELIVERY_COURIERS_V1",
    CENTERS: "DELIVERY_CENTERS_V1",
    TERMINALS: "DELIVERY_TERMINALS_V1",
    AIRLINES: "DELIVERY_AIRLINES_V1",
    SESSION: "DELIVERY_SESSION_V1" // session remains local on purpose
  };

  const API_BASE = "/api";
  const useLocalFallback = false;

  const mem = {}; // in-memory cache

  async function apiGet(key, fallback){
    if(useLocalFallback){
      try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch{ return fallback; }
    }
    // cached?
    if(key in mem) return mem[key];
    try{
      const res = await fetch(`${API_BASE}/kv/get?key=${encodeURIComponent(key)}`, { cache: "no-store" });
      if(!res.ok) throw new Error("GET failed");
      const json = await res.json();
      mem[key] = json.value ?? fallback;
      return mem[key];
    }catch(e){
      return fallback;
    }
  }

  async function apiSet(key, value){
    mem[key] = value;
    if(useLocalFallback){
      localStorage.setItem(key, JSON.stringify(value));
      return;
    }
    try{
      const res = await fetch(`${API_BASE}/kv/set`, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ key, value })
      });
      if(!res.ok) throw new Error("POST failed");
    }
    catch(e){
      throw e;
    }
  }
  async function apiGetFresh(key, fallback){
    // mem 캐시를 무시하고 서버에서 최신값을 가져온다 (다른 기기 반영/중복 방지)
    if(useLocalFallback){
      try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch{ return fallback; }
    }
    try{
      const res = await fetch(`${API_BASE}/kv/get?key=${encodeURIComponent(key)}&_ts=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) throw new Error("GET failed");
      const json = await res.json();
      mem[key] = json.value ?? fallback;
      return mem[key];
    }catch(e){
      // 서버가 잠깐 죽었을 때는 안전하게 fallback
      try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch{ return fallback; }
    }
  }



  async function apiDel(key){
    delete mem[key];
    if(useLocalFallback){
      localStorage.removeItem(key);
      return;
    }
    try{
      await fetch(`${API_BASE}/kv/set`, {
        method: "DELETE",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ key })
      });
    }
    catch(e){
      throw e;
    }
  }

  // ==== Domain constants ====
  const TYPE_LABEL = {
    DOMESTIC: "국내",
    INTERNATIONAL: "국제",
    ECONOMY_CVS: "반값택배",
    RETURN: "반품"
  };

  const KIND_LABEL = {
    DOCUMENT: "서류",
    SMALL_BOX: "소형 박스",
    MEDIUM_BOX: "중형 박스",
    LARGE_BOX: "대형 박스",
    FRAGILE: "파손주의",
    ETC: "기타"
  };

  function nowStr(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }


  function ensureEvents(rec){
    if(!rec.events || !Array.isArray(rec.events)) rec.events = [];
    return rec.events;
  }

  function pushEvent(rec, place, message, atOpt){
    const events = ensureEvents(rec);
    events.push({ at: atOpt || nowStr(), place: place || "-", message: message || "-" });
  }

  function renderEvents(rec){
    const events = (rec.events && Array.isArray(rec.events)) ? rec.events.slice().map(e => {
      const ee = Object.assign({}, e);
      if(!ee.at && ee.time) ee.at = ee.time;
      if(!ee.place && ee.location) ee.place = ee.location;
      return ee;
    }) : []; // legacy time/location 호환
    // If older records have no events, derive from known fields.
    if(events.length === 0){
      if(rec.storeAcceptedAt && rec.storeName) events.push({ at: rec.storeAcceptedAt, place: rec.storeName, message: "점포접수 하였습니다" });
      if(rec.pickedAt && rec.storeName) events.push({ at: rec.pickedAt, place: rec.storeName, message: "기사수거 하였습니다" });
      if(rec.collectionArrivedAt && rec.collectionCenterName) events.push({ at: rec.collectionArrivedAt, place: rec.collectionCenterName, message: "집화센터에 도착하였습니다" });
      if(rec.hubArrivedAt) events.push({ at: rec.hubArrivedAt, place: (rec.hubName || "강남허브센터"), message: "허브센터 도착했습니다" });
      if(rec.outboundPrepAt && rec.outboundCenterName) events.push({ at: rec.outboundPrepAt, place: rec.outboundCenterName, message: "출고센터 배송준비중입니다" });
      if(rec.storeDepartedAt) events.push({ at: rec.storeDepartedAt, place: rec.destStoreName || rec.storeName || "-", message: "점포출발 했습니다" });
      if(rec.arrivedAt) events.push({ at: rec.arrivedAt, place: rec.destStoreName || rec.storeName || "-", message: "점포도착하였습니다" });
      if(rec.deliveredAt) events.push({ at: rec.deliveredAt, place: rec.destStoreName || rec.storeName || "-", message: "고객에게 전달하였습니다" });
    }
    // sort by time string if possible
    events.sort((a,b) => String(a.at||"").localeCompare(String(b.at||"")));
    return events;
  }

  function makeReserveNo(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const rand = Math.random().toString(36).slice(2,7).toUpperCase();
    return `RSV-${y}${m}${day}-${rand}`;
  }

  function makeWaybill(prefix2){
    const prefix = String(prefix2 || "").slice(0,2);
    const restLen = 18 - prefix.length;
    if(restLen <= 0) return prefix;
    let digits = "";
    if(window.crypto && crypto.getRandomValues){
      const buf = new Uint8Array(restLen);
      crypto.getRandomValues(buf);
      for(let i=0;i<restLen;i++) digits += String(buf[i] % 10);
    }else{
      for(let i=0;i<restLen;i++) digits += String(Math.floor(Math.random()*10));
    }
    if(/^0+$/.test(digits)) digits = digits.slice(0,-1) + "1";
    return prefix + digits;
  }

  function openLabelFromRecord(rec){
    const wb = String(rec?.waybillNo || "").replace(/[^0-9]/g,"");
    if(!wb) return;
    let url = `./label.html?waybill=${encodeURIComponent(wb)}`;
    try{
      const payload = {
        waybillNo: wb,
        type: rec?.type || "",
        storeName: rec?.storeName || rec?.issuedStore?.name || "",
        destStoreName: rec?.destStoreName || "",
        addr: rec?.addr || rec?.receiver?.address || "",
        weightKg: rec?.package?.weightKg ?? rec?.package?.weight ?? "",
        kind: rec?.package?.kind || rec?.package?.kindLabel || "",
        memo: rec?.memo || "",
        originalWaybillNo: rec?.originalWaybillNo || ""
      };
      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
      url += `&payload=${b64}`;
    }catch(e){}
    window.open(url, "_blank");
  }

  function openUnshippableModal({title, onSubmit}){
    const overlay = document.createElement("div");
    overlay.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:16px; z-index:9999;";
    overlay.innerHTML = `
      <div class="card" style="width:min(520px, 96vw);">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
          <div style="font-weight:900;">${escapeHtml(title || "배송불가(반송)")}</div>
          <button class="btn" type="button" id="__unClose">닫기</button>
        </div>
        <div style="height:10px;"></div>
        <div class="row" style="grid-template-columns: 1fr;">
          <div>
            <label>사유</label>
            <select id="__unReasonSel">
              <option value="규격초과">규격초과</option>
              <option value="무게불일치">무게불일치</option>
              <option value="포장불량">포장불량</option>
              <option value="금지품목">금지품목</option>
              <option value="주소불명">주소불명</option>
              <option value="기타">기타(직접입력)</option>
            </select>
          </div>
          <div>
            <label>직접 입력(선택)</label>
            <input id="__unReasonTxt" placeholder="예: 규격초과(가로 120cm)" />
          </div>
        </div>
        <div class="actions" style="margin-top:10px;">
          <button class="btn bad" type="button" id="__unGo">배송불가 처리 + 반송운송장 발급</button>
        </div>
        <div class="hint">• 처리하면 원송장 이력에 <b>허브터미널/허브센터</b> 기준으로 “반송접수 하였습니다(사유: ... )”가 추가되고, <b>반송운송장(37..)</b>이 발급돼.</div>
      </div>
    `;
    document.body.appendChild(overlay);
    const close = () => overlay.remove();
    overlay.addEventListener("click", (e) => { if(e.target === overlay) close(); });
    overlay.querySelector("#__unClose").onclick = close;
    overlay.querySelector("#__unGo").onclick = () => {
      const sel = overlay.querySelector("#__unReasonSel").value;
      const txt = overlay.querySelector("#__unReasonTxt").value.trim();
      const reason = (sel === "기타") ? (txt || "기타") : (txt ? `${sel} - ${txt}` : sel);
      try{ onSubmit && onSubmit(reason); }catch(e){}
      close();
    };
  }



  // ==== Session (local only) ====
  function loadSession(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEYS.SESSION) || "{}"); } catch { return {}; }
  }
  function saveSession(obj){
    localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify(obj));
  }

  // ==== Reservations (persistent) ====
  async function getReservations(){ return await apiGetFresh(STORAGE_KEYS.RES, []); }
  async function setReservations(arr){ await apiSet(STORAGE_KEYS.RES, arr); }

  async function upsertRes(rec){
    const arr = await getReservations();
    const idx = arr.findIndex(x => x.reserveNo === rec.reserveNo);
    if(idx >= 0) arr[idx] = rec; else arr.unshift(rec);
    await setReservations(arr);
  }

  async function findByWaybill(waybill){
    const wb = String(waybill||"").replace(/[^0-9]/g,"");
    if(!wb) return null;
    const arr = await getReservations();
    return arr.find(x => x.waybillNo === waybill) || null;
  }

  function statusLabel(rec){
    const s = rec.status || "";
    if(s === "RESERVED") return "예약";
    if(s === "WAYBILL_ISSUED") return "운송장발급";
    if(s === "FINAL") return "점포접수";
    if(s === "PICKED_UP") return "기사수거";

    // 반값택배(편의점)
    if(s === "ARRIVED_COLLECTION_CENTER") return "집화센터도착";
    if(s === "ARRIVED_HUB") return "허브센터도착";
    if(s === "OUTBOUND_PREP") return "출고준비";
    if(s === "STORE_DEPARTED") return "점포출발";
    if(s === "ARRIVED_STORE") return "점포도착";
    if(s === "DELIVERED_TO_CUSTOMER") return "고객전달완료";

    // 국내/국제/반품 흐름(터미널)
    if(s === "ARRIVED_SUB_TERMINAL") return "서브터미널도착";
    if(s === "DEPARTED_SUB_TERMINAL") return "서브터미널출발";
    if(s === "ARRIVED_HUB_TERMINAL") return "허브터미널도착";
    if(s === "DEPARTED_HUB_TERMINAL") return "허브터미널출발";
    if(s === "ARRIVED_DEST_TERMINAL") return "배송지터미널도착";
    if(s === "DELIVERY_STARTED") return "배송출발";
    if(s === "DELIVERED") return "배송완료";

    // 국제 항공
    if(s === "AIRLINE_PREP") return "항공준비";
    if(s === "AIRLINE_DEPARTED") return "항공출발";
    if(s === "COUNTRY_ARRIVED") return "국가도착";
    if(s === "DELIVERED_ADDRESS") return "주소지배송완료";

    return s || "-";
  }

  function pkgSummary(rec){
    const addr = rec.addr ? rec.addr : "-";
    const w = (rec.package && typeof rec.package.weightKg === "number") ? rec.package.weightKg : (rec.package?.weightKg || "-");
    const kindKey = rec.package?.kind || "";
    const kind = kindKey ? (KIND_LABEL[kindKey] || kindKey) : "-";
    const country = rec.package?.country ? rec.package.country : "";
    return { addr, w, kind, country };
  }

  function detailText(rec){
    const p = pkgSummary(rec);
    let t = "";
    t += `주소: ${p.addr}\n`;
    t += `무게(kg): ${p.w}\n`;
    t += `종류: ${p.kind}\n`;
    if(rec.type === "INTERNATIONAL"){
      t += `국가: ${p.country || "-"}\n`;
    }
    return t.trim();
  }

  function tick(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    $("clock").textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  setInterval(tick, 1000); tick();

  // Navigation
  function show(view){
    ["home","customer","store","courier"].forEach(id => $(id).style.display = "none");
    $(view).style.display = "";
    if(view === "store") renderStoreLists();
    if(view === "courier") renderCourierLists();
  }
  document.querySelectorAll("[data-home]").forEach(b => b.onclick = () => show("home"));

  $("goCustomer").onclick = () => { show("customer"); };
  $("goKiosk").onclick = () => { window.location.href = "./kiosk.html"; };
  $("goStore").onclick = () => { show("store"); hydrateStoreSession(); };
  $("goCourier").onclick = () => { show("courier"); hydrateCourierSession(); };
  $("goTracking").onclick = () => { window.location.href = "./tracking.html"; };
  $("custGoTracking").onclick = () => { window.location.href = "./tracking.html"; };

  // ---------- CUSTOMER: tabs ----------
  function setCustTab(which){
    // Customer 화면에서는 예약만 사용 (배송조회는 tracking.html로 분리)
    $("custReserveCard").style.display = "";
    $("custReserveResult").style.display = "none";
  }
  $("tabReserve").onclick = () => setCustTab("reserve");
// CUSTOMER: type-specific UI
  function updateCustomerTypeUI(){
    const type = $("c_type").value;
    $("c_overseasWrap").style.display = (type === "INTERNATIONAL") ? "" : "none";
    $("c_economyHint").style.display = (type === "ECONOMY_CVS") ? "" : "none";
    $("c_storePickWrap").style.display = (type === "ECONOMY_CVS") ? "" : "none";
    $("c_returnOrigWrap").style.display = (type === "RETURN") ? "" : "none";
    if(type !== "RETURN") $("c_origWaybill").value = "";

    // label / placeholder
    $("c_addrLabel").textContent = (type === "ECONOMY_CVS") ? "추가 메모/상세주소(선택)" : "주소(필수)";
    $("c_addr").placeholder = (type === "ECONOMY_CVS") ? "예: (선택) 상세주소/비고" : "예: 배송지 주소";

    if(type !== "ECONOMY_CVS"){
      $("c_destStoreName").value = "";
      $("c_destStoreCode").value = "";
    }
  }
  $("c_type").onchange = updateCustomerTypeUI;
  updateCustomerTypeUI();

  // CUSTOMER: store picker (반값택배 도착 점포 선택)
  async function openStorePicker(){
    const modal = $("storePickerModal");
    const list = $("storePickerList");
    list.innerHTML = `<div class="item"><div style="color:var(--muted)">불러오는 중...</div></div>`;
    modal.style.display = "flex";

    const stores = await getStores();
    if(!stores || stores.length === 0){
      list.innerHTML = `<div class="item"><div class="err">등록된 점포가 없어. (점포 화면에서 점포등록 먼저!)</div></div>`;
      return;
    }

    // unique by code
    const uniq = [];
    const seen = new Set();
    stores.forEach(s => {
      if(!s || !s.code || seen.has(s.code)) return;
      seen.add(s.code);
      uniq.push(s);
    });
    uniq.sort((a,b) => String(a.name||"").localeCompare(String(b.name||"")));

    list.innerHTML = "";
    uniq.forEach(s => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div style="font-weight:800;">${escapeHtml(s.name || "-")}</div>
          <button class="btn" type="button">선택</button>
        </div>
      `;
      el.querySelector("button").onclick = () => {
        $("c_destStoreName").value = s.name || "";
        $("c_destStoreCode").value = s.code || "";
        closeStorePicker();
      };
      list.appendChild(el);
    });
  }

  function closeStorePicker(){
    $("storePickerModal").style.display = "none";
  }


  function normDigits(v){ return String(v ?? "").replace(/[^0-9]/g,""); }
  function normPhone(v){ return normDigits(v); }
  function normName(v){ return String(v ?? "").trim(); }

  async function searchWaybillsByPerson(name, phone){
    const n = normName(name);
    const p = normPhone(phone);
    if(!n || !p) return [];
    const list = await getReservations(); // fresh (apiGetFresh)
    return (list || []).filter(r => {
      const wb = normDigits(r?.waybillNo);
      if(!wb || wb.length !== 18) return false;
      if(String(r?.type||"") === "RETURN" || wb.startsWith("37")) return false;
      const s = r?.sender || {};
      const rc = r?.receiver || {};
      const sOk = normName(s.name).includes(n) && normPhone(s.phone).includes(p);
      const rOk = normName(rc.name).includes(n) && normPhone(rc.phone).includes(p);
      return sOk || rOk;
    }).slice(0, 50);
  }

  function openWaybillFinderModal({title, onPick}){
    const overlay = document.createElement("div");
    overlay.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:16px; z-index:9999;";
    overlay.innerHTML = `
      <div class="card" style="width:min(520px, 96vw);">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
          <div style="font-weight:900;">${escapeHtml(title || "운송장 찾기")}</div>
          <button class="btn" type="button" id="__wbClose">닫기</button>
        </div>
        <div style="height:10px;"></div>
        <div class="row" style="grid-template-columns: 1fr 1fr;">
          <div>
            <label>이름</label>
            <input id="__wbName" placeholder="예: 홍길동" />
          </div>
          <div>
            <label>전화번호</label>
            <input id="__wbPhone" class="mono" placeholder="숫자만 (예: 01012345678)" />
          </div>
        </div>
        <div class="actions" style="margin-top:10px;">
          <button class="btn primary" type="button" id="__wbSearch">조회</button>
        </div>
        <div style="height:10px;"></div>
        <div id="__wbList" class="list" style="max-height: 320px; overflow:auto;"></div>
        <div class="hint">• 조회 결과에서 운송장을 선택하면 자동 입력돼. (반송 운송장은 제외)</div>
      </div>
    `;
    document.body.appendChild(overlay);

    const close = () => { overlay.remove(); };
    overlay.addEventListener("click", (e) => { if(e.target === overlay) close(); });
    overlay.querySelector("#__wbClose").onclick = close;

    const listEl = overlay.querySelector("#__wbList");
    const render = (items) => {
      if(!items || items.length === 0){
        listEl.innerHTML = `<div class="item"><div style="color:var(--muted)">결과 없음</div></div>`;
        return;
      }
      listEl.innerHTML = items.map((r, i) => {
        const wb = escapeHtml(String(r.waybillNo||"-"));
        const t = escapeHtml(TYPE_LABEL[r.type] || r.type || "-");
        const s = escapeHtml((r.sender?.name||"-"));
        const rc = escapeHtml((r.receiver?.name||"-"));
        const at = escapeHtml((r.waybillIssuedAt || r.createdAt || "-"));
        return `
          <div class="item" style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
            <div>
              <div class="mono" style="font-weight:900;">${wb}</div>
              <div class="sub">${t} · ${s} → ${rc}</div>
              <div class="mono" style="font-size:12px; color:var(--muted);">${at}</div>
            </div>
            <div>
              <button class="btn" type="button" data-pick="${i}">선택</button>
            </div>
          </div>
        `;
      }).join("");
      listEl.querySelectorAll("button[data-pick]").forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.dataset.pick);
          const hit = items[idx];
          try{ onPick && onPick(hit); }catch(e){}
          close();
        };
      });
    };

    const doSearch = async () => {
      const name = overlay.querySelector("#__wbName").value;
      const phone = overlay.querySelector("#__wbPhone").value;
      listEl.innerHTML = `<div class="item"><div style="color:var(--muted)">조회 중...</div></div>`;
      try{
        const items = await searchWaybillsByPerson(name, phone);
        render(items);
      }catch(e){
        listEl.innerHTML = `<div class="item"><div class="err">조회 실패: ${escapeHtml(String(e?.message||e))}</div></div>`;
      }
    };

    overlay.querySelector("#__wbSearch").onclick = doSearch;
  }


  const __c_storeLookup = $("c_storeLookup");
  if(__c_storeLookup) __c_storeLookup.onclick = () => openStorePicker();
  const __c_origLookup = $("c_origLookup");
  if(__c_origLookup) __c_origLookup.onclick = () => openWaybillFinderModal({
    title: "원 운송장 찾기",
    onPick: (hit) => {
      $("c_origWaybill").value = String(hit.waybillNo || "").replace(/[^0-9]/g,"");
    }
  });

  const __storePickerClose = $("storePickerClose");
  if(__storePickerClose) __storePickerClose.onclick = () => closeStorePicker();
  const __storePickerModal = $("storePickerModal");
  if(__storePickerModal) __storePickerModal.addEventListener("click", (e) => {
    if(e.target && e.target.id === "storePickerModal") closeStorePicker();
  });

  function makePickupCode(){
    // 6 chars: A-Z0-9 (avoid confusing ones)
    const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
    let out = "";
    for(let i=0;i<6;i++){
      out += chars[Math.floor(Math.random()*chars.length)];
    }
    return out;
  }
// CUSTOMER: reserve
  $("c_reserveBtn").onclick = async () => {
    const type = $("c_type").value;
    const pickup = $("c_pickup").value;

    const sName = $("c_sName").value.trim();
    const sPhone = $("c_sPhone").value.trim();

    if(!sName || !sPhone){
      alert("보내는 사람 이름/연락처는 필수야!");
      return;
    }
    const rName = $("c_rName").value.trim();
    const rPhone = $("c_rPhone").value.trim();
    if(!rName || !rPhone){
      alert("받는 사람 이름/연락처도 필수야!");
      return;
    }
    let addr = $("c_addr").value.trim();
    let destStoreName = "";
    let destStoreCode = "";
    if(type === "ECONOMY_CVS"){
      destStoreName = $("c_destStoreName").value.trim();
      destStoreCode = $("c_destStoreCode").value.trim();
      if(!destStoreCode || !destStoreName){
        alert("반값택배는 점포조회로 도착 점포를 선택해야 해!");
        return;
      }
      // 기본 주소는 선택한 점포명. c_addr은 선택(상세메모)
      addr = destStoreName + (addr ? ` / ${addr}` : "");
    }else{
      if(!addr){
        alert("주소는 필수야!");
        return;
      }
    }

    if(type==="INTERNATIONAL"){
      const ov = $("c_overseas").value.trim();
      if(!ov){ alert("국제택배는 해외주소가 필수야!"); return; }
    }

    if(type==="RETURN"){
      const ow = normDigits($("c_origWaybill").value);
      if(!ow){ alert("반품은 원 운송장 번호가 필수야! (조회로 선택 가능)"); return; }
      if(!/^\d{18}$/.test(ow) || ow.startsWith("37")){
        alert("원 운송장 번호 형식이 이상해! (81/23/30로 시작하는 18자리)");
        return;
      }
      const hit = await findByWaybill(ow);
      if(!hit){
        const ok = confirm("서버에서 이 원 운송장을 찾지 못했어. (다른 시스템 송장일 수 있어) 그래도 계속할까?");
        if(!ok) return;
      }
      $("c_origWaybill").value = ow;
    }


    const rec = {
      reserveNo: makeReserveNo(),
      type,
      pickup,
      createdAt: nowStr(),
      status: "RESERVED",
      waybillNo: "",
      waybillIssuedAt: "",
      storeName: "",
      storeAcceptedAt: "",
      courier: { code:"", name:"", phone:"" },
      pickedAt: "",
      sender: { name:sName, phone:sPhone },
      receiver: { name: rName, phone: rPhone },
      addr: addr,
      destStoreName: (type==="ECONOMY_CVS") ? destStoreName : "",
      destStoreCode: (type==="ECONOMY_CVS") ? destStoreCode : "",
      // 배송 단계 기록
      collectionCenterName: "",
      collectionArrivedAt: "",
      hubName: "",
      hubArrivedAt: "",
      outboundCenterName: "",
      outboundPrepAt: "",
      storeDepartedAt: "",
      events: [],
      overseasAddr: ($("c_type").value === "INTERNATIONAL") ? ($("c_overseas").value.trim()) : "",
      originalWaybillNo: ($("c_type").value === "RETURN") ? normDigits($("c_origWaybill").value) : "",
      arrivedAt: "",
      pickupCode: "",
      deliveredAt: "",
      memo: $("c_memo").value.trim(),
    };

    await upsertRes(rec);

    $("custReserveResult").style.display = "";
    $("custReserveResult").innerHTML = `
      <div class="ok">예약 완료</div>
      <div class="sub">키오스크에서 예약접수/현장접수로 운송장 발급</div>
      <div style="height:10px;"></div>
      <div class="mono" style="white-space:pre-wrap; line-height:1.45;">
예약번호: ${escapeHtml(rec.reserveNo)}
유형: ${escapeHtml(TYPE_LABEL[rec.type])}
상태: RESERVED
      </div>
      <div class="hint">• kiosk.html에서 “예약접수”로 운송장(18자리)을 발급해.</div>
    `;
  };

  
  // STORE: tracking (실시간)
  $("s_trackSearch")?.addEventListener("click", async () => {
    const wb = ($("s_trackWaybill")?.value || "").trim();
    if(!wb){ alert("운송장 번호를 입력해줘!"); return; }
    const rec = await findByWaybill(wb);
    $("s_trackResult").style.display = "";
    if(!rec){
      $("s_trackResult").innerHTML = `<div class="err">등록된 운송장이 아님</div>`;
      return;
    }
    const p = pkgSummary(rec);
    const events = renderEvents(rec);
    const historyHtml = events.map(e => `
      <div class="item">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div style="font-weight:800;">${escapeHtml(e.place || "-")} ${escapeHtml(e.message || "-")}</div>
          <div class="mono" style="color:var(--muted); font-size:12px;">${escapeHtml(e.at || "-")}</div>
        </div>
      </div>
    `).join("");

    $("s_trackResult").innerHTML = `
      <div class="ok">조회 성공</div>
      <div class="mono" style="margin-top:8px; white-space:pre-wrap; line-height:1.45;">
운송장: ${escapeHtml(rec.waybillNo)}
유형: ${escapeHtml(TYPE_LABEL[rec.type] || rec.type)}
상태: ${escapeHtml(statusLabel(rec))}
접수지점: ${escapeHtml(rec.storeName || "-")}
도착점포: ${escapeHtml(rec.destStoreName || "-")}
주소/비고: ${escapeHtml(p.addr)}
무게(kg): ${escapeHtml(p.w)}
종류: ${escapeHtml(p.kind)}${rec.type==="INTERNATIONAL" ? `\n국가: ${escapeHtml(p.country || "-")}` : ""}
      </div>

      <div style="height:10px;"></div>
      <div style="font-weight:900; font-size:13px;">지금까지의 배송정보</div>
      <div class="list" style="margin-top:8px;">${historyHtml || `<div class="item"><div style="color:var(--muted)">히스토리가 없어.</div></div>`}</div>
    `;
  });


  // ---------- STORE: register/login/session ----------
  async function getStores(){ return await apiGet(STORAGE_KEYS.STORES, []); }
  async function saveStores(arr){ await apiSet(STORAGE_KEYS.STORES, arr); }

  async function storeExists(name, code){
    const list = await getStores();
    return list.find(s => s.name === name && s.code === code) || null;
  }

  async function hydrateStoreSession(){
    const sess = loadSession();
    if(sess.store?.name && sess.store?.code && await storeExists(sess.store.name, sess.store.code)){
      $("storeAuth").style.display = "none";
      $("storeDash").style.display = "";
      $("storeListCard").style.display = "";
      $("s_who").textContent = `로그인: ${sess.store.name} (${sess.store.code})`;
      renderStoreLists();
    }else{
      $("storeAuth").style.display = "";
      $("storeDash").style.display = "none";
      $("storeListCard").style.display = "none";
      $("s_authResult").style.display = "none";
    }
  }

  $("s_register").onclick = async () => {
    const name = $("s_name").value.trim();
    const code = $("s_code").value.trim();
    if(!name || !code){
      alert("점포명/점포코드를 입력해줘!");
      return;
    }
    const stores = await getStores();
    const dup = stores.find(s => s.code === code);
    if(dup){
      $("s_authResult").style.display = "";
      $("s_authResult").innerHTML = `<div class="err">이미 존재하는 점포코드야.</div>`;
      return;
    }
    stores.push({ name, code, createdAt: nowStr() });
    await saveStores(stores);
    $("s_authResult").style.display = "";
    $("s_authResult").innerHTML = `<div class="ok">점포 등록 완료</div><div class="hint">이제 로그인 버튼을 눌러.</div>`;
  };

  $("s_login").onclick = async () => {
    const name = $("s_name").value.trim();
    const code = $("s_code").value.trim();
    if(!name || !code){
      alert("점포명/점포코드를 입력해줘!");
      return;
    }
    const store = await storeExists(name, code);
    $("s_authResult").style.display = "";
    if(!store){
      $("s_authResult").innerHTML = `<div class="err">없는 점포입니다.</div>`;
      return;
    }
    const sess = loadSession();
    sess.store = { name, code };
    saveSession(sess);
    $("s_authResult").innerHTML = `<div class="ok">로그인 성공</div>`;
    void hydrateStoreSession();
};

  $("s_logout").onclick = () => {
    const sess = loadSession();
    delete sess.store;
    saveSession(sess);
    void hydrateStoreSession();
};

  // Store list (WAYBILL_ISSUED only)
  async function renderStoreLists(){
    const sess = loadSession();
    if(!sess.store) return;

    const arr = (await getReservations())
      .filter(x => x.waybillNo && x.status === "WAYBILL_ISSUED")
      .filter(x => matchRec(x, __storeSearchQ))
      .slice(0, 50);

    const box = $("s_list");
    box.innerHTML = "";
    if(arr.length === 0){
      box.innerHTML = `<div class="item"><div style="color:var(--muted)">접수대기 내역이 없어.</div></div>`;
      return;
    }
    arr.forEach(r => {
      const p = pkgSummary(r);
      const detailLine = `주소: ${p.addr} · 무게: ${p.w}kg · 종류: ${p.kind}` + (r.type==="INTERNATIONAL" ? ` · 국가: ${p.country || "-"}` : "");
      box.innerHTML += `
        <div class="item" data-wb="${escapeAttr(r.waybillNo)}">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <span class="tag mono">${escapeHtml(r.waybillNo)}</span>
            <span class="tag">${escapeHtml(TYPE_LABEL[r.type])} · ${escapeHtml(statusLabel(r))}</span>
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            예약번호: <span class="mono">${escapeHtml(r.reserveNo)}</span> · 발급: ${escapeHtml(r.waybillIssuedAt || "-")}
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            ${escapeHtml(detailLine)}
          </div>
          <div class="hint">클릭하면 이 운송장을 점포 접수(최종접수)함</div>
        </div>
      `;
    });
    box.querySelectorAll(".item").forEach(el => {
      el.onclick = () => {
        const wb = el.dataset.wb;
        $("s_waybill").value = wb;
        storeAcceptWaybill(true);
      };
    });
  }

  async function storeAcceptWaybill(askConfirm=false){
    const sess = loadSession();
    if(!sess.store) return;

    const wb = $("s_waybill").value.trim();
    if(!wb){
      alert("운송장 번호를 입력해줘!");
      return;
    }
    const rec = await findByWaybill(wb);
    $("s_acceptResult").style.display = "";
    if(!rec){
      $("s_acceptResult").innerHTML = `<div class="err">등록된 운송장이 아님</div>`;
      return;
    }
    if(rec.status !== "WAYBILL_ISSUED"){
      $("s_acceptResult").innerHTML = `<div class="err">점포 접수 가능한 상태가 아님 (현재: ${escapeHtml(rec.status)})</div>`;
      return;
    }

    if(askConfirm){
      const msg =
`점포 접수(최종접수) 할까?

운송장: ${rec.waybillNo}
유형: ${TYPE_LABEL[rec.type]}
${detailText(rec)}
`;
      if(!confirm(msg)) return;
    }

    rec.status = "FINAL";
    rec.storeName = sess.store.name;
    rec.storeAcceptedAt = nowStr();
    pushEvent(rec, sess.store.name, "점포접수 하였습니다", rec.storeAcceptedAt);
    showToast(`${rec.waybillNo} 점포접수 완료`, "점포", "good");
    await upsertRes(rec);

    const p = pkgSummary(rec);

    $("s_acceptResult").innerHTML = `
      <div class="ok">점포 접수 완료</div>
      <div class="mono" style="margin-top:8px; white-space:pre-wrap; line-height:1.45;">
운송장: ${escapeHtml(rec.waybillNo)}
점포: ${escapeHtml(rec.storeName)}
주소: ${escapeHtml(p.addr)}
무게(kg): ${escapeHtml(p.w)}
종류: ${escapeHtml(p.kind)}
${rec.type==="INTERNATIONAL" ? `국가: ${escapeHtml(p.country || "-")}\n` : ""}상태: FINAL
      </div>
      <div class="hint">• 이제 기사 화면에 이 건이 표시돼.</div>
    `;
    renderStoreLists();
  }

  // store mode
  let storeMode = "ACCEPT"; // ACCEPT / INBOUND / HANDOVER
  function updateStoreModeUI(){
    $("s_mode_accept").classList.toggle("primary", storeMode==="ACCEPT");
    $("s_mode_inbound").classList.toggle("primary", storeMode==="INBOUND");
    $("s_mode_handover").classList.toggle("primary", storeMode==="HANDOVER");
    $("s_acceptWrap").style.display = (storeMode==="ACCEPT") ? "" : "none";
    $("s_inboundWrap").style.display = (storeMode==="INBOUND") ? "" : "none";
    $("s_handoverWrap").style.display = (storeMode==="HANDOVER") ? "" : "none";
  }
  $("s_mode_accept").onclick = () => { storeMode="ACCEPT"; updateStoreModeUI(); };
  $("s_mode_inbound").onclick = () => { storeMode="INBOUND"; updateStoreModeUI(); };
  $("s_mode_handover").onclick = () => { storeMode="HANDOVER"; updateStoreModeUI(); };
  updateStoreModeUI();

  async function storeInbound(){
    const sess = loadSession();
    if(!sess.store) return;
    const wb = $("s_in_waybill").value.trim();
    $("s_inboundResult").style.display = "";
    if(!wb){ alert("운송장 번호를 입력해줘!"); return; }
    const rec = await findByWaybill(wb);
    if(!rec){ $("s_inboundResult").innerHTML = `<div class="err">등록된 운송장이 아님</div>`; return; }
    if(rec.type !== "ECONOMY_CVS"){ $("s_inboundResult").innerHTML = `<div class="err">반값택배만 입고 처리 가능해!</div>`; return; }
    if(rec.destStoreCode && rec.destStoreCode !== sess.store.code){ $("s_inboundResult").innerHTML = `<div class="err">이 운송장은 이 점포로 도착하는 건이 아니야.</div>`; return; }
    // allow FINAL or PICKED_UP 등, 입고는 반값택배 흐름상 중간/후반 단계
    rec.status = "ARRIVED_STORE";
    rec.arrivedStoreName = sess.store.name;
    rec.arrivedStoreCode = sess.store.code;
    rec.arrivedAt = nowStr();
    rec.pickupCode = rec.pickupCode || makePickupCode();
    pushEvent(rec, sess.store.name, "점포도착하였습니다", rec.arrivedAt);
    await upsertRes(rec);
    showToast(`${rec.waybillNo} 입고 완료`, "점포", "good");
    $("s_inboundResult").innerHTML = `<div class="ok">입고 완료</div><div class="mono" style="margin-top:8px;">운송장: ${escapeHtml(rec.waybillNo)}\n고유번호: ${escapeHtml(rec.pickupCode)}</div>`;
  }

  async function storeHandover(){
    const sess = loadSession();
    if(!sess.store) return;
    const wb = $("s_h_waybill").value.trim();
    const code = $("s_pickupCode").value.trim().toUpperCase();
    $("s_handoverResult").style.display = "";
    if(!wb || !code){ alert("운송장/고유번호 둘 다 입력해줘!"); return; }
    const rec = await findByWaybill(wb);
    if(!rec){ $("s_handoverResult").innerHTML = `<div class="err">등록된 운송장이 아님</div>`; return; }
    if(rec.type !== "ECONOMY_CVS"){ $("s_handoverResult").innerHTML = `<div class="err">반값택배만 고객전달 가능해!</div>`; return; }
    if(rec.status !== "ARRIVED_STORE"){ $("s_handoverResult").innerHTML = `<div class="err">입고(ARRIVED_STORE) 상태가 아니야.</div>`; return; }
    if(((rec.arrivedStoreCode || rec.destStoreCode || "") !== sess.store.code)){ $("s_handoverResult").innerHTML = `<div class="err">이 점포로 입고된 건이 아냐.</div>`; return; }
    if((rec.pickupCode || "").toUpperCase() !== code){ $("s_handoverResult").innerHTML = `<div class="err">고유번호가 달라!</div>`; return; }

    rec.status = "DELIVERED_TO_CUSTOMER";
    rec.deliveredAt = nowStr();
    pushEvent(rec, sess.store.name, "고객에게 전달하였습니다", rec.deliveredAt);
    await upsertRes(rec);

    showToast(`${rec.waybillNo} 고객전달 완료`, "점포", "good");
    $("s_handoverResult").innerHTML = `<div class="ok">고객전달 완료</div><div class="mono" style="margin-top:8px;">운송장: ${escapeHtml(rec.waybillNo)}\n완료: ${escapeHtml(rec.deliveredAt)}</div>`;
  }

  $("s_inbound").onclick = storeInbound;
  $("s_handover").onclick = storeHandover;

  $("s_accept").onclick = () => storeAcceptWaybill(false);
  $("s_refresh").onclick = renderStoreLists;
  $("s_search_btn").onclick = () => { __storeSearchQ = $("s_search").value.trim(); renderStoreLists(); };
  $("s_search_clear").onclick = () => { $("s_search").value = ""; __storeSearchQ = ""; renderStoreLists(); };
  try{ $("s_search").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("s_search_btn").click(); }); }catch(e){}



  // courier mode (DOMESTIC / ECONOMY_CVS)
  var courierMode = "DOMESTIC";
  function updateCourierModeUI(){
    $("c_mode_domestic").classList.toggle("primary", courierMode==="DOMESTIC");
    $("c_mode_intl").classList.toggle("primary", courierMode==="INTERNATIONAL");
    $("c_mode_economy").classList.toggle("primary", courierMode==="ECONOMY_CVS");
    $("c_mode_domestic").classList.toggle("btn", true);
    $("c_mode_intl").classList.toggle("btn", true);
    $("c_mode_economy").classList.toggle("btn", true);

    const showDomestic = (courierMode==="DOMESTIC" || courierMode==="INTERNATIONAL");
    if($("c_domesticOps")) $("c_domesticOps").style.display = showDomestic ? "" : "none";
    if($("c_intlOps")) $("c_intlOps").style.display = (courierMode==="INTERNATIONAL") ? "" : "none";
    // 관리 버튼 표시(요청: 국내=터미널, 반값=센터, 국제=터미널+항공사)
    if($("c_manage_terminal")) $("c_manage_terminal").style.display = ((courierMode==="DOMESTIC" || courierMode==="INTERNATIONAL") ? "" : "none");
    if($("c_manage_center")) $("c_manage_center").style.display = (courierMode==="ECONOMY_CVS" ? "" : "none");
    if($("c_manage_airline")) $("c_manage_airline").style.display = (courierMode==="INTERNATIONAL" ? "" : "none");
    if($("c_economyOps")) $("c_economyOps").style.display = (courierMode==="ECONOMY_CVS") ? "" : "none";
  }
  $("c_mode_domestic").onclick = () => { courierMode="DOMESTIC"; updateCourierModeUI(); void renderCourierLists(); };
  $("c_mode_intl").onclick = () => { courierMode="INTERNATIONAL"; updateCourierModeUI(); void renderCourierLists(); };
  $("c_mode_economy").onclick = () => { courierMode="ECONOMY_CVS"; updateCourierModeUI(); void renderCourierLists(); };

  updateCourierModeUI();

  // courier selected waybill
  let selectedWaybill = "";
  function setSelectedWaybill(wb){
    selectedWaybill = wb || "";
    if($("c_selectedWb")) $("c_selectedWb").textContent = selectedWaybill || "-";
  }
  setSelectedWaybill("");

  // Centers (KV)
  async function getCenters(){ return await apiGet(STORAGE_KEYS.CENTERS, []); }
  async function setCenters(arr){ await apiSet(STORAGE_KEYS.CENTERS, arr); }

  async function refreshCenterSelect(){
    const centers = (await getCenters()) || [];
    const sel = $("c_centerSelect");
    if(!sel) return;
    const safe = centers.filter(x => typeof x === "string" && x.trim());
    sel.innerHTML = safe.length
      ? safe.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("")
      : `<option value="">(센터 없음)</option>`;
  }

  $("c_addCenter")?.addEventListener("click", async () => {
    const name = ($("c_centerName")?.value || "").trim();
    if(!name){ alert("센터명을 입력해줘!"); return; }
    const centers = (await getCenters()) || [];
    if(!centers.includes(name)) centers.push(name);
    await setCenters(centers);
    $("c_centerName").value = "";
    await refreshCenterSelect();
    alert("센터 추가 완료!");
  });

  async function withSelectedRec(fn){
    if(!selectedWaybill){
      alert("운송장을 먼저 선택해줘!");
      return;
    }
    const rec = await findByWaybill(selectedWaybill);
    if(!rec){ alert("내역이 없어!"); return; }
    await fn(rec);
    await upsertRes(rec);
    await renderCourierLists();
  }

  // Economy: center status buttons
  
  const HUB_C = "강남허브센터";

  $("c_btn_unshippableC")?.addEventListener("click", async () => {
    const sess = loadSession();
    if(!sess.courier){ alert("기사 로그인 필요"); return; }
    if(!selectedWaybill){ alert("운송장을 먼저 선택해줘!"); return; }
    const rec = await findByWaybill(selectedWaybill);
    if(!rec){ alert("내역이 없어!"); return; }
    if(rec.type !== "ECONOMY_CVS"){ alert("반값택배(센터) 운송장만 여기서 처리해줘!"); return; }

    openUnshippableModal({
      title: "배송불가(반송) - 허브센터",
      onSubmit: async (reason) => {
        const hubPlace = (rec.hubName || HUB_C);
        pushEvent(rec, hubPlace, `반송접수 하였습니다(사유:${reason})`, nowStr());
        rec.returnBlocked = true;
        rec.returnReason = reason;
        rec.returnAt = nowStr();

        const rtn = {
          reserveNo: `RTN-${new Date().toISOString().slice(0,10).replace(/-/g,"")}-${Math.random().toString(36).slice(2,6).toUpperCase()}`,
          type: "RETURN",
          pickup: "STORE",
          createdAt: nowStr(),
          status: "WAYBILL_ISSUED",
          waybillNo: makeWaybill("37"),
          waybillIssuedAt: nowStr(),
          storeName: rec.storeName || "",
          storeAcceptedAt: "",
          courier: sess.courier ? { code: sess.courier.code||"", name: sess.courier.name||"", phone: sess.courier.phone||"" } : { code:"", name:"", phone:"" },
          pickedAt: "",
          sender: { name: rec.receiver?.name || "", phone: rec.receiver?.phone || "", address: rec.receiver?.address || "" },
          receiver: { name: rec.sender?.name || "", phone: rec.sender?.phone || "", address: rec.sender?.address || "" },
          addr: rec.sender?.address || rec.addr || "",
          destStoreName: "",
          destStoreCode: "",
          collectionCenterName: "",
          collectionArrivedAt: "",
          hubName: "",
          hubArrivedAt: "",
          outboundCenterName: "",
          outboundPrepAt: "",
          storeDepartedAt: "",
          arrivedAt: "",
          pickupCode: "",
          deliveredAt: "",
          subTerminalName: "",
          subTerminalArrivedAt: "",
          subTerminalDepartedAt: "",
          hubTerminalArrivedAt: "",
          hubTerminalDepartedAt: "",
          destTerminalName: "",
          destTerminalArrivedAt: "",
          deliveryStartAt: "",
          airlineName: "",
          airlinePrepAt: "",
          airDepartAt: "",
          countryArrivedAt: "",
          addrDeliveredAt: "",
          events: [],
          overseasAddr: "",
          memo: `반송 사유: ${reason}`,
          originalWaybillNo: String(rec.waybillNo || ""),
        };
        pushEvent(rtn, hubPlace, `반송운송장 발급 (원송장: ${String(rec.waybillNo||"-")})`, nowStr());
        rec.returnWaybillNo = rtn.waybillNo;

        await upsertRes(rec);
        await upsertRes(rtn);
        await renderCourierLists();

        const ok = confirm(`반송운송장 발급 완료!\n${rtn.waybillNo}\n\n지금 라벨 출력할까?`);
        if(ok) openLabelFromRecord(rtn);
      }
    });
  });

$("c_btn_collection")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(rec.status !== "PICKED_UP"){ alert("기사수거(PICKED_UP) 이후에 가능"); throw new Error("stop"); }
      const center = ($("c_centerSelect")?.value || "").trim();
      if(!center){ alert("센터를 먼저 추가/선택해줘!"); throw new Error("stop"); }
      rec.status = "ARRIVED_COLLECTION_CENTER";
      rec.collectionCenterName = center;
      rec.collectionArrivedAt = nowStr();
      pushEvent(rec, center, "집화센터에 도착하였습니다", rec.collectionArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_hub")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(!(rec.status === "ARRIVED_COLLECTION_CENTER" || rec.status === "PICKED_UP")){
        alert("집화센터도착 이후에 가능"); throw new Error("stop");
      }
      rec.status = "ARRIVED_HUB";
      rec.hubName = "강남허브센터";
      rec.hubArrivedAt = nowStr();
      pushEvent(rec, rec.hubName, "허브센터 도착했습니다", rec.hubArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_outbound")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(rec.status !== "ARRIVED_HUB"){ alert("허브센터 도착 이후에 가능"); throw new Error("stop"); }
      const center = ($("c_centerSelect")?.value || "").trim();
      if(!center){ alert("출고센터를 선택해줘!"); throw new Error("stop"); }
      rec.status = "OUTBOUND_PREP";
      rec.outboundCenterName = center;
      rec.outboundPrepAt = nowStr();
      pushEvent(rec, center, "출고센터 배송준비중입니다", rec.outboundPrepAt);
    }).catch(()=>{});
  });

  $("c_btn_storeDepart")?.addEventListener("click", async () => {
    await withSelectedRec(async (rec) => {
      if(rec.type !== "ECONOMY_CVS"){ alert("반값택배만 가능"); throw new Error("stop"); }
      if(rec.status !== "OUTBOUND_PREP"){ alert("출고준비 이후에 가능"); throw new Error("stop"); }
      const dest = rec.destStoreName || "-";
      rec.status = "STORE_DEPARTED";
      rec.storeDepartedAt = nowStr();
      pushEvent(rec, dest, "점포출발 했습니다", rec.storeDepartedAt);
    }).catch(()=>{});
  });

  // init center select
  refreshCenterSelect();

  // Terminals (KV) - 국내/국제/반품 기사 흐름
  async function getTerminals(){ return await apiGet(STORAGE_KEYS.TERMINALS, []); }
  async function setTerminals(arr){ await apiSet(STORAGE_KEYS.TERMINALS, arr); }

  async function refreshTerminalSelect(){
    const terms = (await getTerminals()) || [];
    const sel = $("c_terminalSelect");
    if(!sel) return;
    const safe = terms.filter(x => typeof x === "string" && x.trim());
    sel.innerHTML = safe.length
      ? safe.map(t => `<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`).join("")
      : `<option value="">(터미널 없음)</option>`;
  }

  $("c_addTerminal")?.addEventListener("click", async () => {
    const name = ($("c_terminalName")?.value || "").trim();
    if(!name){ alert("터미널명을 입력해줘!"); return; }
    const terms = (await getTerminals()) || [];
    if(!terms.includes(name)) terms.push(name);
    await setTerminals(terms);
    $("c_terminalName").value = "";
    await refreshTerminalSelect();
    alert("터미널 추가 완료!");
  });

  async function withSelectedRecDomestic(fn){
    const sess = loadSession();
    if(!sess.courier){ alert("기사 로그인 필요"); return; }
    if(!selectedWaybill){ alert("운송장을 먼저 선택해줘!"); return; }
    const rec = await findByWaybill(selectedWaybill);
    if(!rec){ alert("내역이 없어!"); return; }
    await fn(rec);
    await upsertRes(rec);
    await renderCourierLists();
  }

  const HUB_T = "강남허브터미널";

  $("c_btn_unshippableT")?.addEventListener("click", async () => {
    const sess = loadSession();
    if(!sess.courier){ alert("기사 로그인 필요"); return; }
    if(!selectedWaybill){ alert("운송장을 먼저 선택해줘!"); return; }
    const rec = await findByWaybill(selectedWaybill);
    if(!rec){ alert("내역이 없어!"); return; }
    if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 센터(반값) 영역에서 처리해줘!"); return; }

    openUnshippableModal({
      title: "배송불가(반송) - 허브터미널",
      onSubmit: async (reason) => {
        const hubPlace = HUB_T;
        pushEvent(rec, hubPlace, `반송접수 하였습니다(사유:${reason})`, nowStr());
        rec.returnBlocked = true;
        rec.returnReason = reason;
        rec.returnAt = nowStr();

        const rtn = {
          // 기본 필드
          reserveNo: `RTN-${new Date().toISOString().slice(0,10).replace(/-/g,"")}-${Math.random().toString(36).slice(2,6).toUpperCase()}`,
          type: "RETURN",
          pickup: "STORE",
          createdAt: nowStr(),
          status: "WAYBILL_ISSUED",
          waybillNo: makeWaybill("37"),
          waybillIssuedAt: nowStr(),
          storeName: rec.storeName || "",
          storeAcceptedAt: "",
          courier: sess.courier ? { code: sess.courier.code||"", name: sess.courier.name||"", phone: sess.courier.phone||"" } : { code:"", name:"", phone:"" },
          pickedAt: "",
          sender: { name: rec.receiver?.name || "", phone: rec.receiver?.phone || "", address: rec.receiver?.address || "" },
          receiver: { name: rec.sender?.name || "", phone: rec.sender?.phone || "", address: rec.sender?.address || "" },
          addr: rec.sender?.address || rec.addr || "",
          destStoreName: "",
          destStoreCode: "",
          // 단계 필드(빈값)
          collectionCenterName: "",
          collectionArrivedAt: "",
          hubName: "",
          hubArrivedAt: "",
          outboundCenterName: "",
          outboundPrepAt: "",
          storeDepartedAt: "",
          arrivedAt: "",
          pickupCode: "",
          deliveredAt: "",
          subTerminalName: "",
          subTerminalArrivedAt: "",
          subTerminalDepartedAt: "",
          hubTerminalArrivedAt: "",
          hubTerminalDepartedAt: "",
          destTerminalName: "",
          destTerminalArrivedAt: "",
          deliveryStartAt: "",
          airlineName: "",
          airlinePrepAt: "",
          airDepartAt: "",
          countryArrivedAt: "",
          addrDeliveredAt: "",
          events: [],
          overseasAddr: "",
          memo: `반송 사유: ${reason}`,
          originalWaybillNo: String(rec.waybillNo || ""),
        };
        pushEvent(rtn, hubPlace, `반송운송장 발급 (원송장: ${String(rec.waybillNo||"-")})`, nowStr());

        // 링크 저장
        rec.returnWaybillNo = rtn.waybillNo;

        await upsertRes(rec);
        await upsertRes(rtn);
        await renderCourierLists();

        // 출력
        const ok = confirm(`반송운송장 발급 완료!\n${rtn.waybillNo}\n\n지금 라벨 출력할까?`);
        if(ok) openLabelFromRecord(rtn);
      }
    });
  });



  $("c_btn_subArrive")?.addEventListener("click", async () => {
    await withSelectedRecDomestic(async (rec) => {
      if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 반값 기사 화면에서 처리해줘!"); throw new Error("stop"); }
      if(rec.status !== "PICKED_UP"){ alert("기사수거 이후에 가능"); throw new Error("stop"); }
      const term = ($("c_terminalSelect")?.value || "").trim();
      if(!term){ alert("터미널을 먼저 추가/선택해줘!"); throw new Error("stop"); }
      rec.status = "ARRIVED_SUB_TERMINAL";
      rec.subTerminalName = term;
      rec.subArrivedAt = nowStr();
      pushEvent(rec, term, "간선하차 하였습니다", rec.subArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_subDepart")?.addEventListener("click", async () => {
    await withSelectedRecDomestic(async (rec) => {
      if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 반값 기사 화면에서 처리해줘!"); throw new Error("stop"); }
      if(rec.status !== "ARRIVED_SUB_TERMINAL"){ alert("서브터미널 도착 이후에 가능"); throw new Error("stop"); }
      const term = rec.subTerminalName || ($("c_terminalSelect")?.value || "").trim();
      if(!term){ alert("터미널을 선택해줘!"); throw new Error("stop"); }
      rec.status = "DEPARTED_SUB_TERMINAL";
      rec.subDepartedAt = nowStr();
      pushEvent(rec, term, "간선상차 하였습니다", rec.subDepartedAt);
    }).catch(()=>{});
  });

  $("c_btn_hubArriveT")?.addEventListener("click", async () => {
    await withSelectedRecDomestic(async (rec) => {
      if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 반값 기사 화면에서 처리해줘!"); throw new Error("stop"); }
      if(!(rec.status === "DEPARTED_SUB_TERMINAL" || rec.status === "ARRIVED_SUB_TERMINAL")){ alert("서브터미널 출발 이후에 가능"); throw new Error("stop"); }
      rec.status = "ARRIVED_HUB_TERMINAL";
      rec.hubTerminalArrivedAt = nowStr();
      pushEvent(rec, HUB_T, "간선하차하였습니다", rec.hubTerminalArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_hubDepartT")?.addEventListener("click", async () => {
    await withSelectedRecDomestic(async (rec) => {
      if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 반값 기사 화면에서 처리해줘!"); throw new Error("stop"); }
      if(rec.status !== "ARRIVED_HUB_TERMINAL"){ alert("허브터미널 도착 이후에 가능"); throw new Error("stop"); }
      rec.status = "DEPARTED_HUB_TERMINAL";
      rec.hubTerminalDepartedAt = nowStr();
      pushEvent(rec, HUB_T, "간선상차하였습니다", rec.hubTerminalDepartedAt);
    }).catch(()=>{});
  });

  $("c_btn_destArrive")?.addEventListener("click", async () => {
    await withSelectedRecDomestic(async (rec) => {
      if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 반값 기사 화면에서 처리해줘!"); throw new Error("stop"); }
      if(rec.status != "DEPARTED_HUB_TERMINAL"){ alert("허브터미널 출발 이후에 가능"); throw new Error("stop"); }
      const term = ($("c_terminalSelect")?.value || "").trim();
      if(!term){ alert("배송지 터미널을 선택해줘!"); throw new Error("stop"); }
      rec.status = "ARRIVED_DEST_TERMINAL";
      rec.destTerminalName = term;
      rec.destTerminalArrivedAt = nowStr();
      pushEvent(rec, term, "간선하차하였습니다", rec.destTerminalArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_deliveryStart")?.addEventListener("click", async () => {
    await withSelectedRecDomestic(async (rec) => {
      if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 반값 기사 화면에서 처리해줘!"); throw new Error("stop"); }
      if(rec.type === "INTERNATIONAL"){ alert("국제택배는 항공 처리로 진행해줘!"); throw new Error("stop"); }
      if(rec.status !== "ARRIVED_DEST_TERMINAL"){ alert("배송지 터미널 도착 이후에 가능"); throw new Error("stop"); }
      const term = rec.destTerminalName || ($("c_terminalSelect")?.value || "").trim();
      if(!term){ alert("터미널을 선택해줘!"); throw new Error("stop"); }
      rec.status = "DELIVERY_STARTED";
      rec.deliveryStartedAt = nowStr();
      pushEvent(rec, term, "배송출발하였습니다", rec.deliveryStartedAt);
    }).catch(()=>{});
  });

  $("c_btn_delivered")?.addEventListener("click", async () => {
    await withSelectedRecDomestic(async (rec) => {
      if(rec.type === "ECONOMY_CVS"){ alert("반값택배는 반값 기사 화면에서 처리해줘!"); throw new Error("stop"); }
      if(rec.type === "INTERNATIONAL"){ alert("국제택배는 항공 처리로 진행해줘!"); throw new Error("stop"); }
      if(rec.status !== "DELIVERY_STARTED"){ alert("배송출발 이후에 가능"); throw new Error("stop"); }
      const sess = loadSession();
      const courier = await courierByCode(sess.courier.code);
      const term = rec.destTerminalName || ($("c_terminalSelect")?.value || "").trim() || "-";
      rec.status = "DELIVERED";
      rec.deliveredAt = nowStr();
      const who = courier ? `${courier.name} (${courier.phone || "-"})` : "기사정보없음";
      pushEvent(rec, term, `배송완료 하였습니다 담당기사:${who}`, rec.deliveredAt);
    }).catch(()=>{});
  });

  // init terminal select
  refreshTerminalSelect();

  // Airlines (KV) - 국제택배 기사 흐름
  async function getAirlines(){ return await apiGet(STORAGE_KEYS.AIRLINES, []); }
  async function setAirlines(arr){ await apiSet(STORAGE_KEYS.AIRLINES, arr); }

  async function refreshAirlineSelect(){
    const arr = (await getAirlines()) || [];
    const sel = $("c_airlineSelect");
    if(!sel) return;
    const safe = arr.filter(x => typeof x === "string" && x.trim());
    sel.innerHTML = safe.length
      ? safe.map(a => `<option value="${escapeAttr(a)}">${escapeHtml(a)}</option>`).join("")
      : `<option value="">(항공사 없음)</option>`;
  }

  $("c_addAirline")?.addEventListener("click", async () => {
    const name = ($("c_airlineName")?.value || "").trim();
    if(!name){ alert("항공사명을 입력해줘!"); return; }
    const arr = (await getAirlines()) || [];
    if(!arr.includes(name)) arr.push(name);
    await setAirlines(arr);
    $("c_airlineName").value = "";
    await refreshAirlineSelect();
    alert("항공사 추가 완료!");
  });

  async function withSelectedRecIntl(fn){
    if(!selectedWaybill){ alert("운송장을 먼저 선택해줘!"); return; }
    const rec = await findByWaybill(selectedWaybill);
    if(!rec){ alert("내역이 없어!"); return; }
    if(rec.type !== "INTERNATIONAL"){ alert("국제택배만 가능"); return; }
    await fn(rec);
    await upsertRes(rec);
    await renderCourierLists();
  }

  $("c_btn_airPrep")?.addEventListener("click", async () => {
    await withSelectedRecIntl(async (rec) => {
      if(rec.status !== "ARRIVED_DEST_TERMINAL"){ alert("배송지 터미널 도착 이후에 가능"); throw new Error("stop"); }
      const air = ($("c_airlineSelect")?.value || "").trim();
      if(!air){ alert("항공사를 먼저 추가/선택해줘!"); throw new Error("stop"); }
      rec.status = "AIRLINE_PREP";
      rec.airlineName = air;
      rec.airPrepAt = nowStr();
      pushEvent(rec, air, "비행기 이륙 준비중입니다", rec.airPrepAt);
    }).catch(()=>{});
  });

  $("c_btn_airDepart")?.addEventListener("click", async () => {
    await withSelectedRecIntl(async (rec) => {
      if(rec.status !== "AIRLINE_PREP"){ alert("비행기 이륙 준비 이후에 가능"); throw new Error("stop"); }
      const air = rec.airlineName || ($("c_airlineSelect")?.value || "").trim();
      if(!air){ alert("항공사를 선택해줘!"); throw new Error("stop"); }
      rec.status = "AIRLINE_DEPARTED";
      rec.airDepartAt = nowStr();
      pushEvent(rec, air, "출발하였습니다", rec.airDepartAt);
    }).catch(()=>{});
  });

  $("c_btn_countryArrive")?.addEventListener("click", async () => {
    await withSelectedRecIntl(async (rec) => {
      if(rec.status !== "AIRLINE_DEPARTED"){ alert("출발 이후에 가능"); throw new Error("stop"); }
      rec.status = "COUNTRY_ARRIVED";
      rec.countryArrivedAt = nowStr();
      const country = rec.country || (pkgSummary(rec).country || "도착국가");
      pushEvent(rec, country, "국가 도착하였습니다", rec.countryArrivedAt);
    }).catch(()=>{});
  });

  $("c_btn_addrDelivered")?.addEventListener("click", async () => {
    await withSelectedRecIntl(async (rec) => {
      if(rec.status !== "COUNTRY_ARRIVED"){ alert("국가 도착 이후에 가능"); throw new Error("stop"); }
      rec.status = "DELIVERED_ADDRESS";
      rec.addrDeliveredAt = nowStr();
      pushEvent(rec, rec.addr || "주소지", "주소지 배송완료되었습니다", rec.addrDeliveredAt);
    }).catch(()=>{});
  });

  refreshAirlineSelect();

  // ---------- COURIER: register/login/session ----------
  async function getCouriers(){ return await apiGet(STORAGE_KEYS.COURIERS, []); }
  async function saveCouriers(arr){ await apiSet(STORAGE_KEYS.COURIERS, arr); }

  async function courierByCode(code){
    const list = await getCouriers();
    return list.find(c => c.code === code) || null;
  }

  async function hydrateCourierSession(){
    const sess = loadSession();
    const code = sess.courier?.code || "";
    if(code){
      const c = await courierByCode(code);
      if(c){
        $("courierAuth").style.display = "none";
        $("courierDash").style.display = "";
        $("courierListCard").style.display = "";

        if(c.role){
          courierMode = c.role; // DOMESTIC / INTERNATIONAL / ECONOMY_CVS
          updateCourierModeUI();
        }

        const modeLabel = (courierMode==="ECONOMY_CVS") ? "반값택배 기사" : (courierMode==="INTERNATIONAL" ? "국제택배 기사" : "국내/반품 기사");
        $("c_who").textContent = `로그인: ${c.name} (${c.code}) · ${modeLabel}`;
        void renderCourierLists();
        return;
      }
    }

    // not logged in
    $("courierAuth").style.display = "";
    $("courierDash").style.display = "none";
    $("courierListCard").style.display = "none";
    $("c_authResult").style.display = "none";
  }

  $("c_register").onclick = async () => {
    const name = $("c_name").value.trim();
    const phone = $("c_phone").value.trim();
    const code = $("c_code").value.trim();
    const role = ($("c_role")?.value || "DOMESTIC");
    if(!name || !phone || !code){
      alert("기사명/전화/코드 다 입력해줘!");
      return;
    }
    const list = await getCouriers();
    if(list.find(x => x.code === code)){
      $("c_authResult").style.display = "";
      $("c_authResult").innerHTML = `<div class="err">이미 존재하는 기사코드야.</div>`;
      return;
    }
    list.push({ name, phone, code, role, createdAt: nowStr() });
    await saveCouriers(list);
    courierMode = role;
    updateCourierModeUI();
    $("c_authResult").style.display = "";
    $("c_authResult").innerHTML = `<div class="ok">기사 등록 완료</div><div class="hint">이제 코드로 로그인해.</div>`;
  };

  $("c_login").onclick = async () => {
    const code = $("c_code").value.trim();
    if(!code){
      alert("기사코드를 입력해줘!");
      return;
    }
    const c = await courierByCode(code);
    $("c_authResult").style.display = "";
    if(!c){
      $("c_authResult").innerHTML = `<div class="err">없는 기사입니다.</div>`;
      return;
    }

    const role = c.role || "DOMESTIC";
    if(role !== courierMode){
      if(role === "ECONOMY_CVS"){
        alert("반값택배 기사입니다. 반값택배 기사 화면으로 전환할게!");
      }else{
        alert("국내택배 기사입니다. 국내택배 기사 화면으로 전환할게!");
      }
      courierMode = role;
      updateCourierModeUI();
    }

    const sess = loadSession();
    sess.courier = { code };
    saveSession(sess);
    $("c_authResult").innerHTML = `<div class="ok">로그인 성공</div>`;
    void hydrateCourierSession();
};

  $("c_logout").onclick = () => {
    const sess = loadSession();
    delete sess.courier;
    saveSession(sess);
    void hydrateCourierSession();
};

  // ✅ FINAL 목록에 상세정보 표시 + 집화 확인창에 상세 표시
  async function renderCourierLists(){
    const sess = loadSession();
    if(!sess.courier) return;

    const courier = await courierByCode(sess.courier.code);
    if(!courier) return;

    // If courier role mismatches chosen screen, auto-switch
    if(courier.role && courierMode !== courier.role){
      if(courier.role === "ECONOMY_CVS"){
        courierMode = "ECONOMY_CVS";
        alert("반값택배 기사입니다. 반값 기사 화면으로 전환할게.");
      }else if(courier.role === "INTERNATIONAL"){
        courierMode = "INTERNATIONAL";
        alert("국제택배 기사입니다. 국제 기사 화면으로 전환할게.");
      }else{
        courierMode = "DOMESTIC";
        alert("국내/반품 기사입니다. 국내 기사 화면으로 전환할게.");
      }
      updateCourierModeUI();
    }

    const all = await getReservations();

    const allowEconomy = ["FINAL","PICKED_UP","ARRIVED_COLLECTION_CENTER","ARRIVED_HUB","OUTBOUND_PREP","STORE_DEPARTED"];
    const allowDomestic = ["FINAL","PICKED_UP","ARRIVED_SUB_TERMINAL","DEPARTED_SUB_TERMINAL","ARRIVED_HUB_TERMINAL","DEPARTED_HUB_TERMINAL","ARRIVED_DEST_TERMINAL","DELIVERY_STARTED"];
    const allowIntl = ["FINAL","PICKED_UP","ARRIVED_SUB_TERMINAL","DEPARTED_SUB_TERMINAL","ARRIVED_HUB_TERMINAL","DEPARTED_HUB_TERMINAL","ARRIVED_DEST_TERMINAL","AIRLINE_PREP","AIRLINE_DEPARTED","COUNTRY_ARRIVED"];

    const statusAllow = (courierMode === "ECONOMY_CVS")
      ? allowEconomy
      : (courierMode === "INTERNATIONAL" ? allowIntl : allowDomestic);

    const arr = all
      .filter(x => x.waybillNo && (statusAllow.includes(x.status) || x.status==="DELIVERED" || x.status==="DELIVERED_ADDRESS" || x.status==="DELIVERED_TO_CUSTOMER"))
      .filter(x => matchRec(x, __courierSearchQ))
      .filter(x => {
        if(courierMode === "ECONOMY_CVS") return x.type === "ECONOMY_CVS";
        if(courierMode === "INTERNATIONAL") return x.type === "INTERNATIONAL";
        return (x.type !== "ECONOMY_CVS" && x.type !== "INTERNATIONAL");
      })
      .slice(0, 100);

    const box = $("c_list");
    box.innerHTML = "";
    if(arr.length === 0){
      box.innerHTML = `<div class="item"><div style="color:var(--muted)">표시할 내역이 없어.</div></div>`;
      return;
    }

    arr.forEach(r => {
      const p = pkgSummary(r);
      const detailLine = `주소: ${p.addr} · 무게: ${p.w}kg · 종류: ${p.kind}` + (r.type==="INTERNATIONAL" ? ` · 국가: ${p.country || "-"}` : "");
      const selected = (selectedWaybill && selectedWaybill === r.waybillNo);
      box.innerHTML += `
        <div class="item" data-wb="${escapeAttr(r.waybillNo)}" style="${selected ? "outline:2px solid rgba(46,255,144,.35);" : ""}">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <span class="tag mono">${escapeHtml(r.waybillNo)}</span>
            <span class="tag">${escapeHtml(TYPE_LABEL[r.type] || r.type)} · ${escapeHtml(statusLabel(r))}</span>
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            접수지점: ${escapeHtml(r.storeName || "-")} · 도착점포: ${escapeHtml(r.destStoreName || "-")}
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px;">
            ${escapeHtml(detailLine)}
          </div>
          <div class="hint">${(r.status==="FINAL") ? "클릭하면 기사수거 처리됨" : "클릭하면 선택됨"}</div>
        </div>
      `;
    });

    box.querySelectorAll(".item").forEach(el => {
      el.onclick = async () => {
        const wb = el.dataset.wb;
        setSelectedWaybill(wb);
        await refreshCenterSelect();
        await refreshTerminalSelect();
        await refreshAirlineSelect();

        const rec = await findByWaybill(wb);
        if(!rec){ alert("내역 없음"); return; }

        // If FINAL, allow pickup.
        if(rec.status === "FINAL"){
          const msg =
`기사수거(집화) 처리할까?

운송장: ${rec.waybillNo}
유형: ${TYPE_LABEL[rec.type]}
접수지점: ${rec.storeName || "-"}
${detailText(rec)}
`;
          if(!confirm(msg)) return;

          rec.status = "PICKED_UP";
          rec.pickedAt = nowStr();
          rec.courier = { code: courier.code, name: courier.name, phone: courier.phone };
          pushEvent(rec, rec.storeName || "-", "기사수거 하였습니다", rec.pickedAt);
          await upsertRes(rec);
          showToast(`${wb} 기사수거 완료`, "기사", "good");

          alert(`기사수거 완료!\n운송장: ${wb}\n기사: ${courier.name} (${courier.phone || "-"})`);
          await renderCourierLists();
          return;
        }

        // just selection
        await renderCourierLists();
      };
    });
  }

  $("c_refresh").onclick = renderCourierLists;

  // 관리 페이지 이동
  $("c_manage_terminal").onclick = () => { window.location.href = "terminal.html"; };
  $("c_manage_center").onclick = () => { window.location.href = "center.html"; };
  $("c_manage_airline").onclick = () => { window.location.href = "airline.html"; };

  $("c_search_btn").onclick = () => { __courierSearchQ = $("c_search").value.trim(); renderCourierLists(); };
  $("c_search").addEventListener("keydown", (e) => { if(e.key==="Enter"){ __courierSearchQ = $("c_search").value.trim(); renderCourierLists(); } });
  $("c_search_clear").onclick = () => { $("c_search").value = ""; __courierSearchQ = ""; renderCourierLists(); };



  // ---------- Utilities ----------
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("'","&#39;");
  }

  // wipe (remote + local)
  $("wipeAll").onclick = async () => {
    if(!confirm("진짜 전체 데이터 삭제할까?")) return;
    await apiDel(STORAGE_KEYS.RES);
    await apiDel(STORAGE_KEYS.STORES);
    await apiDel(STORAGE_KEYS.COURIERS);
    localStorage.removeItem(STORAGE_KEYS.SESSION);
    alert("삭제 완료");
  };

  // init
  show("home");
  setCustTab("reserve");

try{ const p=document.getElementById("appVersion"); if(p) p.textContent="v"+APP_VERSION; }catch(e){}


  // 기사 화면: 선택 운송장 배송조회
  if(!$("c_track").__missing){
    $("c_track").onclick = ()=>{
      // 우선 UI에 표시된 선택 운송장 텍스트에서 가져오기
      const wb = (document.getElementById("c_selectedWaybill")?.textContent || "").trim();
      if(!wb || wb === "—"){ alert("먼저 운송장을 선택해줘."); return; }
      window.location.href = "./tracking.html?invoice_no=" + encodeURIComponent(wb);
    };
  }

</script>

  <!-- Store Picker Modal -->
  <div id="storePickerModal" class="modalOverlay" style="display:none;">
    <div class="card modalBox">
      <div class="modalHeader">
        <div class="modalTitle">점포 선택</div>
        <button class="btn ghost" id="storePickerClose" type="button">닫기</button>
      </div>
      <div class="sub" style="margin-top:6px;">등록된 점포만 표시돼. (점포코드는 숨김)</div>
      <div style="height:10px;"></div>
      <div class="list" id="storePickerList"></div>
    </div>
  </div>

</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>허브터미널 작업</title>
  <style>
:root{
  --bg1:#0b1220; --bg2:#0f1b2e; --card:#111a2b; --card2:#0f1828;
  --text:#e9eefc; --muted:#a7b2d6; --line:rgba(255,255,255,.10);
  --brand:#7aa7ff; --good:#34d399; --warn:#fbbf24; --bad:#fb7185; --info:#60a5fa;
  --shadow: 0 18px 50px rgba(0,0,0,.35);
  --r:18px;
  font-synthesis-weight:none;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial;
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(122,167,255,.25), transparent 60%),
    radial-gradient(1000px 800px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}
a{color:inherit}
.wrap{max-width:1100px; margin:0 auto; padding:18px}
.topbar{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:14px 16px; border:1px solid var(--line);
  background:rgba(17,26,43,.68); backdrop-filter: blur(10px);
  border-radius: var(--r);
  box-shadow: var(--shadow);
}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
.pill{
  font-size:12px; color:var(--muted);
  padding:6px 10px; border:1px solid var(--line); border-radius:999px;
  background:rgba(255,255,255,.03);
}
.row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
  user-select:none;
  font-weight:700;
}
.btn:hover{background:rgba(255,255,255,.07)}
.btn.primary{border-color:rgba(122,167,255,.45); background:rgba(122,167,255,.14)}
.btn.good{border-color:rgba(52,211,153,.45); background:rgba(52,211,153,.14)}
.btn.warn{border-color:rgba(251,191,36,.45); background:rgba(251,191,36,.12)}
.btn.bad{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.12)}
.btn:disabled{opacity:.45; cursor:not-allowed}
.grid{display:grid; gap:12px; margin-top:14px}
@media(min-width: 920px){ .grid.two{grid-template-columns: 1.1fr .9fr;} }
.card{
  border:1px solid var(--line);
  background:rgba(17,26,43,.58);
  backdrop-filter: blur(10px);
  border-radius: var(--r);
  box-shadow: var(--shadow);
  padding:14px;
}
.h{margin:0 0 10px; font-size:16px}
.small{font-size:12px; color:var(--muted)}
.input, select{
  width:100%;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  color:var(--text);
  padding:11px 12px;
  border-radius:12px;
  outline:none;
}
label{font-size:12px; color:var(--muted); display:block; margin:10px 0 6px}
.sep{height:1px; background:var(--line); margin:12px 0}
.kpis{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
@media(min-width: 720px){ .kpis{grid-template-columns: repeat(4, 1fr);} }
.kpi{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background:rgba(0,0,0,.16);
}
.kpi .t{font-size:12px; color:var(--muted)}
.kpi .v{font-size:20px; font-weight:900; margin-top:6px}
.table{width:100%; border-collapse: collapse; font-size:13px}
.table th,.table td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top}
.badge{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03)}
.dot{width:9px; height:9px; border-radius:999px; background:var(--info)}
.dot.ok{background:var(--good)}
.dot.stop{background:var(--bad)}
.dot.broken{background:var(--warn)}
.banner{
  display:none;
  margin-top:12px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  font-weight:700;
}
.banner.show{display:block}
.banner.good{border-color:rgba(52,211,153,.45)}
.banner.warn{border-color:rgba(251,191,36,.45)}
.banner.bad{border-color:rgba(251,113,133,.45)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div style="width:10px;height:10px;border-radius:999px;background:var(--brand)"></div>
        <div>허브터미널 작업</div>
        <span class="pill">v1.1.3</span>
      </div>
      <div class="row">
        <span id="clock" class="pill">--</span>
        <span id="apiState" class="pill">API: 확인중…</span>
        <button id="btnWork" class="btn" type="button">작업현황</button>
        <button id="btnHome" class="btn" type="button">메인</button>
      </div>
    </div>

    <div id="banner" class="banner"></div>

    <div class="grid two">
      <div class="card" id="loginCard">
        <h3 class="h">기사 로그인</h3>
        <div class="small">허브터미널 작업은 기사코드 로그인 후에만 가능해.</div>

        <label>기사 코드</label>
        <input id="courierCode" class="input" placeholder="예: 1234" autocomplete="off" inputmode="numeric"/>

        <div class="row" style="margin-top:12px">
          <button id="btnLogin" class="btn primary" type="button">로그인</button>
          <button id="btnLogout" class="btn" type="button" style="display:none">로그아웃</button>
          <span id="loginAs" class="pill">미로그인</span>
        </div>

        <div class="sep"></div>
        <div class="small">※ 로그인 상태는 이 탭(sessionStorage)에서만 유지돼.</div>
      </div>

      <div class="card" id="railsCard" style="display:none">
        <h3 class="h">레일 작동 현황(편집)</h3>
        <div class="small">정상=초록 / 미작동=빨강 / 고장=노랑</div>
        <div id="railsEditor" style="margin-top:10px"></div>
        <div class="row" style="margin-top:10px">
          <button id="btnSaveRails" class="btn good" type="button">레일 현황 저장</button>
          <button id="btnReloadRails" class="btn" type="button">새로고침</button>
        </div>
      </div>
    </div>

    <div class="card" id="workCard" style="display:none; margin-top:14px">
      <h3 class="h">운송장 작업</h3>

      <div class="grid" style="grid-template-columns:1fr; gap:12px">
        <div class="card" style="background:rgba(0,0,0,.12)">
          <div class="row" style="margin-top:10px">
            <input id="waybill" class="input" placeholder="운송장번호 18자리" style="flex:1" inputmode="numeric"/>
            <button id="btnLookup" class="btn primary" type="button">조회</button>
            <button id="btnPrint" class="btn" type="button" disabled>라벨출력</button>
          </div>

          <div id="info" style="margin-top:12px" class="small">조회 결과가 여기 나와.</div>
        </div>

        <div class="grid" style="grid-template-columns:1fr; gap:12px">
          <div class="card" style="background:rgba(0,0,0,.12)">
            <h4 class="h" style="margin-bottom:6px">허브 작업</h4>

            <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
              <div>
                <label>레일 번호 (1~5)</label>
                <select id="railNo">
                  <option value="">선택</option>
                  <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                </select>
              </div>
              <div>
                <label>서브터미널 선택</label>
                <select id="destSel">
                  <option value="">선택</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px; flex-wrap:wrap">
              <button id="btnInbound" class="btn good" type="button" disabled>입고(간선하차)</button>
              <button id="btnOutbound" class="btn warn" type="button" disabled>출고(간선상차)</button>
              <button id="btnSort" class="btn" type="button" disabled>분류완료</button>
              <button id="btnMove" class="btn primary" type="button" disabled>서브터미널로 출발</button>
            </div>

            <div class="sep"></div>
            <div class="small">메시지 예시: “허브터미널 1번 레일에서 간선하차했습니다”</div>
          </div>

          <div class="card" style="background:rgba(0,0,0,.12)">
            <h4 class="h" style="margin-bottom:6px">이력(최근 8개)</h4>
            <div id="history" class="small">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>

const API_BASE = "/api";
const STORAGE_KEYS = {
  RES: "DELIVERY_RESERVATIONS_V1",
  STORES: "DELIVERY_STORES_V1",
  COURIERS: "DELIVERY_COURIERS_V1",
  TERMINALS: "DELIVERY_TERMINALS_V1",
  CENTERS: "DELIVERY_CENTERS_V1",
  AIRLINES: "DELIVERY_AIRLINES_V1",
};

const $ = (id) => document.getElementById(id);

function kstNow(){
  const d = new Date();
  const utc = d.getTime() + (d.getTimezoneOffset()*60000);
  return new Date(utc + 9*3600000);
}
function fmtKst(dt){
  const d = (dt instanceof Date) ? dt : new Date(dt);
  const k = new Date(d.getTime() + (d.getTimezoneOffset()*60000) + 9*3600000);
  const yy = k.getFullYear();
  const mm = String(k.getMonth()+1).padStart(2,"0");
  const dd = String(k.getDate()).padStart(2,"0");
  const hh = String(k.getHours()).padStart(2,"0");
  const mi = String(k.getMinutes()).padStart(2,"0");
  const ss = String(k.getSeconds()).padStart(2,"0");
  return `${yy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}
function setClock(){
  const el = $("clock");
  if(!el) return;
  el.textContent = fmtKst(new Date()) + " (KST)";
}
setInterval(setClock, 1000); setClock();

function banner(kind, msg){
  const b = $("banner");
  if(!b) return;
  b.className = `banner show ${kind||""}`;
  b.textContent = msg || "";
}

async function apiPing(){
  try{
    const res = await fetch(`${API_BASE}/ping`, { cache:"no-store" });
    return res.ok;
  }catch(e){ return false; }
}

const mem = {};
let useLocalFallback = false;

async function apiGet(key, fallback){
  if(useLocalFallback){
    try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch{ return fallback; }
  }
  if(key in mem) return mem[key];
  const ok = await apiPing();
  if(!ok) throw new Error("API_OFFLINE");
  const res = await fetch(`${API_BASE}/kv/get?key=${encodeURIComponent(key)}`, { cache:"no-store" });
  if(!res.ok) throw new Error("GET_FAILED");
  const json = await res.json();
  mem[key] = (json.value ?? fallback);
  return mem[key];
}

async function apiSet(key, value){
  if(useLocalFallback){
    localStorage.setItem(key, JSON.stringify(value));
    mem[key] = value;
    return;
  }
  const ok = await apiPing();
  if(!ok) throw new Error("API_OFFLINE");
  const res = await fetch(`${API_BASE}/kv/set`, {
    method:"POST",
    headers:{ "Content-Type":"application/json; charset=utf-8" },
    body: JSON.stringify({ key, value })
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error("SET_FAILED: " + t);
  }
  mem[key] = value;
}

async function getReservations(){ return await apiGet(STORAGE_KEYS.RES, []); }
async function setReservations(arr){ await apiSet(STORAGE_KEYS.RES, arr); }

async function upsertRes(rec){
  const arr = await getReservations();
  const i = arr.findIndex(x => x.reserveNo === rec.reserveNo);
  if(i >= 0) arr[i] = rec; else arr.unshift(rec);
  await setReservations(arr);
  return rec;
}

function findByWaybillLocal(arr, waybill){
  const wb = String(waybill||"").trim();
  return arr.find(x => String(x.waybillNo||"") === wb) || null;
}

function ensureEvents(rec){
  if(!rec.events || !Array.isArray(rec.events)) rec.events = [];
  return rec.events;
}

function addEvent(rec, place, message){
  ensureEvents(rec).push({ time: new Date().toISOString(), place, message });
  rec.updatedAt = fmtKst(new Date());
}

function railFromText(s){
  const m = String(s||"").match(/(\d)\s*번\s*레일/);
  return m ? Number(m[1]) : null;
}


const HUB_NAME = "강남허브터미널";
const SESSION_KEY = "HUB_SESSION_TERMINAL_V1";
const RAIL_KEY = "HUB_RAIL_STATUS_TERMINAL_V1";
const DEST_KEY = "DELIVERY_TERMINALS_V1";
const DEST_LABEL = "서브터미널";

let session = null;
let currentRec = null;

function setApiState(ok){
  const el = $("apiState");
  if(!el) return;
  el.textContent = ok ? "API: OK" : "API: OFFLINE";
}

function setLoggedIn(isIn){
  $("btnLogin").style.display = isIn ? "none" : "inline-flex";
  $("btnLogout").style.display = isIn ? "inline-flex" : "none";
  $("railsCard").style.display = isIn ? "block" : "none";
  $("workCard").style.display = isIn ? "block" : "none";
}

function loadSession(){
  try{
    const raw = sessionStorage.getItem(SESSION_KEY);
    session = raw ? JSON.parse(raw) : null;
  }catch{ session = null; }
}

async function login(){
  const code = $("courierCode").value.trim();
  if(!code) return banner("warn","기사코드를 입력해.");
  try{
    const list = await apiGet(STORAGE_KEYS.COURIERS, []);
    const found = (list||[]).find(c => String(c.code||"") === code);
    if(!found) return banner("bad","없는 기사입니다. (기사등록 후 로그인)");
    session = found;
    sessionStorage.setItem(SESSION_KEY, JSON.stringify(found));
    $("loginAs").textContent = `${found.name||"기사"} (${found.code})`;
    banner("good","로그인 완료.");
    setLoggedIn(true);
    await loadDestinations();
    await loadRails();
  }catch(e){
    banner("bad","로그인 실패: " + e.message);
  }
}

function logout(){
  sessionStorage.removeItem(SESSION_KEY);
  session = null;
  currentRec = null;
  $("loginAs").textContent = "미로그인";
  banner("warn","로그아웃됨.");
  setLoggedIn(false);
  $("info").textContent = "조회 결과가 여기 나와.";
  $("history").textContent = "-";
  enableWorkButtons(false);
}

function requireLogin(){
  if(!session){
    banner("warn","기사 로그인 필요.");
    return false;
  }
  return true;
}

async function loadDestinations(){
  if(!requireLogin()) return;
  const arr = await apiGet(DEST_KEY, []);
  const sel = $("destSel");
  sel.innerHTML = '<option value="">선택</option>';
  (arr||[]).forEach(x=>{
    const opt = document.createElement("option");
    opt.value = x.name || "";
    opt.textContent = x.name || "(이름없음)";
    sel.appendChild(opt);
  });
}

function railStatusDot(s){
  if(s==="OK") return "ok";
  if(s==="STOP") return "stop";
  if(s==="BROKEN") return "broken";
  return "";
}

async function loadRails(){
  if(!requireLogin()) return;
  const obj = await apiGet(RAIL_KEY, {1:"OK",2:"OK",3:"OK",4:"OK",5:"OK"});
  const root = $("railsEditor");
  root.innerHTML = "";
  for(let i=1;i<=5;i++){
    const row = document.createElement("div");
    row.style.display="flex";
    row.style.alignItems="center";
    row.style.justifyContent="space-between";
    row.style.gap="10px";
    row.style.padding="10px 8px";
    row.style.borderBottom="1px solid var(--line)";

    const left = document.createElement("div");
    left.innerHTML = `<span class="badge"><span class="dot ${railStatusDot(obj[i])}"></span>${i}번 레일</span>`;

    const sel = document.createElement("select");
    sel.className="input";
    sel.style.maxWidth="220px";
    sel.innerHTML = `
      <option value="OK">정상작동(초록)</option>
      <option value="STOP">미작동(빨강)</option>
      <option value="BROKEN">고장(노랑)</option>
    `;
    sel.value = obj[i] || "OK";
    sel.dataset.rail = String(i);

    row.appendChild(left);
    row.appendChild(sel);
    root.appendChild(row);
  }
}

async function saveRails(){
  if(!requireLogin()) return;
  const sels = $("railsEditor").querySelectorAll("select[data-rail]");
  const obj = {};
  sels.forEach(s=> obj[Number(s.dataset.rail)] = s.value);
  await apiSet(RAIL_KEY, obj);
  banner("good","레일 현황 저장 완료.");
  await loadRails();
}

function enableWorkButtons(on){
  ["btnInbound","btnOutbound","btnSort","btnMove","btnPrint"].forEach(id=>{
    $(id).disabled = !on;
  });
}

function renderRec(rec){
  if(!rec){
    $("info").textContent = "조회된 운송장이 없어.";
    $("history").textContent = "-";
    enableWorkButtons(false);
    return;
  }
  const type = rec.type || rec.service || "-";
  const sender = rec.sender?.name || rec.senderName || "-";
  const receiver = rec.receiver?.name || rec.receiverName || "-";
  const store = rec.storeName || rec.store?.name || "-";
  const memo = rec.memo || "-";
  $("info").innerHTML = `
    <div><b>운송장</b>: ${rec.waybillNo || "-"}</div>
    <div><b>서비스</b>: ${type} / <b>접수지점</b>: ${store}</div>
    <div><b>보내는분</b>: ${sender} / <b>받는분</b>: ${receiver}</div>
    <div><b>메모</b>: ${memo}</div>
    <div class="small">업데이트: ${rec.updatedAt || "-"}</div>
  `;

  const ev = (rec.events||[]).slice(-8).reverse();
  $("history").innerHTML = ev.length ? ev.map(e=>`• ${fmtKst(e.time)} | ${e.place} | ${e.message}`).join("<br>") : "-";
  enableWorkButtons(true);
}

async function lookup(){
  if(!requireLogin()) return;
  const wb = $("waybill").value.trim();
  if(!wb) return banner("warn","운송장번호를 입력해.");
  try{
    const arr = await getReservations();
    const rec = findByWaybillLocal(arr, wb);
    if(!rec){
      currentRec = null;
      enableWorkButtons(false);
      $("info").textContent = "등록된 운송장을 찾지 못했어.";
      $("history").textContent = "-";
      return;
    }
    currentRec = rec;
    banner("good","조회 완료.");
    renderRec(rec);
  }catch(e){
    banner("bad","조회 실패: " + e.message);
  }
}

function getRailOrWarn(){
  const rail = $("railNo").value.trim();
  if(!rail) { banner("warn","레일 번호를 선택해."); return null; }
  return rail;
}

async function doInbound(){
  if(!currentRec) return banner("warn","먼저 운송장을 조회해.");
  const rail = getRailOrWarn(); if(!rail) return;
  addEvent(currentRec, HUB_NAME, `${HUB_NAME} ${rail}번 레일에서 간선하차했습니다`);
  await upsertRes(currentRec);
  banner("good","입고 처리됨.");
  renderRec(currentRec);
}
async function doOutbound(){
  if(!currentRec) return banner("warn","먼저 운송장을 조회해.");
  const rail = getRailOrWarn(); if(!rail) return;
  addEvent(currentRec, HUB_NAME, `${HUB_NAME} ${rail}번 레일에서 간선상차했습니다`);
  await upsertRes(currentRec);
  banner("good","출고 처리됨.");
  renderRec(currentRec);
}
async function doSort(){
  if(!currentRec) return banner("warn","먼저 운송장을 조회해.");
  const rail = getRailOrWarn(); if(!rail) return;
  addEvent(currentRec, HUB_NAME, `${HUB_NAME} ${rail}번 레일에서 분류완료되었습니다.`);
  await upsertRes(currentRec);
  banner("good","분류완료 처리됨.");
  renderRec(currentRec);
}
async function doMove(){
  if(!currentRec) return banner("warn","먼저 운송장을 조회해.");
  const dest = $("destSel").value.trim();
  if(!dest) return banner("warn",`${DEST_LABEL}를 선택해.`);
  addEvent(currentRec, HUB_NAME, `${HUB_NAME} ${dest}로 이동될 예정입니다`);
  await upsertRes(currentRec);
  banner("good","출발(이동예정) 기록됨.");
  renderRec(currentRec);
}

function printLabel(){
  if(!currentRec) return banner("warn","먼저 운송장을 조회해.");
  const wb = currentRec.waybillNo;
  window.location.href = `hublabel.html?invoice_no=${encodeURIComponent(wb)}`;
}

async function init(){
  const ok = await apiPing();
  setApiState(ok);
  if(!ok){
    banner("bad","API가 꺼져있어. Netlify Functions/라우팅 확인 필요.");
  }
  loadSession();
  if(session){
    $("loginAs").textContent = `${session.name||"기사"} (${session.code})`;
    setLoggedIn(true);
    await loadDestinations();
    await loadRails();
  }else{
    setLoggedIn(false);
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("btnHome").addEventListener("click", ()=> location.href="index.html");
  $("btnWork").addEventListener("click", ()=> location.href="Workstatus.html");
  $("btnLogin").addEventListener("click", login);
  $("btnLogout").addEventListener("click", logout);
  $("btnSaveRails").addEventListener("click", saveRails);
  $("btnReloadRails").addEventListener("click", loadRails);

  $("btnLookup").addEventListener("click", lookup);
  $("btnInbound").addEventListener("click", doInbound);
  $("btnOutbound").addEventListener("click", doOutbound);
  $("btnSort").addEventListener("click", doSort);
  $("btnMove").addEventListener("click", doMove);
  $("btnPrint").addEventListener("click", printLabel);

  $("courierCode").addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });
  $("waybill").addEventListener("keydown", (e)=>{ if(e.key==="Enter") lookup(); });

  init();
});
</script>
</body>
</html>

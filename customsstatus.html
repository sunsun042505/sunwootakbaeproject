<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>선우택배 · 통관 진행 조회</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#10182a;
      --card2:#0f1626;
      --line:rgba(255,255,255,.10);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --good:#37d67a;
      --bad:#ff4d6d;
      --warn:#ffcc00;
      --chip:rgba(255,255,255,.08);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(92,124,250,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(55,214,122,.14), transparent 60%),
        radial-gradient(900px 500px at 30% 90%, rgba(255,77,109,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1020px;margin:0 auto;padding:22px}
    .top{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;margin-bottom:16px;}
    .brand{display:flex;flex-direction:column;gap:6px;}
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .brand .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 10px;border:1px solid var(--line);background:var(--chip);border-radius:999px;font-size:12px;color:var(--muted)}
    .chip b{color:var(--text)}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 60%), var(--card);
      border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;
    }
    .panel-head{
      padding:16px 16px 12px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .panel-head .title{font-weight:900}
    .panel-head .small{font-size:12px;color:var(--muted)}
    .panel-body{padding:16px}
    .grid{
      display:grid;grid-template-columns: 1.2fr 2fr 1fr auto;
      gap:10px;align-items:end;
    }
    @media(max-width:860px){.grid{grid-template-columns:1fr 1fr}}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    select,input,button{
      width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:var(--card2);color:var(--text);outline:none;
    }
    input::placeholder{color:rgba(233,238,252,.45)}
    button{
      background:linear-gradient(135deg, rgba(92,124,250,.95), rgba(55,214,122,.70));
      border:none;font-weight:900;cursor:pointer;padding:12px 16px;
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45}
    .hint b{color:var(--text)}
    .hr{height:1px;background:var(--line);margin:16px 0}
    .statusbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:12px;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);color:var(--muted);font-size:12px
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}

    .cards{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:14px;
    }
    @media(max-width:860px){.cards{grid-template-columns:1fr 1fr}}
    @media(max-width:520px){.cards{grid-template-columns:1fr}}
    .kv{padding:12px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03)}
    .k{font-size:11px;color:var(--muted);margin-bottom:6px}
    .v{font-size:14px;font-weight:900;word-break:break-word}

    /* Timeline table */
    .tbl-wrap{
      margin-top:14px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02);
      overflow:hidden;
    }
    table{width:100%;border-collapse:collapse}
    thead th{
      text-align:left;font-size:12px;color:rgba(233,238,252,.78);
      padding:12px 12px;background:rgba(255,255,255,.04);border-bottom:1px solid var(--line);
      letter-spacing:.2px;
    }
    tbody td{
      padding:12px;border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;font-size:13px;color:rgba(233,238,252,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.03)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .muted{color:var(--muted)}
    .stage{font-weight:900}
    .place{white-space:pre-line}
    .note{white-space:pre-line}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--muted);font-size:12px
    }

    .error{
      margin-top:14px;padding:12px;border-radius:16px;border:1px solid rgba(255,77,109,.35);
      background:rgba(255,77,109,.12);color:#ffdbe2;font-size:13px;line-height:1.5
    }
    .raw{margin-top:14px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02);overflow:hidden}
    .raw-head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .raw-head b{font-size:13px}
    .raw-head button{width:auto;padding:8px 10px;border-radius:12px;background:rgba(255,255,255,.10);border:1px solid var(--line);font-weight:800;color:var(--text);cursor:pointer}
    pre{margin:0;padding:12px;white-space:pre-wrap;word-break:break-word;color:rgba(233,238,252,.9)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>선우택배 · 통관 진행 조회</h1>
        <div class="sub">
          ✅ <b>특송업체</b>=<span class="mono">&lt;frwrEntsConm&gt;</span> · ✅ <b>선사/항공사</b>=<span class="mono">&lt;shcoFlco&gt;</span><br/>
          ✅ <b>처리단계</b>는 무조건 “처리단계 텍스트”만 표시(신고번호/코드/시간이 단계로 올라오는 버그 제거)
        </div>
      </div>
      <div class="chips">
        <div class="chip">버전: <b id="ver">v4.7-stage</b></div>
        <div class="chip">API: <b>/.netlify/functions/unipass</b></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div>
          <div class="title">조회</div>
          <div class="small">HBL/MBL은 보통 연도(blYy)가 필요하지만, 연도 검증으로 조회를 막지 않고 자동 보정/재시도함.</div>
        </div>
        <div class="small" id="last">마지막 조회: -</div>
      </div>

      <div class="panel-body">
        <div class="grid">
          <div>
            <label>조회 타입</label>
            <select id="type">
              <option value="hbl">H B/L (특송/직구)</option>
              <option value="mbl">M B/L</option>
              <option value="carg">화물관리번호</option>
            </select>
          </div>
          <div>
            <label>번호(운송장/BL/화물관리번호)</label>
            <input id="no" placeholder="번호 입력" autocomplete="off" />
          </div>
          <div>
            <label>B/L 연도(blYy)</label>
            <input id="blYy" placeholder="예) 2026 (비워도 됨)" inputmode="numeric" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btn">조회</button>
          </div>
        </div>

        <div class="hint">
          • 통관조회 화면은 내부용이라 <b>운송장번호 전체 표시</b>함.<br/>
          • “단계”는 <b>처리단계</b>만 나오게 고정했음 (신고번호/코드가 단계로 뜨면 버그).
        </div>

        <div class="statusbar">
          <div class="badge"><span class="dot" id="dot"></span><span id="badge">대기</span></div>
          <div class="badge"><span class="muted">연도 처리:</span> <span id="yearHint" class="mono">-</span></div>
        </div>

        <div id="result"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const VERSION = "v4.7-stage (2026-01-07)";
  const $ = (id) => document.getElementById(id);

  $("ver").textContent = VERSION;

  const nowKST = () => new Date().toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });

  function setState(kind, text){
    $("badge").textContent = text;
    $("dot").className = "dot" + (kind === "ok" ? " ok" : kind === "bad" ? " bad" : "");
  }

  function xmlText(node, tag){
    const el = node.getElementsByTagName(tag)[0];
    return el ? (el.textContent || "").trim() : "";
  }

  function pick(node, tags){
    for (const t of tags){
      const v = xmlText(node, t);
      if (v) return v;
    }
    return "";
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function fmtDttm(s){
    s = (s||"").trim();
    if (/^\d{14}$/.test(s)){
      return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}:${s.slice(12,14)}`;
    }
    if (/^\d{12}$/.test(s)){
      return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}:00`;
    }
    if (/^\d{8}$/.test(s)){
      return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
    }
    return s;
  }

  function normalizeYear(input){
    const raw = (input||"").toString();
    const digits = raw.replace(/[^\d]/g, "");
    if (digits.length >= 4) return digits.slice(0,4);
    return "";
  }

  function containsKorean(s){
    return /[가-힣]/.test(s||"");
  }

  function looksLikeIdOrCode(s){
    s = (s||"").trim();
    if (!s) return true;
    if (/^\d{8,}$/.test(s)) return true;
    if (/^[A-Z0-9]{8,}$/.test(s)) return true;
    if (/^[0-9A-Z\/]{6,}$/.test(s) && !containsKorean(s)) return true;
    return false;
  }

  function stageFromDtl(n){
    // ✅ 단계는 이 후보만 보고, 한글 없는 값은 단계로 안 올림
    const candidates = [
      pick(n, ["prcsStts"]),
      pick(n, ["cargTrcnRelaBsopTpcdNm"]),
      pick(n, ["bfhnGdncCn"]),
    ].map(v => (v||"").trim()).filter(Boolean);

    for (const v of candidates){
      if (!containsKorean(v)) continue;
      if (looksLikeIdOrCode(v)) continue;
      return v;
    }
    return "-";
  }

  function noteFromDtl(n){
    const v = pick(n, ["rlbrCn", "bfhnGdncCn", "rmk", "remark"]);
    return (v||"").trim() || "-";
  }

  function placeFromDtl(n){
    const shedNm = pick(n, ["shedNm"]);
    const cstmNm = pick(n, ["cstmNm", "csclCstmNm", "dclrCstmNm"]);
    const place = (shedNm || cstmNm || "-").trim();
    return place || "-";
  }

  function findFirstText(root, tags){
    let v = pick(root, tags);
    if (v) return v;
    const dtlsAll = Array.from(root.getElementsByTagName("cargCsclPrgsInfoDtlQryVo"));
    for (const d of dtlsAll){
      v = pick(d, tags);
      if (v) return v;
    }
    return "";
  }

  function parseUnipass(xmlDoc){
    const root = xmlDoc;

    const tCnt = pick(root, ["tCnt"]);
    const ntceInfo = pick(root, ["ntceInfo"]);

    const vo = root.getElementsByTagName("cargCsclPrgsInfoQryVo")[0] || root;

    const prnm = pick(vo, ["prnm", "gdsNm", "prdtNm"]);
    const etprDt = pick(vo, ["etprDt", "etprDt8", "etprYmd"]);
    const csclPrgsStts = pick(vo, ["csclPrgsStts", "prgsStts"]);
    const prcsDttm = pick(vo, ["prcsDttm", "prcsDt"]);

    // ✅ 정확 고정
    const expressNm = findFirstText(root, ["frwrEntsConm"]);
    const carrierNm = findFirstText(root, ["shcoFlco", "shcoFlcoNm"]);
    const customsNm = findFirstText(root, ["cstmNm", "csclCstmNm", "dclrCstmNm"]);

    const dtlsAll = Array.from(root.getElementsByTagName("cargCsclPrgsInfoDtlQryVo"));
    const rows = dtlsAll.map(n => {
      const timeRaw = pick(n, ["prcsDttm", "rlbrDttm", "prcsDt"]);
      return {
        stage: stageFromDtl(n),
        timeRaw: (timeRaw||"").trim(),
        time: fmtDttm(timeRaw),
        place: placeFromDtl(n),
        note: noteFromDtl(n),
      };
    });

    rows.sort((a,b) => (b.timeRaw||"").localeCompare(a.timeRaw||""));

    return { tCnt, ntceInfo, csclPrgsStts, prcsDttm, prnm, etprDt, expressNm, carrierNm, customsNm, rows };
  }

  function timelineTableHTML(rows){
    if (!rows || !rows.length){
      return `<div class="error">상세 이력(dtl)이 비어있음</div>`;
    }
    const topPills = `
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <span class="pill">단계는 <b>처리단계</b>만 표시</span>
        <span class="pill">신고번호/코드/시간은 단계로 올리지 않음</span>
      </div>
    `;

    const body = rows.map(r => `
      <tr>
        <td class="stage">${escapeHtml(r.stage || "-")}</td>
        <td class="mono">${escapeHtml(r.time || "-")}</td>
        <td class="place">${escapeHtml(r.place || "-")}</td>
        <td class="note">${escapeHtml(r.note || "-")}</td>
      </tr>
    `).join("");

    return `
      ${topPills}
      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:26%">단계</th>
              <th style="width:18%">시간</th>
              <th style="width:28%">장소</th>
              <th>비고</th>
            </tr>
          </thead>
          <tbody>${body}</tbody>
        </table>
      </div>
    `;
  }

  function cardHTML(inputNo, d){
    return `
      <div class="hr"></div>

      <div class="chips" style="margin-bottom:10px">
        <div class="chip">번호: <b class="mono">${escapeHtml(inputNo)}</b></div>
        <div class="chip">상태: <b>${escapeHtml(d.csclPrgsStts || "-")}</b></div>
        <div class="chip">처리: <b class="mono">${escapeHtml(fmtDttm(d.prcsDttm || "-"))}</b></div>
      </div>

      <div class="cards">
        <div class="kv"><div class="k">특송업체</div><div class="v">${escapeHtml(d.expressNm || "-")}</div></div>
        <div class="kv"><div class="k">선사/항공사</div><div class="v">${escapeHtml(d.carrierNm || "-")}</div></div>
        <div class="kv"><div class="k">세관명</div><div class="v">${escapeHtml(d.customsNm || "-")}</div></div>

        <div class="kv"><div class="k">품명</div><div class="v">${escapeHtml(d.prnm || "-")}</div></div>
        <div class="kv"><div class="k">입항일</div><div class="v mono">${escapeHtml(fmtDttm(d.etprDt || "-"))}</div></div>
        <div class="kv"><div class="k">이력 건수</div><div class="v">${escapeHtml(String(d.rows?.length ?? 0))}</div></div>
      </div>

      ${timelineTableHTML(d.rows)}
    `;
  }

  function rawBox(xmlText){
    return `
      <div class="raw">
        <div class="raw-head">
          <b>원문(XML)</b>
          <button id="toggleRaw" type="button">접기/펼치기</button>
        </div>
        <pre id="rawPre">${escapeHtml(xmlText)}</pre>
      </div>
    `;
  }

  async function callAPI(type, no, blYy){
    const qs = new URLSearchParams({ type, no });
    if (blYy) qs.set("blYy", blYy);
    const r = await fetch(`/.netlify/functions/unipass?${qs.toString()}`);
    const text = await r.text();
    if (!r.ok) throw new Error(text || `HTTP ${r.status}`);
    return text;
  }

  async function callWithYearStrategy(type, no, blYyInput){
    const now = new Date();
    const yNow = now.getFullYear();
    const yPrev = yNow - 1;

    const yNorm = normalizeYear(blYyInput);

    if (type === "carg"){
      $("yearHint").textContent = "연도 없음 (carg)";
      return { xmlText: await callAPI(type, no, ""), usedYear: "" };
    }

    const tries = [];
    if (yNorm) tries.push(yNorm);
    if (!tries.includes(String(yNow))) tries.push(String(yNow));
    if (!tries.includes(String(yPrev))) tries.push(String(yPrev));

    $("yearHint").textContent = tries.join(" → ") + " 자동 시도";

    let lastXml = "";
    for (const y of tries){
      const xmlText = await callAPI(type, no, y);
      lastXml = xmlText;
      const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
      const tCnt = pick(xmlDoc, ["tCnt"]);
      const ntceInfo = pick(xmlDoc, ["ntceInfo"]);
      if (ntceInfo){
        return { xmlText, usedYear: y };
      }
      if (tCnt && tCnt !== "0"){
        $("blYy").value = y;
        return { xmlText, usedYear: y };
      }
    }

    return { xmlText: lastXml, usedYear: tries[0] || "" };
  }

  $("btn").addEventListener("click", async () => {
    const type = $("type").value;
    const no = ($("no").value || "").trim();
    const blYy = ($("blYy").value || "").trim();

    $("result").innerHTML = "";
    if (!no){
      setState("bad","번호 필요");
      $("result").innerHTML = `<div class="error">번호가 비었음</div>`;
      return;
    }

    $("btn").disabled = true;
    $("btn").textContent = "조회중…";
    setState("", "조회 중");

    try{
      const { xmlText } = await callWithYearStrategy(type, no, blYy);
      const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
      const d = parseUnipass(xmlDoc);

      $("last").textContent = "마지막 조회: " + nowKST();

      if (d.ntceInfo){
        setState("bad","안내/에러");
        $("result").innerHTML = `<div class="error">${escapeHtml(d.ntceInfo)}</div>` + rawBox(xmlText);
      } else if (d.tCnt === "0"){
        setState("bad","결과 없음");
        $("result").innerHTML = `<div class="error">조회 결과가 0건(tCnt=0)이야. 번호/연도(blYy) 확인 ㄱㄱ</div>` + rawBox(xmlText);
      } else {
        setState("ok","조회 완료");
        $("result").innerHTML = cardHTML(no, d) + rawBox(xmlText);

        const btn = document.getElementById("toggleRaw");
        const pre = document.getElementById("rawPre");
        if (btn && pre){
          let hidden = false;
          btn.addEventListener("click", ()=>{
            hidden = !hidden;
            pre.style.display = hidden ? "none" : "block";
          });
        }
      }
    }catch(e){
      setState("bad","조회 실패");
      $("result").innerHTML = `<div class="error">에러: ${escapeHtml(String(e.message||e))}</div>`;
    }finally{
      $("btn").disabled = false;
      $("btn").textContent = "조회";
    }
  });

})();
</script>
</body>
</html>

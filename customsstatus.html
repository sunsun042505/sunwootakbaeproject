<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>선우택배 · 통관 진행 조회</title>
  <style>
    :root{
      --bg:#070b14;
      --panel:#0d1424;
      --panel2:#0b1120;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --good:#37d67a;
      --bad:#ff4d6d;
      --warn:#ffcc00;
      --shadow: 0 18px 60px rgba(0,0,0,.50);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(92,124,250,.18), transparent 60%),
        radial-gradient(860px 520px at 88% 22%, rgba(55,214,122,.13), transparent 60%),
        radial-gradient(900px 520px at 30% 92%, rgba(255,77,109,.10), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1050px;margin:0 auto;padding:22px}
    .top{display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;align-items:flex-start;margin-bottom:16px}
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .brand .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.45}
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);color:var(--muted);font-size:12px
    }
    .chip b{color:var(--text)}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 60%), var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .ph{padding:16px 16px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .ph .title{font-weight:900}
    .ph .small{font-size:12px;color:var(--muted)}
    .pb{padding:16px}

    .search{
      display:flex;gap:10px;align-items:stretch;flex-wrap:wrap
    }
    .field{flex:1;min-width:240px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,button{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder{color:rgba(234,240,255,.45)}
    button{
      width:auto;
      min-width:120px;
      border:none;
      cursor:pointer;
      font-weight:900;
      background:linear-gradient(135deg, rgba(92,124,250,.95), rgba(55,214,122,.78));
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45}
    .statusbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:12px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);color:var(--muted);font-size:12px
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}

    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:14px}
    @media(max-width:900px){.cards{grid-template-columns:1fr 1fr}}
    @media(max-width:560px){.cards{grid-template-columns:1fr} button{width:100%}}
    .kv{
      padding:12px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03);
      min-height:66px
    }
    .k{font-size:11px;color:var(--muted);margin-bottom:6px}
    .v{font-size:14px;font-weight:900;word-break:break-word}

    .tableWrap{
      margin-top:14px;
      border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02);
      overflow:hidden;
    }
    table{width:100%;border-collapse:collapse}
    thead th{
      text-align:left;
      font-size:12px;color:rgba(234,240,255,.85);
      padding:12px 12px;
      background:rgba(255,255,255,.04);
      border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:1;
    }
    tbody td{
      padding:12px 12px;
      border-top:1px solid rgba(255,255,255,.07);
      vertical-align:top;
      font-size:13px;
      color:rgba(234,240,255,.92);
    }
    tbody tr:hover td{background:rgba(255,255,255,.03)}
    .muted{color:var(--muted)}
    .mono{font-variant-numeric: tabular-nums}
    .noticeRow td{
      color:rgba(234,240,255,.85);
      background:rgba(255,204,0,.08);
      border-top:1px solid rgba(255,204,0,.18);
      font-size:12px;
    }

    .error{
      margin-top:14px;padding:12px;border-radius:16px;border:1px solid rgba(255,77,109,.35);
      background:rgba(255,77,109,.12);color:#ffdbe2;font-size:13px;line-height:1.5
    }

    .raw{
      margin-top:14px;
      border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02);
      overflow:hidden
    }
    .raw-head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .raw-head b{font-size:13px}
    .raw-head button{background:rgba(255,255,255,.10);border:1px solid var(--line);padding:8px 10px;border-radius:12px}
    pre{margin:0;padding:12px;white-space:pre-wrap;word-break:break-word;color:rgba(234,240,255,.9)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>선우택배 · 통관 진행 조회</h1>
        <div class="sub">
          운송장번호(HBL)만 입력해서 조회하는 <b>단순 모드</b>.<br/>
          연도(blYy)는 입력받지 않고, <b>자동으로 올해→작년→재작년</b> 순서로 찾아서 조회함.
        </div>
      </div>
      <div class="chips">
        <div class="chip"><b>v5.0-waybill-only</b></div>
        <div class="chip">빌드: <b>2026-01-07</b></div>
        <div class="chip">특송업체: <b>&lt;frwrEntsConm&gt;</b></div>
        <div class="chip">선사/항공사: <b>&lt;shcoFlco&gt;</b></div>
      </div>
    </div>

    <div class="panel">
      <div class="ph">
        <div>
          <div class="title">통관 조회</div>
          <div class="small">API 호출: <span class="mono">/.netlify/functions/unipass</span></div>
        </div>
        <div class="small" id="last">마지막 조회: -</div>
      </div>

      <div class="pb">
        <div class="search">
          <div class="field">
            <label>운송장번호 (HBL)</label>
            <input id="hbl" placeholder="예) 300046199451 (또는 18자리/알파넘버)" autocomplete="off" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btn">조회</button>
          </div>
        </div>

        <div class="hint">
          • 조회는 HBL 기준으로만 진행해. (MBL/화물관리번호는 여기선 안 씀)<br/>
          • 결과가 0건이면 연도 자동 탐색(올해→작년→재작년)으로 다시 찔러봄.
        </div>

        <div class="statusbar">
          <div class="badge"><span class="dot" id="dot"></span><span id="badge">대기</span></div>
          <div class="badge">선택된 연도: <b id="pickedYear">-</b></div>
        </div>

        <div id="result"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function setState(kind, text){
    $("badge").textContent = text;
    $("dot").className = "dot" + (kind === "ok" ? " ok" : kind === "bad" ? " bad" : "");
  }

  function nowKST(){
    return new Date().toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function xmlText(node, tag){
    const el = node.getElementsByTagName(tag)[0];
    return el ? (el.textContent || "").trim() : "";
  }

  function pick(node, tags){
    for (const t of tags){
      const v = xmlText(node, t);
      if (v) return v;
    }
    return "";
  }

  function pickInDtls(dtls, tags){
    for (const n of dtls){
      const v = pick(n, tags);
      if (v) return v;
    }
    return "";
  }

  function findCstmCodeAnywhere(xmlDoc){
    // 세관명이 없을 때라도 코드라도 잡기
    const all = xmlDoc.getElementsByTagName("*");
    for (let i=0;i<all.length;i++) {
      const el = all[i];
      const tag = (el.tagName||"").toLowerCase();
      if (!tag.includes("cstm")) continue;
      const v = (el.textContent||"").trim();
      if (/^\d{8}$/.test(v)) return v;
    }
    return "";
  }

  function fmtDttm(s){
    s = (s||"").trim();
    // 20251213231557 -> 2025-12-13 23:15:57
    if (/^\d{14}$/.test(s)){
      return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}:${s.slice(12,14)}`;
    }
    if (/^\d{8}$/.test(s)) {
      return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
    }
    return s;
  }

  function looksLikeStage(s){
    s = (s||"").trim();
    if (!s) return false;
    // 숫자/영문 코드만은 단계로 인정 X
    if (/^[A-Za-z0-9_-]+$/.test(s)) return false;
    // 너무 긴 문장도 단계가 아닐 가능성이 높음(부가사항은 예외 처리)
    if (s.length > 40 && !s.includes("부가사항")) return false;
    return true;
  }

  function getStageFromDtl(n){
    // 처리단계 = prcsStts 우선
    let stage = pick(n, ["prcsStts","prcsSttsNm","cargTrcnRelaBsopTpcdNm","csclPrgsStts"]);
    if (looksLikeStage(stage)) return stage;

    // 간혹 처리내용 쪽에 단계명이 들어오는 경우만 제한적으로 허용
    const remark = pick(n, ["rlbrCn","bfhnGdncCn","prcsCn","rlbrCn2"]);
    const maybeStage = (remark||"").trim();
    if (maybeStage && maybeStage.length <= 20 && /[가-힣]/.test(maybeStage) &&
        /(신고|접수|제출|완료|수리|반입|반출|통관|검사|심사)/.test(maybeStage)) {
      return maybeStage;
    }
    return "-";
  }

  function getPlace(n, expressName){
    const shed = pick(n, ["shedNm","shedSgn"]);
    const place = shed ? shed : "-";
    // 화면용: 장소에 특송업체를 같이 붙이면 원본 느낌이 남
    if (expressName && place !== "-" && !place.includes(expressName)) {
      return place + "\n" + expressName;
    }
    return place;
  }

  function getRemark(n){
    // 반출입(처리)내용
    let r = pick(n, ["rlbrCn","bfhnGdncCn","prcsCn","rlbrCn2","cargTrcnRelaBsopTpcdNm"]);
    r = (r||"").trim();
    if (!r) return "-";
    // 너무 길면 줄바꿈 유지
    return r;
  }

  async function callAPI(hbl, year){
    const qs = new URLSearchParams({ type:"hbl", no:hbl, blYy:String(year) });
    const r = await fetch(`/.netlify/functions/unipass?${qs.toString()}`);
    const text = await r.text();
    if (!r.ok) throw new Error(text || `HTTP ${r.status}`);
    return text;
  }

  function parse(xmlText, hbl){
    const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
    const root = xmlDoc;

    const ntceInfo = pick(root, ["ntceInfo"]);
    const tCnt = pick(root, ["tCnt"]);

    const vo = root.getElementsByTagName("cargCsclPrgsInfoQryVo")[0] || root;
    const dtlsAll = Array.from(root.getElementsByTagName("cargCsclPrgsInfoDtlQryVo"));

    const express = pick(vo, ["frwrEntsConm"]) || pickInDtls(dtlsAll, ["frwrEntsConm"]);
    const carrier = pick(vo, ["shcoFlco"]) || pick(vo, ["shcoFlcoNm"]) || pickInDtls(dtlsAll, ["shcoFlco","shcoFlcoNm"]);

    // 세관명/코드
    let customsName = pick(vo, ["cstmNm","csclCstmNm","dclrCstmNm"]);
    let customsCode = pick(vo, ["cstmCd","csclCstmCd","dclrCstmCd"]);
    if (!customsCode) customsCode = findCstmCodeAnywhere(xmlDoc);

    if (!customsName && customsCode) customsName = `세관코드 ${customsCode}`;
    if (!customsName) customsName = "-";

    // 상단 요약
    const status = pick(vo, ["csclPrgsStts","prgsStts","prgsStCd"]);
    const prcsDttm = pick(vo, ["prcsDttm","prcsDt","dttm"]);
    const prnm = pick(vo, ["prnm","gdsNm","prdtNm"]);
    const etprDt = pick(vo, ["etprDt","etprDt8","etprYmd"]);

    // dtl 정렬(최신순)
    const dtls = dtlsAll
      .map(n => {
        const timeRaw = pick(n, ["prcsDttm","prcsDt","rlbrDttm"]);
        const time = fmtDttm(timeRaw);
        return {
          stage: getStageFromDtl(n),
          time,
          place: getPlace(n, express),
          remark: getRemark(n),
          isNotice: /부가사항/.test(getStageFromDtl(n)) || /^\[/.test(getStageFromDtl(n)) || /부가사항/.test(getRemark(n))
        };
      })
      .sort((a,b)=> (a.time < b.time ? 1 : a.time > b.time ? -1 : 0));

    return {
      xmlDoc, xmlText,
      ntceInfo, tCnt,
      hbl,
      express, carrier,
      customsName,
      status, prcsDttm: fmtDttm(prcsDttm),
      prnm: prnm || "-",
      etprDt: fmtDttm(etprDt),
      dtls
    };
  }

  function render(d){
    const cards = `
      <div class="cards">
        <div class="kv"><div class="k">특송업체</div><div class="v">${escapeHtml(d.express || "-")}</div></div>
        <div class="kv"><div class="k">선사/항공사</div><div class="v">${escapeHtml(d.carrier || "-")}</div></div>
        <div class="kv"><div class="k">세관</div><div class="v">${escapeHtml(d.customsName || "-")}</div></div>

        <div class="kv"><div class="k">상태</div><div class="v">${escapeHtml(d.status || "-")}</div></div>
        <div class="kv"><div class="k">처리</div><div class="v mono">${escapeHtml(d.prcsDttm || "-")}</div></div>
        <div class="kv"><div class="k">이력 건수</div><div class="v mono">${escapeHtml(String(d.dtls.length))}</div></div>

        <div class="kv"><div class="k">품명</div><div class="v">${escapeHtml(d.prnm || "-")}</div></div>
        <div class="kv"><div class="k">입항일</div><div class="v mono">${escapeHtml(d.etprDt || "-")}</div></div>
        <div class="kv"><div class="k">HBL</div><div class="v mono">${escapeHtml(d.hbl)}</div></div>
      </div>
    `;

    const rows = d.dtls.map(r => {
      if (r.isNotice) {
        return `<tr class="noticeRow"><td colspan="4">${escapeHtml(r.stage !== "-" ? r.stage : r.remark)}</td></tr>`;
      }
      return `
        <tr>
          <td>${escapeHtml(r.stage)}</td>
          <td class="mono">${escapeHtml(r.time)}</td>
          <td>${escapeHtml(r.place)}</td>
          <td>${escapeHtml(r.remark)}</td>
        </tr>
      `;
    }).join("");

    const table = `
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:24%">처리단계</th>
              <th style="width:18%">처리일시</th>
              <th style="width:33%">장치장/장치위치</th>
              <th style="width:25%">반출입(처리)내용</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="4" class="muted">이력 없음</td></tr>`}
          </tbody>
        </table>
      </div>
    `;

    const raw = `
      <div class="raw">
        <div class="raw-head">
          <b>원문(XML)</b>
          <button id="toggleRaw" type="button">접기/펼치기</button>
        </div>
        <pre id="rawPre">${escapeHtml(d.xmlText)}</pre>
      </div>
    `;

    return cards + table + raw;
  }

  async function queryHBL(hbl){
    const cur = new Date().getFullYear();
    const years = [cur, cur-1, cur-2];

    for (const y of years) {
      try {
        const xmlText = await callAPI(hbl, y);
        const d = parse(xmlText, hbl);

        // ntceInfo(오류) 있으면 다음 연도 시도할 가치 없음: 그래도 넘어가 보되, 보통 키/형식 오류라 멈추자
        if (d.ntceInfo) {
          return { ok:false, year:y, message:d.ntceInfo, xmlText };
        }
        if (d.tCnt === "0") {
          // 다음 연도 시도
          continue;
        }
        return { ok:true, year:y, data:d };
      } catch (e) {
        // 네트워크/함수 오류면 바로 종료
        return { ok:false, year:"-", message:String(e.message||e), xmlText:"" };
      }
    }
    return { ok:false, year:years[1], message:"조회 결과 0건 (연도 자동탐색 실패)", xmlText:"" };
  }

  $("btn").addEventListener("click", async () => {
    const hbl = ($("hbl").value || "").trim();
    $("result").innerHTML = "";

    if (!hbl) {
      setState("bad","운송장번호 입력 필요");
      $("result").innerHTML = `<div class="error">운송장번호(HBL)를 입력해줘.</div>`;
      return;
    }

    $("btn").disabled = true;
    $("btn").textContent = "조회중…";
    setState("", "조회 중");
    $("pickedYear").textContent = "-";

    try {
      const out = await queryHBL(hbl);
      $("last").textContent = "마지막 조회: " + nowKST();

      if (!out.ok) {
        setState("bad","조회 실패");
        $("pickedYear").textContent = out.year;
        $("result").innerHTML = `<div class="error">에러: ${escapeHtml(out.message)}<br/><span class="muted">연도 자동탐색: 올해→작년→재작년</span></div>` + (out.xmlText ? `
          <div class="raw"><div class="raw-head"><b>원문(XML)</b></div><pre>${escapeHtml(out.xmlText)}</pre></div>
        ` : "");
        return;
      }

      setState("ok","조회 완료");
      $("pickedYear").textContent = out.year;
      $("result").innerHTML = render(out.data);

      const btn = document.getElementById("toggleRaw");
      const pre = document.getElementById("rawPre");
      if (btn && pre) {
        let hidden = false;
        btn.addEventListener("click", ()=>{
          hidden = !hidden;
          pre.style.display = hidden ? "none" : "block";
        });
      }
    } finally {
      $("btn").disabled = false;
      $("btn").textContent = "조회";
    }
  });

  // Enter로 조회
  $("hbl").addEventListener("keydown", (e)=>{
    if (e.key === "Enter") $("btn").click();
  });
</script>
</body>
</html>

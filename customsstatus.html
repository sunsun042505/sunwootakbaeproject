<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>선우택배 · 통관 진행 조회</title>
<style>
  :root{
    --bg:#0b1220;
    --card:rgba(255,255,255,.06);
    --card2:rgba(255,255,255,.04);
    --border:rgba(255,255,255,.10);
    --text:#eaf0ff;
    --muted:rgba(234,240,255,.72);
    --muted2:rgba(234,240,255,.55);
    --bad:#ff5d5d;
    --ok:#54d69a;
    --shadow:0 12px 36px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Noto Sans KR", Arial, sans-serif;
    background: radial-gradient(1200px 600px at 15% 10%, rgba(90,145,255,.18), transparent 60%),
                radial-gradient(900px 500px at 80% 20%, rgba(84,214,154,.14), transparent 60%),
                var(--bg);
    color:var(--text);
    min-height:100vh;
  }
  .wrap{max-width:1040px;margin:0 auto;padding:26px 16px 48px}
  .topbar{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px}
  .title{font-size:22px;font-weight:900;letter-spacing:-.02em}
  .sub{color:var(--muted);font-size:13px}
  .ver{color:var(--muted2);font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03)}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
          border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
  .row{display:grid;grid-template-columns:1.2fr .55fr;gap:10px;align-items:end}
  label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px 2px}
  input{
    width:100%; padding:13px 14px; border-radius:14px;
    background:rgba(0,0,0,.24); border:1px solid rgba(255,255,255,.14);
    color:var(--text); outline:none; font-size:15px;
  }
  input:focus{border-color:rgba(90,145,255,.55); box-shadow:0 0 0 4px rgba(90,145,255,.14)}
  button{
    width:100%; padding:13px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(90,145,255,.95), rgba(70,120,255,.86));
    color:white; font-weight:800; font-size:15px; cursor:pointer;
    box-shadow:0 16px 30px rgba(70,120,255,.22);
  }
  button:disabled{opacity:.6; cursor:not-allowed}
  .hint{margin-top:10px;color:var(--muted2);font-size:12px;line-height:1.45}
  .statusbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:12px}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
          border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.35)}
  .dot.ok{background:var(--ok)}
  .dot.bad{background:var(--bad)}
  .last{color:var(--muted2);font-size:12px}
  .result{margin-top:14px}
  .cards{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px;margin-top:12px}
  .kv{background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:12px 12px}
  .k{color:var(--muted2);font-size:12px;margin-bottom:6px}
  .v{font-weight:900;font-size:15px;line-height:1.25;word-break:break-word}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .chip{border:1px solid var(--border);background:rgba(255,255,255,.03);
        color:var(--muted);border-radius:999px;padding:7px 10px;font-size:12px}
  .tableWrap{margin-top:12px;border:1px solid var(--border);border-radius:18px;overflow:hidden;background:rgba(255,255,255,.03)}
  table{width:100%;border-collapse:collapse}
  thead th{text-align:left;font-size:12px;color:var(--muted2);padding:12px 12px;background:rgba(0,0,0,.18);border-bottom:1px solid var(--border)}
  tbody td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top;font-size:14px}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .stage{font-weight:900}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12.5px}
  .muted{color:var(--muted2)}
  .small{font-size:12px;color:var(--muted2);margin-top:4px;line-height:1.25}
  .error{background:rgba(255,93,93,.10);border:1px solid rgba(255,93,93,.30);color:#ffd7d7;
          border-radius:16px;padding:12px 12px;line-height:1.35}
  .raw{margin-top:12px;border:1px solid var(--border);border-radius:18px;overflow:hidden;background:rgba(0,0,0,.18)}
  .rawHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10)}
  .rawHead b{font-size:13px}
  .rawHead button{width:auto;padding:8px 10px;border-radius:12px;background:rgba(255,255,255,.06);box-shadow:none}
  pre{margin:0;padding:12px 12px;max-height:300px;overflow:auto;color:rgba(234,240,255,.84);font-size:12px}
  @media (max-width: 860px){
    .row{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <div class="title">통관 진행 조회</div>
      <div class="sub">HBL(운송장번호)만 입력하면 연도는 자동으로 찾아서 조회함 · 세관/처리단계는 유니패스 표랑 최대한 동일하게 표시</div>
    </div>
    <div class="ver">v5.4-merge-stage (2026-01-08)</div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <label>HBL / 운송장번호</label>
        <input id="hbl" placeholder="예) 300046199451" inputmode="numeric" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btn">조회</button>
      </div>
    </div>

    <div class="hint">
      • 이 화면은 <b>통관조회 화면에서만</b> 운송장번호 전체가 보이게 되어있음.<br/>
      • 결과가 안 나오면 배송번호가 HBL이 아닌 케이스(다른 번호체계)일 수도 있음.
    </div>

    <div class="statusbar">
      <div class="badge"><span class="dot" id="dot"></span><span id="badge">대기</span></div>
      <div class="last" id="last">-</div>
    </div>
  </div>

  <div class="result" id="result"></div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const nowKST = () => new Date().toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });

  function setState(kind, text){
    $("badge").textContent = text;
    $("dot").className = "dot" + (kind === "ok" ? " ok" : kind === "bad" ? " bad" : "");
  }

  function escapeHtml(s){
    return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function xmlText(node, tag){
    if (!node) return "";
    const el = node.getElementsByTagName(tag)[0];
    if (!el || !el.textContent) return "";
    return el.textContent.trim();
  }

  function pick(node, tags){
    for (const t of tags){
      const v = xmlText(node, t);
      if (v) return v;
    }
    return "";
  }

  function anyTagText(doc, tag){
    const el = doc.getElementsByTagName(tag)[0];
    return (el && el.textContent) ? el.textContent.trim() : "";
  }

  function fmtDate8(s){
    s = (s||"").trim();
    if (/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
    return s;
  }

  function fmtDttm(s){
    s = (s||"").trim();
    // 20251213231557
    if (/^\d{14}$/.test(s)) {
      return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}:${s.slice(12,14)}`;
    }
    // already like 2025-12-13 23:15:57
    return s;
  }

  function looksLikeCode(s){
    s = (s||"").trim();
    if (!s) return false;
    if (/^\d{8}(\/[A-Z0-9]+)?$/.test(s)) return true; // 세관코드 형태
    if (/^[A-Z0-9]{8,}$/.test(s)) return true; // 신고번호/근거번호 등
    return false;
  }

  function findFirstMatchingText(node, regex){
    if (!node) return "";
    const all = node.getElementsByTagName("*");
    for (const el of all){
      const t = (el.textContent||"").trim();
      if (t && regex.test(t)) return t;
    }
    return "";
  }

  function cleanStage(stage, remark){
    stage = (stage||"").trim();
    remark = (remark||"").trim();

    // 부가사항 문구는 처리단계 칸에 "부가사항"으로만 표시하고 내용은 비고로.
    if (!stage && remark.startsWith("[부가사항]")) return "부가사항";

    // stage에 코드/시간/번호가 들어오면 버림 (절대 단계로 올리지 않음)
    if (/^\d{12,14}$/.test(stage)) return "";
    if (looksLikeCode(stage)) return "";

    // stage가 너무 길고 안내문 성격이면 비고로 보내고 단계는 "부가사항"
    if (stage.startsWith("[부가사항]")) return "부가사항";

    return stage;
  }

  function parseUnipass(xmlDoc, inputNo){
    const root = xmlDoc;

    const tCnt = pick(root, ["tCnt"]);
    const ntceInfo = pick(root, ["ntceInfo"]);

    const vo = root.getElementsByTagName("cargCsclPrgsInfoQryVo")[0] || root;

    const status = pick(vo, ["csclPrgsStts", "prgsStts", "prgsStCd", "csclPrgsSttsNm"]);
    const prcsDttm = fmtDttm(pick(vo, ["prcsDttm", "prcsDt", "dttm"]));
    const prnm = pick(vo, ["prnm", "gdsNm", "prdtNm"]);
    const etprDt = fmtDate8(pick(vo, ["etprDt", "etprDt8", "etprYmd"]));

    // ✅ 고정 태그 (사용자가 알려준 정답)
    const expressNm = anyTagText(root, "frwrEntsConm"); // 특송업체
    const carrierNm = anyTagText(root, "shcoFlco") || anyTagText(root, "shcoFlcoNm"); // 선사/항공사

    // 세관(명/코드) — 이름이 없으면 코드라도 표시
    const customsNm = pick(vo, ["cstmNm", "csclCstmNm", "dclrCstmNm"]);
    let customsCd = pick(vo, ["cstmCd", "csclCstmCd", "dclrCstmCd", "cstm"]);
    if (!/^\d{8}/.test(customsCd)) customsCd = "";

    const dtlsAll = Array.from(root.getElementsByTagName("cargCsclPrgsInfoDtlQryVo"));

    // 세관코드는 dtl에만 오는 경우가 많아서, 최빈값으로 하나 뽑아서 카드에 표시
    const codeCounts = {};
    for (const n of dtlsAll){
      let c = pick(n, ["cstmCd","csclCstmCd","dclrCstmCd","cstm","shedSgn"]);
      if (!/^\d{8}(\/[A-Z0-9]+)?$/.test(c)) c = findFirstMatchingText(n, /^\d{8}(\/[A-Z0-9]+)?$/);
      if (c) codeCounts[c] = (codeCounts[c]||0) + 1;
    }
    if (!customsCd) {
      let best = "";
      let bestCnt = 0;
      for (const k in codeCounts){
        if (codeCounts[k] > bestCnt) { bestCnt = codeCounts[k]; best = k; }
      }
      customsCd = best;
    }

    const customsDisplay = customsNm ? (customsCd ? `${customsNm} (${customsCd})` : customsNm) : (customsCd ? customsCd : "");

    const steps = dtlsAll.map((n, idx) => {
      const remark = pick(n, ["rlbrCn","bfhnGdncCn","ntceInfo"]);
      const rawStage = pick(n, ["prcsStts","prcsSttsNm","cargTrcnRelaBsopTpcdNm","csclPrgsStts","csclPrgsSttsNm"]);
      const stage = cleanStage(rawStage, remark) || "";

      const time = fmtDttm(pick(n, ["prcsDttm","prcsDt","rlbrDttm","dttm"]));

      // 세관코드(04002001 같은거) + 장치장명(지정장치장...) 같이 보여주기
      let cstm = pick(n, ["cstmCd","csclCstmCd","dclrCstmCd","cstm","shedSgn"]);
      if (!/^\d{8}(\/[A-Z0-9]+)?$/.test(cstm)) cstm = findFirstMatchingText(n, /^\d{8}(\/[A-Z0-9]+)?$/);

      const yard = pick(n, ["shedNm","shedSgnNm","shedNm1","shed","placeNm","cstmNm"]);

      // 완전 빈 줄은 버림
      if (!stage && !time && !cstm && !yard && !remark) return null;

      return {
        stage: stage || "-", 
        time: time || "-", 
        cstm: cstm || "-", 
        yard: yard || "", 
        remark: (remark && remark.startsWith("[부가사항]")) ? remark : (remark || "-")
      };
    }).filter(Boolean);

    // 표는 "최근 처리"가 위로 오게(시간이 '-'인 건은 뒤로)
    
    // ✅ 유니패스 표처럼 "처리단계 줄"과 "상세(시간/장치장) 줄"이 따로 내려오는 케이스를 병합
    const merged = [];
    for (const cur of steps){
      const prev = merged[merged.length - 1];

      // 1) 바로 직전이 단계만 있고(time='-'), 현재가 시간/장소가 있는 상세줄이면 → 한 줄로 합치기
      if (prev && prev.time === "-" && cur.time !== "-" && prev.stage !== "-" && cur.stage === "-"){
        cur.stage = prev.stage;

        if ((cur.cstm === "-" || !cur.cstm) && prev.cstm && prev.cstm !== "-") cur.cstm = prev.cstm;
        if ((!cur.yard || cur.yard === "-") && prev.yard) cur.yard = prev.yard;
        if ((cur.remark === "-" || !cur.remark) && prev.remark && prev.remark !== "-") cur.remark = prev.remark;

        merged.pop();
        merged.push(cur);
        continue;
      }

      // 2) 직전이 단계줄이고 현재가 비고만 있는 줄이면(예: 반출입내용) → 비고도 합치기
      if (prev && prev.time === "-" && cur.time !== "-" && prev.stage !== "-" && cur.stage === "-" && cur.remark !== "-"){
        cur.stage = prev.stage;
        if ((cur.cstm === "-" || !cur.cstm) && prev.cstm && prev.cstm !== "-") cur.cstm = prev.cstm;
        merged.pop();
        merged.push(cur);
        continue;
      }

      merged.push(cur);
    }

    const stepsMerged = merged;

return {
      tCnt, ntceInfo,
      hbl: inputNo,
      status, prcsDttm,
      expressNm, carrierNm,
      customs: customsDisplay || "-",
      prnm, etprDt,
      steps: stepsMerged
    };
  }

  function render(d, xmlText, yearUsed){
    const cards = `
      <div class="chips">
        <div class="chip">HBL: <b style="color:var(--text)">${escapeHtml(d.hbl)}</b></div>
        <div class="chip">상태: <b style="color:var(--text)">${escapeHtml(d.status || "-")}</b></div>
        <div class="chip">처리: <b style="color:var(--text)">${escapeHtml(d.prcsDttm || "-")}</b></div>
        <div class="chip">조회연도: <b style="color:var(--text)">${escapeHtml(yearUsed || "-")}</b></div>
      </div>

      <div class="cards">
        <div class="kv"><div class="k">특송업체</div><div class="v">${escapeHtml(d.expressNm || "-")}</div></div>
        <div class="kv"><div class="k">선사/항공사</div><div class="v">${escapeHtml(d.carrierNm || "-")}</div></div>
        <div class="kv"><div class="k">세관</div><div class="v">${escapeHtml(d.customs || "-")}</div></div>

        <div class="kv"><div class="k">품명</div><div class="v">${escapeHtml(d.prnm || "-")}</div></div>
        <div class="kv"><div class="k">입항일</div><div class="v">${escapeHtml(d.etprDt || "-")}</div></div>
        <div class="kv"><div class="k">이력 건수</div><div class="v">${d.steps.length}</div></div>
      </div>
    `;

    const rows = d.steps.map(s => `
      <tr>
        <td class="stage">${escapeHtml(s.stage)}</td>
        <td class="mono">${escapeHtml(s.time)}</td>
        <td>
          <div class="mono" style="font-weight:900">${escapeHtml(s.cstm)}</div>
          ${s.yard ? `<div class="small">${escapeHtml(s.yard)}</div>` : ""}
        </td>
        <td>${escapeHtml(s.remark)}</td>
      </tr>
    `).join("");

    const table = `
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:28%">처리단계</th>
              <th style="width:22%">처리일시</th>
              <th style="width:28%">세관 / 장치장</th>
              <th style="width:22%">반출입(처리)내용</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="4" class="muted">이력 없음</td></tr>`}</tbody>
        </table>
      </div>
      <div class="hint" style="margin-top:10px">
        • 처리단계는 <b>신고번호/코드/시간</b> 같은 값은 절대 올리지 않게 차단해놨음.<br/>
        • 만약 특정 행에서 처리단계가 계속 <b>-</b>로 나오면, 그 케이스는 XML에서 처리단계 태그가 다른 이름으로 오는 거라서 태그명만 추가하면 100% 맞출 수 있음.
      </div>
    `;

    const raw = `
      <div class="raw">
        <div class="rawHead">
          <b>원문(XML)</b>
          <button id="toggleRaw" type="button">접기/펼치기</button>
        </div>
        <pre id="rawPre">${escapeHtml(xmlText)}</pre>
      </div>
    `;

    $("result").innerHTML = cards + table + raw;

    $("toggleRaw").addEventListener("click", () => {
      const pre = $("rawPre");
      pre.style.display = (pre.style.display === "none") ? "block" : "none";
    });
  }

  async function callAPI(hbl, blYy){
    const qs = new URLSearchParams({ type: "hbl", no: hbl, blYy });
    // 1) 기존에 쓰던 함수 먼저
    let r = await fetch(`/.netlify/functions/unipass?${qs.toString()}`);
    if (r.status === 404) {
      // 2) 혹시 /api 라우팅 쓰는 프로젝트면 여기로 재시도
      r = await fetch(`/api/unipass?${qs.toString()}`);
    }
    const text = await r.text();
    if (!r.ok) throw new Error(text || `HTTP ${r.status}`);
    return text;
  }

  $("btn").addEventListener("click", async () => {
    const hbl = ($("hbl").value||"").trim();
    $("result").innerHTML = "";

    if (!hbl){
      setState("bad","번호를 입력해줘");
      $("result").innerHTML = `<div class="error">운송장번호(HBL)가 비었음</div>`;
      return;
    }

    $("btn").disabled = true;
    $("btn").textContent = "조회중…";
    setState("", "조회 중");

    const now = new Date();
    const y = now.getFullYear();
    const yearsToTry = [y, y-1, y-2, y-3, y-4];

    try{
      let lastXml = "";
      let lastParsed = null;
      let usedYear = "";

      for (const yr of yearsToTry){
        const xmlText = await callAPI(hbl, String(yr));
        lastXml = xmlText;
        const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
        const d = parseUnipass(xmlDoc, hbl);
        lastParsed = d;

        if (d.ntceInfo){
          // 안내/에러면 바로 표시(연도 바꿔도 의미 없는 경우가 많음)
          usedYear = String(yr);
          setState("bad", "안내/에러");
          $("last").textContent = "마지막 조회: " + nowKST();
          $("result").innerHTML = `<div class="error">${escapeHtml(d.ntceInfo)}</div>`;
          return;
        }

        if (d.tCnt && d.tCnt !== "0"){
          usedYear = String(yr);
          setState("ok","조회 성공");
          $("last").textContent = "마지막 조회: " + nowKST();
          render(d, xmlText, usedYear);
          return;
        }
      }

      // 여기까지 왔으면 전부 0건
      setState("bad","결과 없음");
      $("last").textContent = "마지막 조회: " + nowKST();
      $("result").innerHTML = `<div class="error">조회 결과가 0건이야. (연도 자동시도: ${yearsToTry.join(", ")})<br/>HBL이 맞는지/번호 오타 없는지 확인 ㄱㄱ</div>` +
        `<div class="raw" style="margin-top:12px"><div class="rawHead"><b>마지막 응답(XML)</b><button id="toggleRaw" type="button">접기/펼치기</button></div><pre id="rawPre">${escapeHtml(lastXml)}</pre></div>`;
      const btn = document.getElementById("toggleRaw");
      if (btn) btn.addEventListener("click", () => {
        const pre = document.getElementById("rawPre");
        pre.style.display = (pre.style.display === "none") ? "block" : "none";
      });

    } catch(e){
      setState("bad","조회 실패");
      $("result").innerHTML = `<div class="error">에러: ${escapeHtml(String(e.message||e))}</div>`;
    } finally {
      $("btn").disabled = false;
      $("btn").textContent = "조회";
    }
  });
</script>
</body>
</html>

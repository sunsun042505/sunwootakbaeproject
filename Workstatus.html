<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>작업현황 (허브)</title>
  <style>
:root{
  --bg1:#0b1220; --bg2:#0f1b2e; --card:#111a2b; --card2:#0f1828;
  --text:#e9eefc; --muted:#a7b2d6; --line:rgba(255,255,255,.10);
  --brand:#7aa7ff; --good:#34d399; --warn:#fbbf24; --bad:#fb7185; --info:#60a5fa;
  --shadow: 0 18px 50px rgba(0,0,0,.35);
  --r:18px;
  font-synthesis-weight:none;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial;
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(122,167,255,.25), transparent 60%),
    radial-gradient(1000px 800px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}
a{color:inherit}
.wrap{max-width:1100px; margin:0 auto; padding:18px}
.topbar{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:14px 16px; border:1px solid var(--line);
  background:rgba(17,26,43,.68); backdrop-filter: blur(10px);
  border-radius: var(--r);
  box-shadow: var(--shadow);
}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
.pill{
  font-size:12px; color:var(--muted);
  padding:6px 10px; border:1px solid var(--line); border-radius:999px;
  background:rgba(255,255,255,.03);
}
.row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
  user-select:none;
  font-weight:700;
}
.btn:hover{background:rgba(255,255,255,.07)}
.btn.primary{border-color:rgba(122,167,255,.45); background:rgba(122,167,255,.14)}
.btn.good{border-color:rgba(52,211,153,.45); background:rgba(52,211,153,.14)}
.btn.warn{border-color:rgba(251,191,36,.45); background:rgba(251,191,36,.12)}
.btn.bad{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.12)}
.btn:disabled{opacity:.45; cursor:not-allowed}
.grid{display:grid; gap:12px; margin-top:14px}
@media(min-width: 920px){ .grid.two{grid-template-columns: 1.1fr .9fr;} }
.card{
  border:1px solid var(--line);
  background:rgba(17,26,43,.58);
  backdrop-filter: blur(10px);
  border-radius: var(--r);
  box-shadow: var(--shadow);
  padding:14px;
}
.h{margin:0 0 10px; font-size:16px}
.small{font-size:12px; color:var(--muted)}
.input, select{
  width:100%;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  color:var(--text);
  padding:11px 12px;
  border-radius:12px;
  outline:none;
}
label{font-size:12px; color:var(--muted); display:block; margin:10px 0 6px}
.sep{height:1px; background:var(--line); margin:12px 0}
.kpis{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
@media(min-width: 720px){ .kpis{grid-template-columns: repeat(4, 1fr);} }
.kpi{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background:rgba(0,0,0,.16);
}
.kpi .t{font-size:12px; color:var(--muted)}
.kpi .v{font-size:20px; font-weight:900; margin-top:6px}
.table{width:100%; border-collapse: collapse; font-size:13px}
.table th,.table td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top}
.badge{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03)}
.dot{width:9px; height:9px; border-radius:999px; background:var(--info)}
.dot.ok{background:var(--good)}
.dot.stop{background:var(--bad)}
.dot.broken{background:var(--warn)}
.banner{
  display:none;
  margin-top:12px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  font-weight:700;
}
.banner.show{display:block}
.banner.good{border-color:rgba(52,211,153,.45)}
.banner.warn{border-color:rgba(251,191,36,.45)}
.banner.bad{border-color:rgba(251,113,133,.45)}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div style="width:10px;height:10px;border-radius:999px;background:var(--brand)"></div>
      <div>작업현황 (허브)</div>
      <span class="pill">v1.1.3</span>
    </div>
    <div class="row">
      <span id="clock" class="pill">--</span>
      <span id="apiState" class="pill">API: 확인중…</span>
      <button id="btnHome" class="btn" type="button">메인</button>
      <button id="btnRefresh" class="btn primary" type="button">새로고침</button>
    </div>
  </div>

  <div id="banner" class="banner"></div>

  <div class="card" style="margin-top:14px">
    <h3 class="h">오늘 처리량</h3>
    <div class="kpis">
      <div class="kpi"><div class="t">입고(간선하차)</div><div id="kpiIn" class="v">0</div></div>
      <div class="kpi"><div class="t">출고(간선상차)</div><div id="kpiOut" class="v">0</div></div>
      <div class="kpi"><div class="t">분류완료</div><div id="kpiSort" class="v">0</div></div>
      <div class="kpi"><div class="t">반송접수</div><div id="kpiRet" class="v">0</div></div>
    </div>
    <div class="sep"></div>
    <div class="small">기준: KST(오늘 00:00~현재) / “레일” 포함 허브 이벤트만 집계</div>
  </div>

  <div class="grid two" style="margin-top:14px">
    <div class="card">
      <h3 class="h">허브 체류 물량</h3>
      <div class="small">마지막 이벤트가 허브의 “간선하차/분류완료/반송접수”인 물량</div>
      <div class="sep"></div>
      <div class="row" style="justify-content:space-between">
        <span class="pill">체류: <b id="invCount">0</b>건</span>
      </div>
      <div style="overflow:auto; margin-top:10px">
        <table class="table">
          <thead><tr><th>허브</th><th>레일</th><th>마지막 상태</th><th>시간</th></tr></thead>
          <tbody id="invTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 class="h">레일 작동 현황</h3>
      <div class="small">정상=초록 / 미작동=빨강 / 고장=노랑</div>
      <div class="sep"></div>
      <div id="railsSummary"></div>
    </div>
  </div>

  <div class="grid two" style="margin-top:14px">
    <div class="card">
      <h3 class="h">레일별 처리량 (허브터미널)</h3>
      <div style="overflow:auto; margin-top:10px">
        <table class="table">
          <thead><tr><th>레일</th><th>입고</th><th>출고</th><th>분류</th><th>반송</th></tr></thead>
          <tbody id="railTerminalTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 class="h">레일별 처리량 (허브센터)</h3>
      <div style="overflow:auto; margin-top:10px">
        <table class="table">
          <thead><tr><th>레일</th><th>입고</th><th>출고</th><th>분류</th><th>반송</th></tr></thead>
          <tbody id="railCenterTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h3 class="h">레일 상태 의미</h3>
    <div class="row" style="gap:10px; flex-wrap:wrap">
      <span class="badge"><span class="dot ok"></span>정상작동</span>
      <span class="badge"><span class="dot stop"></span>미작동</span>
      <span class="badge"><span class="dot broken"></span>고장</span>
    </div>
  </div>
</div>

<script>

const API_BASE = "/api";
const STORAGE_KEYS = {
  RES: "DELIVERY_RESERVATIONS_V1",
  STORES: "DELIVERY_STORES_V1",
  COURIERS: "DELIVERY_COURIERS_V1",
  TERMINALS: "DELIVERY_TERMINALS_V1",
  CENTERS: "DELIVERY_CENTERS_V1",
  AIRLINES: "DELIVERY_AIRLINES_V1",
};

const $ = (id) => document.getElementById(id);

function kstNow(){
  const d = new Date();
  const utc = d.getTime() + (d.getTimezoneOffset()*60000);
  return new Date(utc + 9*3600000);
}
function fmtKst(dt){
  const d = (dt instanceof Date) ? dt : new Date(dt);
  const k = new Date(d.getTime() + (d.getTimezoneOffset()*60000) + 9*3600000);
  const yy = k.getFullYear();
  const mm = String(k.getMonth()+1).padStart(2,"0");
  const dd = String(k.getDate()).padStart(2,"0");
  const hh = String(k.getHours()).padStart(2,"0");
  const mi = String(k.getMinutes()).padStart(2,"0");
  const ss = String(k.getSeconds()).padStart(2,"0");
  return `${yy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}
function setClock(){
  const el = $("clock");
  if(!el) return;
  el.textContent = fmtKst(new Date()) + " (KST)";
}
setInterval(setClock, 1000); setClock();

function banner(kind, msg){
  const b = $("banner");
  if(!b) return;
  b.className = `banner show ${kind||""}`;
  b.textContent = msg || "";
}

async function apiPing(){
  try{
    const res = await fetch(`${API_BASE}/ping`, { cache:"no-store" });
    return res.ok;
  }catch(e){ return false; }
}

const mem = {};
let useLocalFallback = false;

async function apiGet(key, fallback){
  if(useLocalFallback){
    try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch{ return fallback; }
  }
  if(key in mem) return mem[key];
  const ok = await apiPing();
  if(!ok) throw new Error("API_OFFLINE");
  const res = await fetch(`${API_BASE}/kv/get?key=${encodeURIComponent(key)}`, { cache:"no-store" });
  if(!res.ok) throw new Error("GET_FAILED");
  const json = await res.json();
  mem[key] = (json.value ?? fallback);
  return mem[key];
}

async function apiSet(key, value){
  if(useLocalFallback){
    localStorage.setItem(key, JSON.stringify(value));
    mem[key] = value;
    return;
  }
  const ok = await apiPing();
  if(!ok) throw new Error("API_OFFLINE");
  const res = await fetch(`${API_BASE}/kv/set`, {
    method:"POST",
    headers:{ "Content-Type":"application/json; charset=utf-8" },
    body: JSON.stringify({ key, value })
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error("SET_FAILED: " + t);
  }
  mem[key] = value;
}

async function getReservations(){ return await apiGet(STORAGE_KEYS.RES, []); }
async function setReservations(arr){ await apiSet(STORAGE_KEYS.RES, arr); }

async function upsertRes(rec){
  const arr = await getReservations();
  const i = arr.findIndex(x => x.reserveNo === rec.reserveNo);
  if(i >= 0) arr[i] = rec; else arr.unshift(rec);
  await setReservations(arr);
  return rec;
}

function findByWaybillLocal(arr, waybill){
  const wb = String(waybill||"").trim();
  return arr.find(x => String(x.waybillNo||"") === wb) || null;
}

function ensureEvents(rec){
  if(!rec.events || !Array.isArray(rec.events)) rec.events = [];
  return rec.events;
}

function addEvent(rec, place, message){
  ensureEvents(rec).push({ time: new Date().toISOString(), place, message });
  rec.updatedAt = fmtKst(new Date());
}

function railFromText(s){
  const m = String(s||"").match(/(\d)\s*번\s*레일/);
  return m ? Number(m[1]) : null;
}


function setApiState(ok){
  const el = $("apiState");
  el.textContent = ok ? "API: OK" : "API: OFFLINE";
}

function isTodayKst(iso){
  const t = new Date(iso);
  const k = new Date(t.getTime() + (t.getTimezoneOffset()*60000) + 9*3600000);
  const now = kstNow();
  return k.getFullYear()===now.getFullYear() && k.getMonth()===now.getMonth() && k.getDate()===now.getDate();
}

function parseHubEvent(ev){
  const place = String(ev.place||"");
  const msg = String(ev.message||"");
  const hub = place.includes("허브터미널") ? "terminal" : (place.includes("허브센터") ? "center" : null);
  if(!hub) return null;
  const rail = railFromText(msg);
  const type =
    msg.includes("간선하차") ? "in" :
    msg.includes("간선상차") ? "out" :
    msg.includes("분류완료") ? "sort" :
    (msg.includes("반송접수") || msg.includes("반송")) ? "ret" :
    null;
  return { hub, rail, type };
}

function railDotClass(s){
  if(s==="OK") return "ok";
  if(s==="STOP") return "stop";
  if(s==="BROKEN") return "broken";
  return "";
}

async function load(){
  const ok = await apiPing();
  setApiState(ok);
  if(!ok){
    banner("bad","API가 꺼져있어. (/api/ping 실패)");
    return;
  }

  const res = await getReservations();
  const termRails = await apiGet("HUB_RAIL_STATUS_TERMINAL_V1", {1:"OK",2:"OK",3:"OK",4:"OK",5:"OK"});
  const centRails = await apiGet("HUB_RAIL_STATUS_CENTER_V1", {1:"OK",2:"OK",3:"OK",4:"OK",5:"OK"});

  let inCnt=0,outCnt=0,sortCnt=0,retCnt=0;

  const per = {
    terminal: {1:{in:0,out:0,sort:0,ret:0},2:{in:0,out:0,sort:0,ret:0},3:{in:0,out:0,sort:0,ret:0},4:{in:0,out:0,sort:0,ret:0},5:{in:0,out:0,sort:0,ret:0}},
    center:   {1:{in:0,out:0,sort:0,ret:0},2:{in:0,out:0,sort:0,ret:0},3:{in:0,out:0,sort:0,ret:0},4:{in:0,out:0,sort:0,ret:0},5:{in:0,out:0,sort:0,ret:0}},
  };

  const inv = [];

  for(const rec of (res||[])){
    const evs = Array.isArray(rec.events) ? rec.events : [];
    for(const ev of evs){
      if(!ev?.time) continue;
      if(!isTodayKst(ev.time)) continue;
      const pe = parseHubEvent(ev);
      if(!pe || !pe.rail || !pe.type) continue;
      per[pe.hub][pe.rail][pe.type] += 1;
      if(pe.type==="in") inCnt++;
      if(pe.type==="out") outCnt++;
      if(pe.type==="sort") sortCnt++;
      if(pe.type==="ret") retCnt++;
    }
    if(evs.length){
      const last = evs[evs.length-1];
      const pe = parseHubEvent(last);
      if(pe && ["in","sort","ret"].includes(pe.type||"")){
        inv.push({
hub: pe.hub==="terminal" ? "허브터미널" : "허브센터",
          rail: pe.rail || "-",
          msg: last.message || "-",
          time: last.time
        });
      }
    }
  }

  $("kpiIn").textContent = String(inCnt);
  $("kpiOut").textContent = String(outCnt);
  $("kpiSort").textContent = String(sortCnt);
  $("kpiRet").textContent = String(retCnt);

  $("invCount").textContent = String(inv.length);
  const invBody = $("invTbody");
  invBody.innerHTML = inv.length ? inv.map(x=>`
    <tr>
<td>${x.hub}</td>
      <td>${x.rail}</td>
      <td>${x.msg}</td>
      <td>${fmtKst(x.time)}</td>
    </tr>
  `).join("") : `<tr><td colspan="4" class="small">체류 물량 없음</td></tr>`;

  const rs = $("railsSummary");
  rs.innerHTML = `
    <div class="card" style="background:rgba(0,0,0,.12)">
      <div class="h" style="margin:0 0 8px">허브터미널</div>
      ${[1,2,3,4,5].map(i=>`<div class="row" style="justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--line)">
        <span class="badge"><span class="dot ${railDotClass(termRails[i])}"></span>${i}번 레일</span>
        <span class="small">${termRails[i]==="OK"?"정상작동":(termRails[i]==="STOP"?"미작동":"고장")}</span>
      </div>`).join("")}
    </div>
    <div style="height:10px"></div>
    <div class="card" style="background:rgba(0,0,0,.12)">
      <div class="h" style="margin:0 0 8px">허브센터</div>
      ${[1,2,3,4,5].map(i=>`<div class="row" style="justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--line)">
        <span class="badge"><span class="dot ${railDotClass(centRails[i])}"></span>${i}번 레일</span>
        <span class="small">${centRails[i]==="OK"?"정상작동":(centRails[i]==="STOP"?"미작동":"고장")}</span>
      </div>`).join("")}
    </div>
  `;

  function railRows(hub){
    return [1,2,3,4,5].map(i=>{
      const r = per[hub][i];
      return `<tr><td>${i}</td><td>${r.in}</td><td>${r.out}</td><td>${r.sort}</td><td>${r.ret}</td></tr>`;
    }).join("");
  }
  $("railTerminalTbody").innerHTML = railRows("terminal");
  $("railCenterTbody").innerHTML = railRows("center");

  banner("good", `현황 업데이트 완료. (데이터 ${res.length}건)`);
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("btnHome").addEventListener("click", ()=> location.href="index.html");
  $("btnRefresh").addEventListener("click", load);
  load();
});
</script>
</body>
</html>
